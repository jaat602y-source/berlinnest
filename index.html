<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<title>BerlinNest</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<style>
:root {
  --primary: #1B4332;
  --primary-mid: #2D6A4F;
  --primary-light: #52B788;
  --accent: #D4A574;
  --accent-dark: #B07D45;
  --bg: #F8F6F1;
  --card: #FFFFFF;
  --text: #1A1A1A;
  --text-mid: #444;
  --text-light: #888;
  --border: #E8E4DC;
  --star: #F4A261;
  --danger: #C1121F;
  --warn: #E9C46A;
  --success: #2D6A4F;
  --shadow: 0 2px 20px rgba(27,67,50,0.08);
  --shadow-lg: 0 8px 40px rgba(27,67,50,0.15);
  --radius: 16px;
  --nav-h: 64px;
  --bottom-h: 72px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:var(--bottom-h);}
h1,h2,h3,.serif{font-family:'DM Serif Display',serif;}
img{max-width:100%;display:block;}
button{font-family:'DM Sans',sans-serif;cursor:pointer;border:none;outline:none;}
input,textarea,select{font-family:'DM Sans',sans-serif;outline:none;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

/* ═══ TOP NAV ═══ */
.topnav{
  position:sticky;top:0;z-index:900;
  background:rgba(248,246,241,0.95);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  height:var(--nav-h);
  display:flex;align-items:center;
  padding:0 1.25rem;gap:1rem;
}
.logo{font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--primary);cursor:pointer;flex-shrink:0;display:flex;align-items:center;gap:0.3rem;}
.logo span{color:var(--accent);}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;}
.topnav-right{margin-left:auto;display:flex;align-items:center;gap:0.75rem;flex-wrap:nowrap;}
.lang-toggle{padding:0.3rem 0.65rem;border:1.5px solid var(--border);border-radius:20px;background:var(--card);font-size:0.82rem;font-weight:600;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:0.25rem;transition:all .2s;flex-shrink:0;white-space:nowrap;}
.lang-toggle:hover{border-color:var(--primary);background:rgba(27,67,50,0.06);}
.btn-msgs-icon{width:36px;height:36px;border-radius:50%;background:var(--bg);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.15rem;cursor:pointer;flex-shrink:0;transition:all .2s;position:relative;}
.btn-msgs-icon:hover{border-color:var(--primary);background:rgba(27,67,50,0.06);}
.msgs-unread-dot{width:8px;height:8px;border-radius:50%;background:var(--danger);position:absolute;top:1px;right:1px;border:2px solid var(--bg);display:none;}
.btn-post{display:none;}
@media(min-width:768px){.btn-post{display:flex;}}
.topnav-avatar{width:36px;height:36px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;cursor:pointer;overflow:hidden;border:2px solid var(--border);transition:border-color .2s;flex-shrink:0;}
.topnav-avatar:hover{border-color:var(--primary);}
.topnav-avatar img{width:100%;height:100%;object-fit:cover;}
.notif-dot{width:8px;height:8px;border-radius:50%;background:var(--danger);position:absolute;top:0;right:0;border:2px solid var(--bg);}
.topnav-avatar-wrap{position:relative;display:inline-block;}
.btn-post{padding:0.5rem 1rem;border-radius:20px;background:var(--primary);color:#fff;font-weight:600;font-size:0.85rem;display:flex;align-items:center;gap:0.4rem;transition:all .2s;flex-shrink:0;}
.btn-post:hover{background:var(--primary-mid);transform:translateY(-1px);}
.btn-sign{padding:0.5rem 1rem;border-radius:20px;background:transparent;color:var(--primary);border:1.5px solid var(--primary);font-weight:600;font-size:0.85rem;transition:all .2s;flex-shrink:0;}
.btn-sign:hover{background:var(--primary);color:#fff;}
.admin-chip{background:var(--danger);color:#fff;padding:0.2rem 0.6rem;border-radius:10px;font-size:0.7rem;font-weight:700;letter-spacing:.5px;flex-shrink:0;}

/* ═══ BOTTOM NAV ═══ */
.bottomnav{position:fixed;bottom:0;left:0;right:0;z-index:900;height:var(--bottom-h);background:rgba(255,255,255,0.98);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid rgba(232,228,220,0.8);display:flex;align-items:center;justify-content:space-around;padding:0 1rem;padding-bottom:env(safe-area-inset-bottom);box-shadow:0 -4px 24px rgba(27,67,50,0.06);}
.bnav-item{display:flex;flex-direction:column;align-items:center;gap:0.25rem;cursor:pointer;border-radius:14px;transition:all .22s cubic-bezier(.34,1.56,.64,1);flex:1;max-width:90px;background:transparent;border:none;color:var(--text-light);padding:0.4rem 0.5rem;-webkit-tap-highlight-color:transparent;}
.bnav-item.active{color:var(--primary);}
.bnav-icon{font-size:1.4rem;line-height:1;transition:transform .22s cubic-bezier(.34,1.56,.64,1);}
.bnav-item.active .bnav-icon{transform:scale(1.15);}
.bnav-label{font-size:0.6rem;font-weight:700;letter-spacing:.4px;text-transform:uppercase;white-space:nowrap;opacity:.7;transition:opacity .2s;}
.bnav-item.active .bnav-label{opacity:1;}
.bnav-pip{width:18px;height:3px;border-radius:2px;background:var(--primary);margin-top:1px;transform:scaleX(0);transition:transform .22s cubic-bezier(.34,1.56,.64,1);}
.bnav-item.active .bnav-pip{transform:scaleX(1);}
.bnav-post-wrap{flex:0 0 auto;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;top:-8px;}
.bnav-post-btn{width:58px;height:58px;border-radius:18px;background:linear-gradient(145deg,var(--primary-mid),var(--primary));color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(27,67,50,0.4),0 2px 6px rgba(27,67,50,0.2);transition:all .22s cubic-bezier(.34,1.56,.64,1);-webkit-tap-highlight-color:transparent;position:relative;overflow:hidden;}
.bnav-post-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(145deg,rgba(255,255,255,0.18),transparent);border-radius:inherit;}
.bnav-post-btn:hover{transform:translateY(-3px) scale(1.06);box-shadow:0 10px 28px rgba(27,67,50,0.45),0 4px 10px rgba(27,67,50,0.25);}
.bnav-post-btn:active{transform:translateY(-1px) scale(0.97);}
.bnav-post-icon{font-size:1.8rem;line-height:1;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transition:transform .22s cubic-bezier(.34,1.56,.64,1);}
.bnav-post-btn:hover .bnav-post-icon{transform:translate(-50%,-50%) rotate(90deg);}
.bnav-post-label{font-size:0.6rem;font-weight:700;letter-spacing:.4px;text-transform:uppercase;color:var(--text-light);margin-top:0.35rem;opacity:.7;}

/* ═══ PAGES ═══ */
.page{display:none;min-height:calc(100vh - var(--nav-h) - var(--bottom-h));}
.page.active{display:block;}

/* ═══ HERO ═══ */
.hero{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-mid) 60%,#3A8B6A 100%);padding:2.5rem 1.25rem 3rem;position:relative;overflow:hidden;}
.hero::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;border-radius:50%;background:rgba(255,255,255,0.05);}
.hero::after{content:'';position:absolute;bottom:-60px;left:-20px;width:160px;height:160px;border-radius:50%;background:rgba(212,165,116,0.15);}
.hero h1{color:#fff;font-size:clamp(1.6rem,5vw,2.4rem);line-height:1.2;margin-bottom:0.5rem;}
.hero p{color:rgba(255,255,255,0.75);font-size:0.95rem;margin-bottom:1.5rem;}
.search-wrap{background:#fff;border-radius:14px;display:flex;align-items:center;padding:0.4rem 0.4rem 0.4rem 1rem;box-shadow:0 4px 20px rgba(0,0,0,0.15);gap:0.5rem;}
.search-wrap input{flex:1;border:none;font-size:0.95rem;background:transparent;color:var(--text);}
.search-wrap input::placeholder{color:var(--text-light);}
.search-btn{padding:0.6rem 1.2rem;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;font-size:0.9rem;transition:all .2s;flex-shrink:0;}
.search-btn:hover{background:var(--primary-mid);}
.hero-stats{display:flex;gap:1.5rem;margin-top:1.5rem;}
.hero-stat{color:rgba(255,255,255,0.85);}
.hero-stat strong{display:block;font-size:1.3rem;color:#fff;}
.hero-stat span{font-size:0.75rem;opacity:.7;}

/* ═══ SECTION ═══ */
.section{padding:1.5rem 1.25rem;}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;}
.section-head h2{font-size:1.3rem;color:var(--primary);}
.see-all{font-size:0.85rem;color:var(--primary-mid);font-weight:600;cursor:pointer;}

/* ═══ FILTER BUTTONS ═══ */
.filter-selects{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-bottom:1rem;}
.fsel-btn{
  display:flex;align-items:center;justify-content:space-between;
  padding:0.62rem 0.75rem;
  border:1.5px solid var(--border);border-radius:10px;
  background:var(--card);font-size:0.82rem;color:var(--text);
  font-weight:500;cursor:pointer;transition:all .2s;
  gap:0.3rem;min-width:0;
}
.fsel-btn:hover{border-color:var(--primary);background:rgba(27,67,50,0.04);}
.fsel-btn.active{border-color:var(--primary);background:var(--primary);color:#fff;}
.fsel-btn.active svg path{fill:#fff;}
.fsel-label{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.fsel-btn svg{flex-shrink:0;opacity:.5;}
.fsel-btn.active svg{opacity:1;}

/* ═══ FILTER MODALS ═══ */
.fmodal .modal-box{padding:0;border-radius:var(--radius) var(--radius) 0 0;max-height:80vh;display:flex;flex-direction:column;}
@media(min-width:600px){.fmodal .modal-box{border-radius:var(--radius);max-height:70vh;}}
.fmodal-box{overflow:hidden;}
.fmodal-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:1.1rem 1.25rem 1rem;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.fmodal-title{font-family:'DM Serif Display',serif;font-size:1.15rem;color:var(--primary);}
.fmodal-search-wrap{padding:0.75rem 1.25rem 0.5rem;flex-shrink:0;}
.fmodal-search{
  width:100%;padding:0.55rem 0.9rem;
  border:1.5px solid var(--border);border-radius:10px;
  background:var(--bg);font-size:0.9rem;color:var(--text);
}
.fmodal-search:focus{border-color:var(--primary-light);outline:none;}
.fmodal-list{
  flex:1;overflow-y:auto;
  padding:0.4rem 0.75rem;
}
.fopt{
  display:flex;align-items:center;gap:0.75rem;
  padding:0.75rem 0.5rem;
  border-radius:10px;cursor:pointer;
  transition:background .15s;
  border-bottom:1px solid rgba(232,228,220,0.5);
}
.fopt:last-child{border-bottom:none;}
.fopt:hover{background:rgba(27,67,50,0.04);}
.fopt.selected{background:rgba(27,67,50,0.08);}
.fopt-radio{
  width:20px;height:20px;border-radius:50%;
  border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:all .2s;
}
.fopt.selected .fopt-radio{border-color:var(--primary);background:var(--primary);}
.fopt.selected .fopt-radio::after{content:'';width:8px;height:8px;border-radius:50%;background:#fff;}
.fopt-text{flex:1;}
.fopt-label{font-size:0.92rem;font-weight:500;color:var(--text);}
.fopt-sub{font-size:0.75rem;color:var(--text-light);margin-top:1px;}
.fopt-count{font-size:0.75rem;color:var(--text-light);background:var(--bg);padding:2px 8px;border-radius:20px;flex-shrink:0;}
.fmodal-foot{
  display:flex;gap:0.75rem;
  padding:0.9rem 1.25rem;
  border-top:1px solid var(--border);
  flex-shrink:0;
  background:var(--card);
}
.fmodal-clear{
  flex:1;padding:0.65rem;border-radius:10px;
  background:var(--bg);border:1.5px solid var(--border);
  color:var(--text-mid);font-weight:600;font-size:0.88rem;cursor:pointer;
  transition:all .2s;
}
.fmodal-clear:hover{border-color:var(--danger);color:var(--danger);}
.fmodal-apply{
  flex:2;padding:0.65rem;border-radius:10px;
  background:var(--primary);color:#fff;border:none;
  font-weight:600;font-size:0.88rem;cursor:pointer;
  transition:all .2s;
}
.fmodal-apply:hover{background:var(--primary-mid);}


/* ═══ POST CARD ═══ */
.posts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(min(100%,340px),1fr));gap:1.25rem;}
.feed-counter{text-align:center;font-size:0.82rem;color:var(--text-light);padding:1.5rem 0;grid-column:1/-1;}
.pcard{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:transform .25s,box-shadow .25s;position:relative;}
.pcard:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);}
.pcard-images{position:relative;height:220px;background:linear-gradient(135deg,var(--primary-mid),var(--accent));overflow:hidden;}
.img-track{display:flex;height:100%;transition:transform .35s cubic-bezier(.4,0,.2,1);}
.img-track img{width:100%;height:100%;object-fit:cover;flex-shrink:0;}
.pcard-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:3.5rem;}
.rec-badge{position:absolute;top:0.75rem;left:0.75rem;background:var(--accent);color:#fff;padding:0.3rem 0.65rem;border-radius:20px;font-size:0.72rem;font-weight:700;letter-spacing:.3px;box-shadow:0 2px 8px rgba(0,0,0,0.2);}
.type-badge{position:absolute;top:0.75rem;right:0.75rem;background:rgba(255,255,255,0.92);backdrop-filter:blur(8px);color:var(--primary);padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:700;}
.views-badge{position:absolute;bottom:0.75rem;right:0.75rem;background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);color:#fff;padding:0.25rem 0.65rem;border-radius:20px;font-size:0.75rem;display:flex;align-items:center;gap:0.3rem;}
.img-counter{position:absolute;top:0.75rem;left:0.75rem;background:rgba(0,0,0,0.55);color:#fff;font-size:0.72rem;font-weight:600;border-radius:20px;padding:3px 9px;backdrop-filter:blur(6px);}
.img-dots{position:absolute;bottom:0.75rem;left:50%;transform:translateX(-50%);display:flex;gap:4px;}
.img-dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,0.5);cursor:pointer;transition:all .2s;}
.img-dot.active{background:#fff;width:14px;border-radius:3px;}
.img-arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.9);border:none;border-radius:50%;width:32px;height:32px;font-size:1.2rem;color:var(--text);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.2);}
.img-arrow.prev{left:8px;}
.img-arrow.next{right:8px;}
.img-arrow.hidden{display:none;}
.pcard-body{padding:1rem 1.1rem 1.1rem;}
.pcard-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;}
.pcard-title{font-size:1.05rem;font-weight:700;color:var(--primary);line-height:1.3;flex:1;margin-right:0.5rem;cursor:pointer;}
.pcard-title:hover{text-decoration:underline;}
.pcard-rating{display:flex;align-items:center;gap:0.25rem;font-size:0.82rem;font-weight:600;color:var(--star);flex-shrink:0;}
.pcard-author{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;}
.author-ava{width:28px;height:28px;border-radius:50%;background:var(--primary-mid);color:#fff;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;cursor:pointer;overflow:hidden;flex-shrink:0;border:1.5px solid var(--border);}
.author-ava img{width:100%;height:100%;object-fit:cover;}
.author-name{font-size:0.82rem;font-weight:600;color:var(--primary-mid);cursor:pointer;}
.author-name:hover{text-decoration:underline;}
.author-location{font-size:0.78rem;color:var(--text-light);margin-left:auto;}
.pcard-details{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;margin-bottom:0.75rem;}
.detail-chip{background:var(--bg);border-radius:8px;padding:0.4rem 0.5rem;text-align:center;}
.detail-chip .dval{font-size:0.9rem;font-weight:700;color:var(--primary);}
.detail-chip .dlbl{font-size:0.65rem;color:var(--text-light);text-transform:uppercase;letter-spacing:.3px;}
.price-row{display:flex;align-items:baseline;gap:0.5rem;margin-bottom:0.75rem;}
.price-main{font-size:1.3rem;font-weight:700;color:var(--primary);}
.price-warm{font-size:0.8rem;color:var(--text-light);}
.price-deposit{font-size:0.8rem;color:var(--text-mid);margin-left:auto;}
.tags-row{display:flex;flex-wrap:wrap;gap:0.35rem;margin-bottom:0.85rem;}
.tag{background:rgba(27,67,50,0.07);color:var(--primary-mid);padding:0.25rem 0.6rem;border-radius:8px;font-size:0.75rem;font-weight:500;}
.pcard-desc{font-size:0.85rem;color:var(--text-mid);line-height:1.55;margin-bottom:0.9rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.pcard-actions{display:flex;gap:0.5rem;align-items:center;}
.btn-contact{flex:1;padding:0.6rem;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;font-size:0.85rem;transition:all .2s;text-align:center;border:none;}
.btn-contact:hover{background:var(--primary-mid);}
.btn-details{flex:1;padding:0.6rem;border-radius:10px;background:transparent;color:var(--primary);border:1.5px solid var(--primary);font-weight:600;font-size:0.85rem;transition:all .2s;text-align:center;}
.btn-details:hover{background:var(--primary);color:#fff;}
.btn-edit-post{padding:0.6rem 0.9rem;border-radius:10px;background:var(--warn);color:var(--text);font-weight:600;font-size:0.85rem;transition:all .2s;display:flex;align-items:center;gap:0.3rem;border:none;}
.btn-report-subtle{padding:0.5rem;border-radius:8px;background:transparent;color:var(--text-light);font-size:0.8rem;transition:all .2s;border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;gap:0.2rem;}
.btn-report-subtle:hover{color:var(--danger);border-color:var(--danger);}
.admin-actions{display:flex;gap:0.4rem;margin-top:0.6rem;padding-top:0.6rem;border-top:2px dashed rgba(193,18,31,0.3);}
.btn-admin{flex:1;padding:0.5rem;border-radius:8px;font-weight:600;font-size:0.78rem;transition:all .2s;}
.btn-admin.edit{background:var(--warn);color:var(--text);}
.btn-admin.del{background:var(--danger);color:#fff;}

/* skeleton */
.sk-card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);animation:pulse 1.5s infinite;}
.sk-img{height:220px;background:linear-gradient(135deg,#e8e4dc,#d4cfc5);}
.sk-body{padding:1rem;}
.sk-line{height:12px;background:#e8e4dc;border-radius:6px;margin-bottom:10px;}
.sk-line.w80{width:80%;}
.sk-line.w60{width:60%;}
.sk-line.w40{width:40%;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.55}}

/* ═══ PROFILE PAGE ═══ */
.profile-hero{background:linear-gradient(135deg,var(--primary),var(--primary-mid));padding:2rem 1.25rem 1rem;text-align:center;position:relative;}
.profile-ava-wrap{position:relative;display:inline-block;}
.profile-ava{width:100px;height:100px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-family:'DM Serif Display',serif;border:4px solid rgba(255,255,255,0.3);margin:0 auto 0.75rem;overflow:hidden;cursor:pointer;}
.profile-ava img{width:100%;height:100%;object-fit:cover;}
.profile-name{font-size:1.4rem;color:#fff;margin-bottom:0.2rem;}
.profile-username{font-size:0.85rem;color:rgba(255,255,255,0.6);margin-bottom:0.5rem;}
.profile-bio{font-size:0.88rem;color:rgba(255,255,255,0.8);margin:0.5rem auto;max-width:400px;font-style:italic;}
.profile-stats-row{display:flex;justify-content:center;gap:2rem;margin:1rem 0;}
.pstat{text-align:center;color:#fff;}
.pstat-val{font-size:1.3rem;font-weight:700;}
.pstat-lbl{font-size:0.7rem;opacity:.65;text-transform:uppercase;letter-spacing:.5px;}
.profile-actions{display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;padding-bottom:1rem;}
.btn-follow{padding:0.55rem 1.4rem;border-radius:20px;background:var(--accent);color:#fff;font-weight:700;font-size:0.88rem;border:none;transition:all  font-weight:600;font-size:0.85rem;
  display:flex;align-items:center;gap:0.4rem;
  transition:all .2s;flex-shrink:0;
}
.btn-post:hover{background:var(--primary-mid);transform:translateY(-1px);}
.btn-sign{
  padding:0.5rem 1rem;border-radius:20px;
  background:transparent;color:var(--primary);
  border:1.5px solid var(--primary);
  font-weight:600;font-size:0.85rem;
  transition:all .2s;flex-shrink:0;
}
.btn-sign:hover{background:var(--primary);color:#fff;}
.admin-chip{
  background:var(--danger);color:#fff;
  padding:0.2rem 0.6rem;border-radius:10px;
  font-size:0.7rem;font-weight:700;letter-spacing:.5px;
  flex-shrink:0;
}

/* ═══ BOTTOM NAV ═══ */
.bottomnav{
  position:fixed;bottom:0;left:0;right:0;z-index:900;
  height:var(--bottom-h);
  background:rgba(255,255,255,0.98);
  backdrop-filter:blur(24px);
  -webkit-backdrop-filter:blur(24px);
  border-top:1px solid rgba(232,228,220,0.8);
  display:flex;align-items:center;justify-content:space-around;
  padding:0 1rem;
  padding-bottom:env(safe-area-inset-bottom);
  box-shadow:0 -4px 24px rgba(27,67,50,0.06);
}
.bnav-item{
  display:flex;flex-direction:column;align-items:center;
  gap:0.25rem;
  cursor:pointer;border-radius:14px;
  transition:all .22s cubic-bezier(.34,1.56,.64,1);
  flex:1;max-width:90px;
  background:transparent;border:none;
  color:var(--text-light);padding:0.4rem 0.5rem;
  -webkit-tap-highlight-color:transparent;
}
.bnav-item.active{ color:var(--primary); }
.bnav-icon{
  font-size:1.4rem;line-height:1;
  transition:transform .22s cubic-bezier(.34,1.56,.64,1);
}
.bnav-item.active .bnav-icon{ transform:scale(1.15); }
.bnav-label{
  font-size:0.6rem;font-weight:700;
  letter-spacing:.4px;text-transform:uppercase;
  white-space:nowrap;opacity:.7;
  transition:opacity .2s;
}
.bnav-item.active .bnav-label{ opacity:1; }
/* Active indicator pill under label */
.bnav-pip{
  width:18px;height:3px;border-radius:2px;
  background:var(--primary);margin-top:1px;
  transform:scaleX(0);transition:transform .22s cubic-bezier(.34,1.56,.64,1);
}
.bnav-item.active .bnav-pip{ transform:scaleX(1); }

/* ─── Centre POST button ─── */
.bnav-post-wrap{
  flex:0 0 auto;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  position:relative;top:-8px;
}
.bnav-post-btn{
  width:58px;height:58px;border-radius:18px;
  background:linear-gradient(145deg, var(--primary-mid), var(--primary));
  color:#fff;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 20px rgba(27,67,50,0.4), 0 2px 6px rgba(27,67,50,0.2);
  transition:all .22s cubic-bezier(.34,1.56,.64,1);
  -webkit-tap-highlight-color:transparent;
  position:relative;overflow:hidden;
}
.bnav-post-btn::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(145deg,rgba(255,255,255,0.18),transparent);
  border-radius:inherit;
}
.bnav-post-btn:hover{
  transform:translateY(-3px) scale(1.06);
  box-shadow:0 10px 28px rgba(27,67,50,0.45), 0 4px 10px rgba(27,67,50,0.25);
}
.bnav-post-btn:active{
  transform:translateY(-1px) scale(0.97);
  box-shadow:0 4px 12px rgba(27,67,50,0.35);
}
.bnav-post-icon{
  font-size:1.8rem;line-height:1;font-weight:300;
  display:flex;align-items:center;justify-content:center;
  width:100%;height:100%;
  /* Perfect center the + */
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  transition:transform .22s cubic-bezier(.34,1.56,.64,1);
}
.bnav-post-btn:hover .bnav-post-icon{ transform:translate(-50%,-50%) rotate(90deg); }
.bnav-post-label{
  font-size:0.6rem;font-weight:700;letter-spacing:.4px;
  text-transform:uppercase;color:var(--text-light);
  margin-top:0.35rem;opacity:.7;
}

/* ═══ PAGES ═══ */
.page{display:none;min-height:calc(100vh - var(--nav-h) - var(--bottom-h));}
.page.active{display:block;}

/* ═══ HERO ═══ */
.hero{
  background:linear-gradient(135deg, var(--primary) 0%, var(--primary-mid) 60%, #3A8B6A 100%);
  padding:2.5rem 1.25rem 3rem;
  position:relative;overflow:hidden;
}
.hero::before{
  content:'';position:absolute;top:-40px;right:-40px;
  width:200px;height:200px;border-radius:50%;
  background:rgba(255,255,255,0.05);
}
.hero::after{
  content:'';position:absolute;bottom:-60px;left:-20px;
  width:160px;height:160px;border-radius:50%;
  background:rgba(212,165,116,0.15);
}
.hero h1{
  color:#fff;font-size:clamp(1.6rem,5vw,2.4rem);
  line-height:1.2;margin-bottom:0.5rem;
}
.hero p{color:rgba(255,255,255,0.75);font-size:0.95rem;margin-bottom:1.5rem;}
.search-wrap{
  background:#fff;border-radius:14px;
  display:flex;align-items:center;
  padding:0.4rem 0.4rem 0.4rem 1rem;
  box-shadow:0 4px 20px rgba(0,0,0,0.15);
  gap:0.5rem;
}
.search-wrap input{
  flex:1;border:none;font-size:0.95rem;
  background:transparent;color:var(--text);
}
.search-wrap input::placeholder{color:var(--text-light);}
.search-btn{
  padding:0.6rem 1.2rem;border-radius:10px;
  background:var(--primary);color:#fff;
  font-weight:600;font-size:0.9rem;
  transition:all .2s;flex-shrink:0;
}
.search-btn:hover{background:var(--primary-mid);}
.hero-stats{
  display:flex;gap:1.5rem;margin-top:1.5rem;
}
.hero-stat{color:rgba(255,255,255,0.85);}
.hero-stat strong{display:block;font-size:1.3rem;color:#fff;}
.hero-stat span{font-size:0.75rem;opacity:.7;}

/* ═══ SECTION ═══ */
.section{padding:1.5rem 1.25rem;}
.section-head{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:1.2rem;
}
.section-head h2{font-size:1.3rem;color:var(--primary);}
.see-all{font-size:0.85rem;color:var(--primary-mid);font-weight:600;cursor:pointer;}

/* ═══ FILTERS ═══ */
.filter-scroll{
  display:flex;gap:0.5rem;
  overflow-x:auto;padding:0.25rem 0.1rem 0.75rem;
  scrollbar-width:none;-webkit-scrollbar-width:none;
}
.filter-scroll::-webkit-scrollbar{display:none;}
.fchip{
  padding:0.45rem 0.9rem;border-radius:20px;
  border:1.5px solid var(--border);background:var(--card);
  font-size:0.85rem;font-weight:500;color:var(--text-mid);
  cursor:pointer;transition:all .2s;white-space:nowrap;
  flex-shrink:0;
}
.fchip.active,.fchip:hover{
  background:var(--primary);color:#fff;border-color:var(--primary);
}
.filter-selects{
  display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;
  margin-bottom:1rem;
}
.fsel{
  padding:0.6rem 0.5rem;border:1.5px solid var(--border);
  border-radius:10px;background:var(--card);font-size:0.82rem;
  color:var(--text);font-weight:500;
  appearance:none;-webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 8px center;
  padding-right:24px;cursor:pointer;
}

/* ═══ POST CARD ═══ */
.posts-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(min(100%,340px),1fr));
  gap:1.25rem;
}
.pcard{
  background:var(--card);border-radius:var(--radius);
  overflow:hidden;box-shadow:var(--shadow);
  transition:transform .25s, box-shadow .25s;
  position:relative;
}
.pcard:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);}
.pcard-images{
  position:relative;height:220px;
  background:linear-gradient(135deg,var(--primary-mid),var(--accent));
  overflow:hidden;
}
.pcard-img-scroll{
  display:flex;height:100%;
  overflow-x:auto;scroll-snap-type:x mandatory;
  scrollbar-width:none;
}
.pcard-img-scroll::-webkit-scrollbar{display:none;}
.pcard-img-scroll img{
  width:100%;height:100%;object-fit:cover;
  flex-shrink:0;scroll-snap-align:start;
}
.pcard-placeholder{
  width:100%;height:100%;display:flex;
  align-items:center;justify-content:center;
  font-size:3.5rem;
}
.rec-badge{
  position:absolute;top:0.75rem;left:0.75rem;
  background:var(--accent);color:#fff;
  padding:0.3rem 0.65rem;border-radius:20px;
  font-size:0.72rem;font-weight:700;letter-spacing:.3px;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}
.type-badge{
  position:absolute;top:0.75rem;right:0.75rem;
  background:rgba(255,255,255,0.92);backdrop-filter:blur(8px);
  color:var(--primary);padding:0.3rem 0.75rem;
  border-radius:20px;font-size:0.78rem;font-weight:700;
}
.views-badge{
  position:absolute;bottom:0.75rem;right:0.75rem;
  background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);
  color:#fff;padding:0.25rem 0.65rem;
  border-radius:20px;font-size:0.75rem;
  display:flex;align-items:center;gap:0.3rem;
}
.img-dots{
  position:absolute;bottom:0.75rem;left:50%;transform:translateX(-50%);
  display:flex;gap:4px;
}
.img-dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,0.5);}
.img-dot.active{background:#fff;}
.pcard-body{padding:1rem 1.1rem 1.1rem;}
.pcard-top{
  display:flex;justify-content:space-between;
  align-items:flex-start;margin-bottom:0.5rem;
}
.pcard-title{
  font-size:1.05rem;font-weight:700;color:var(--primary);
  line-height:1.3;flex:1;margin-right:0.5rem;
  cursor:pointer;
}
.pcard-title:hover{text-decoration:underline;}
.pcard-rating{
  display:flex;align-items:center;gap:0.25rem;
  font-size:0.82rem;font-weight:600;color:var(--star);
  flex-shrink:0;
}
.pcard-author{
  display:flex;align-items:center;gap:0.5rem;
  margin-bottom:0.75rem;
}
.author-ava{
  width:28px;height:28px;border-radius:50%;
  background:var(--primary-mid);color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:0.75rem;font-weight:700;
  cursor:pointer;overflow:hidden;flex-shrink:0;
  border:1.5px solid var(--border);
}
.author-ava img{width:100%;height:100%;object-fit:cover;}
.author-name{
  font-size:0.82rem;font-weight:600;color:var(--primary-mid);
  cursor:pointer;
}
.author-name:hover{text-decoration:underline;}
.author-location{
  font-size:0.78rem;color:var(--text-light);
  margin-left:auto;
}
.pcard-details{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  gap:0.4rem;margin-bottom:0.75rem;
}
.detail-chip{
  background:var(--bg);border-radius:8px;
  padding:0.4rem 0.5rem;text-align:center;
}
.detail-chip .dval{font-size:0.9rem;font-weight:700;color:var(--primary);}
.detail-chip .dlbl{font-size:0.65rem;color:var(--text-light);text-transform:uppercase;letter-spacing:.3px;}
.price-row{
  display:flex;align-items:baseline;gap:0.5rem;
  margin-bottom:0.75rem;
}
.price-main{font-size:1.3rem;font-weight:700;color:var(--primary);}
.price-warm{font-size:0.8rem;color:var(--text-light);}
.price-deposit{font-size:0.8rem;color:var(--text-mid);margin-left:auto;}
.tags-row{
  display:flex;flex-wrap:wrap;gap:0.35rem;
  margin-bottom:0.85rem;
}
.tag{
  background:rgba(27,67,50,0.07);color:var(--primary-mid);
  padding:0.25rem 0.6rem;border-radius:8px;
  font-size:0.75rem;font-weight:500;
}
.pcard-desc{
  font-size:0.85rem;color:var(--text-mid);
  line-height:1.55;margin-bottom:0.9rem;
  display:-webkit-box;-webkit-line-clamp:2;
  -webkit-box-orient:vertical;overflow:hidden;
}
.pcard-actions{
  display:flex;gap:0.5rem;align-items:center;
}
.btn-contact{
  flex:1;padding:0.6rem;border-radius:10px;
  background:var(--primary);color:#fff;
  font-weight:600;font-size:0.85rem;
  transition:all .2s;text-align:center;
}
.btn-contact:hover{background:var(--primary-mid);}
.btn-details{
  flex:1;padding:0.6rem;border-radius:10px;
  background:transparent;color:var(--primary);
  border:1.5px solid var(--primary);
  font-weight:600;font-size:0.85rem;
  transition:all .2s;text-align:center;
}
.btn-details:hover{background:var(--primary);color:#fff;}
.btn-edit-post{
  padding:0.6rem 0.9rem;border-radius:10px;
  background:var(--warn);color:var(--text);
  font-weight:600;font-size:0.85rem;
  transition:all .2s;display:flex;align-items:center;gap:0.3rem;
}
.btn-report-subtle{
  padding:0.5rem;border-radius:8px;
  background:transparent;color:var(--text-light);
  font-size:0.8rem;transition:all .2s;
  border:1px solid var(--border);flex-shrink:0;
  display:flex;align-items:center;gap:0.2rem;
}
.btn-report-subtle:hover{color:var(--danger);border-color:var(--danger);}
.admin-actions{
  display:flex;gap:0.4rem;margin-top:0.6rem;
  padding-top:0.6rem;border-top:2px dashed rgba(193,18,31,0.3);
}
.btn-admin{
  flex:1;padding:0.5rem;border-radius:8px;
  font-weight:600;font-size:0.78rem;
  transition:all .2s;
}
.btn-admin.edit{background:var(--warn);color:var(--text);}
.btn-admin.del{background:var(--danger);color:#fff;}
.pcard-stats{
  display:flex;gap:1rem;padding-top:0.75rem;
  border-top:1px solid var(--border);
  margin-top:0.1rem;font-size:0.78rem;color:var(--text-light);
}

/* ═══ PROFILE PAGE ═══ */
.profile-hero{
  background:linear-gradient(135deg,var(--primary),var(--primary-mid));
  padding:2rem 1.25rem 1rem;
  text-align:center;
  position:relative;
}
.profile-ava-wrap{position:relative;display:inline-block;}
.profile-ava{
  width:100px;height:100px;border-radius:50%;
  background:var(--accent);color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:2.5rem;font-family:'DM Serif Display',serif;
  border:4px solid rgba(255,255,255,0.3);
  margin:0 auto 0.75rem;overflow:hidden;cursor:pointer;
}
.profile-ava img{width:100%;height:100%;object-fit:cover;}
.profile-name{font-size:1.4rem;color:#fff;margin-bottom:0.2rem;}
.profile-username{font-size:0.85rem;color:rgba(255,255,255,0.6);margin-bottom:0.5rem;}
.profile-bio{font-size:0.88rem;color:rgba(255,255,255,0.8);margin:0.5rem auto;max-width:400px;font-style:italic;}
.profile-stats-row{
  display:flex;justify-content:center;gap:2rem;
  margin:1rem 0;
}
.pstat{text-align:center;color:#fff;}
.pstat-val{font-size:1.3rem;font-weight:700;}
.pstat-lbl{font-size:0.7rem;opacity:.65;text-transform:uppercase;letter-spacing:.5px;}
.profile-actions{
  display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;
  padding-bottom:1rem;
}
.btn-follow{
  padding:0.55rem 1.4rem;border-radius:20px;
  background:var(--accent);color:#fff;
  font-weight:700;font-size:0.88rem;
  border:none;transition:all .2s;
}
.btn-follow.following{
  background:transparent;color:#fff;border:1.5px solid rgba(255,255,255,0.5);
}
.btn-edit-profile{
  padding:0.55rem 1.2rem;border-radius:20px;
  background:rgba(255,255,255,0.15);color:#fff;
  border:1.5px solid rgba(255,255,255,0.35);
  font-weight:600;font-size:0.88rem;transition:all .2s;
}
.btn-edit-profile:hover{background:rgba(255,255,255,0.25);}
.btn-admin-portal{
  padding:0.55rem 1.2rem;border-radius:20px;
  background:rgba(193,18,31,0.18);color:#fff;
  border:1.5px solid rgba(193,18,31,0.6);
  font-weight:700;font-size:0.88rem;
  transition:all .2s;letter-spacing:.3px;
}
.btn-admin-portal:hover{background:var(--danger);border-color:var(--danger);}
.profile-tabs{
  display:flex;border-bottom:1px solid var(--border);
  background:var(--card);
}
.ptab{
  flex:1;padding:0.9rem;text-align:center;
  font-weight:600;font-size:0.88rem;color:var(--text-light);
  cursor:pointer;border-bottom:3px solid transparent;
  transition:all .2s;
}
.ptab.active{color:var(--primary);border-bottom-color:var(--primary);}
.ptab-content{display:none;}
.ptab-content.active{display:block;}
.photos-grid{
  display:grid;grid-template-columns:repeat(3,1fr);gap:3px;
  padding:3px;
}
.photo-item{
  aspect-ratio:1;overflow:hidden;cursor:pointer;
}
.photo-item img{width:100%;height:100%;object-fit:cover;transition:opacity .2s;}
.photo-item:hover img{opacity:0.85;}
.personal-photos-upload-area{
  border:2px dashed var(--border);border-radius:12px;
  padding:2rem;text-align:center;cursor:pointer;
  transition:all .2s;margin:1rem 1.25rem;
}
.personal-photos-upload-area:hover{border-color:var(--primary);background:rgba(27,67,50,0.03);}

/* ═══ MESSAGES PAGE ═══ */
.msgs-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:1rem 1.25rem;border-bottom:1px solid var(--border);
  background:var(--card);
  position:sticky;top:var(--nav-h);z-index:100;
}
.msgs-tabs{display:flex;gap:0.5rem;}
.msgs-tab{
  padding:0.4rem 0.9rem;border-radius:20px;
  font-size:0.85rem;font-weight:600;
  cursor:pointer;transition:all .2s;
  background:transparent;color:var(--text-light);border:1.5px solid var(--border);
}
.msgs-tab.active{background:var(--primary);color:#fff;border-color:var(--primary);}
.btn-new-group{
  padding:0.4rem 0.8rem;border-radius:20px;
  background:var(--accent);color:#fff;
  font-size:0.82rem;font-weight:600;
  display:flex;align-items:center;gap:0.3rem;
}
.conv-list{background:var(--card);}
.conv-item{
  display:flex;align-items:center;gap:0.85rem;
  padding:0.9rem 1.25rem;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .15s;
}
.conv-item:hover{background:var(--bg);}
.conv-item.active{background:rgba(27,67,50,0.05);}
.conv-ava{
  width:46px;height:46px;border-radius:50%;
  background:var(--primary-mid);color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:1.1rem;
  overflow:hidden;flex-shrink:0;border:2px solid var(--border);
}
.conv-ava img{width:100%;height:100%;object-fit:cover;}
.conv-ava.group{background:var(--accent);}
.conv-info{flex:1;min-width:0;}
.conv-name{font-weight:700;font-size:0.92rem;margin-bottom:0.2rem;}
.conv-preview{font-size:0.8rem;color:var(--text-light);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.conv-time{font-size:0.73rem;color:var(--text-light);flex-shrink:0;}
.conv-unread{
  background:var(--primary);color:#fff;
  border-radius:20px;min-width:20px;height:20px;
  display:flex;align-items:center;justify-content:center;
  font-size:0.7rem;font-weight:700;padding:0 5px;flex-shrink:0;
}

/* Chat View */
.chat-view{
  display:none;position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:var(--bg);z-index:1000;
  flex-direction:column;
}
.chat-view.open{display:flex;}
.chat-header{
  background:var(--card);
  border-bottom:1px solid var(--border);
  padding:0.75rem 1rem;
  display:flex;align-items:center;gap:0.75rem;
  flex-shrink:0;
}
.chat-back{
  padding:0.4rem;border-radius:8px;
  background:transparent;color:var(--text);
  font-size:1.2rem;transition:background .15s;
}
.chat-back:hover{background:var(--border);}
.chat-hdr-ava{
  width:36px;height:36px;border-radius:50%;
  background:var(--primary-mid);color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;overflow:hidden;flex-shrink:0;
}
.chat-hdr-ava img{width:100%;height:100%;object-fit:cover;}
.chat-hdr-info{flex:1;}
.chat-hdr-name{font-weight:700;font-size:0.95rem;}
.chat-hdr-sub{font-size:0.75rem;color:var(--text-light);}
.chat-msgs{
  flex:1;overflow-y:auto;
  padding:1rem;display:flex;flex-direction:column;gap:0.75rem;
}
.msg-bubble{
  max-width:78%;padding:0.65rem 0.9rem;
  border-radius:16px;font-size:0.88rem;line-height:1.5;
  word-break:break-word;
}
.msg-bubble.sent{
  align-self:flex-end;background:var(--primary);color:#fff;
  border-bottom-right-radius:4px;
}
.msg-bubble.recv{
  align-self:flex-start;background:var(--card);color:var(--text);
  border-bottom-left-radius:4px;box-shadow:0 1px 6px rgba(0,0,0,0.06);
}
.msg-bubble img{
  max-width:200px;border-radius:10px;margin-top:0.3rem;cursor:pointer;
}
.msg-sender{font-size:0.7rem;font-weight:700;margin-bottom:0.2rem;opacity:.6;}
.msg-time{font-size:0.65rem;opacity:.5;margin-top:0.2rem;text-align:right;}
.chat-input-area{
  background:var(--card);border-top:1px solid var(--border);
  padding:0.75rem 1rem;
  padding-bottom:calc(0.75rem + env(safe-area-inset-bottom));
  display:flex;align-items:center;gap:0.5rem;flex-shrink:0;
}
.chat-img-btn{
  width:38px;height:38px;border-radius:10px;
  background:var(--bg);border:1.5px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;cursor:pointer;flex-shrink:0;
  transition:border-color .2s;
}
.chat-img-btn:hover{border-color:var(--primary);}
.chat-input{
  flex:1;padding:0.6rem 0.9rem;
  border:1.5px solid var(--border);border-radius:22px;
  font-size:0.9rem;background:var(--bg);
  resize:none;max-height:100px;
  transition:border-color .2s;
}
.chat-input:focus{border-color:var(--primary);}
.chat-send{
  width:38px;height:38px;border-radius:50%;
  background:var(--primary);color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;flex-shrink:0;
  transition:all .2s;
}
.chat-send:hover{background:var(--primary-mid);transform:scale(1.05);}

/* ═══ MODALS ═══ */
.modal{
  display:none;position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);
  z-index:2000;align-items:center;justify-content:center;
  padding:1rem;
}
.modal.open{display:flex;}
.modal-box{
  background:var(--card);border-radius:20px;
  width:100%;max-width:560px;
  max-height:90vh;overflow-y:auto;
  padding:1.75rem;position:relative;
  box-shadow:0 20px 60px rgba(0,0,0,0.25);
}
.modal-box h2{font-size:1.5rem;color:var(--primary);margin-bottom:0.25rem;}
.modal-box p{font-size:0.88rem;color:var(--text-light);margin-bottom:1.25rem;}
.mclose{
  position:absolute;top:1rem;right:1rem;
  width:32px;height:32px;border-radius:50%;
  background:var(--bg);border:none;font-size:1.2rem;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--text-light);transition:all .2s;
}
.mclose:hover{background:var(--border);color:var(--text);}
.form-group{margin-bottom:1.1rem;}
.form-group label{
  display:block;font-size:0.85rem;font-weight:600;
  color:var(--text-mid);margin-bottom:0.4rem;
}
.form-group input,.form-group textarea,.form-group select{
  width:100%;padding:0.75rem 0.9rem;
  border:1.5px solid var(--border);border-radius:10px;
  font-size:0.92rem;color:var(--text);
  background:var(--bg);transition:border-color .2s;
}
.form-group input:focus,.form-group textarea:focus,.form-group select:focus{
  border-color:var(--primary);background:#fff;
}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;}
.form-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem;}
.checkbox-line{
  display:flex;align-items:center;gap:0.5rem;
  font-size:0.88rem;margin-bottom:0.4rem;
}
.checkbox-line input{width:auto;}
.facility-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:0.4rem;
}
.terms-scroll{
  background:var(--bg);border:1.5px solid var(--border);
  border-radius:10px;padding:0.9rem;
  max-height:180px;overflow-y:auto;
  font-size:0.82rem;line-height:1.6;
  margin-bottom:0.75rem;color:var(--text-mid);
}
.terms-scroll h4{color:var(--primary);font-weight:700;margin-bottom:0.5rem;}
.terms-scroll p{margin-bottom:0.5rem;}
.username-hint{font-size:0.78rem;margin-top:0.3rem;}
.username-hint.ok{color:var(--success);}
.username-hint.bad{color:var(--danger);}
.btn-full{
  width:100%;padding:0.85rem;border-radius:12px;
  background:var(--primary);color:#fff;
  font-weight:700;font-size:0.95rem;
  transition:all .2s;margin-top:0.5rem;
}
.btn-full:hover{background:var(--primary-mid);}
.btn-google{
  width:100%;padding:0.8rem;border-radius:12px;
  background:var(--card);color:var(--text);
  border:1.5px solid var(--border);
  font-weight:600;font-size:0.9rem;
  display:flex;align-items:center;justify-content:center;gap:0.5rem;
  transition:all .2s;margin-bottom:1rem;
}
.btn-google:hover{border-color:var(--primary);color:var(--primary);}
.divider-or{
  text-align:center;position:relative;margin:1rem 0;
}
.divider-or::before{
  content:'';position:absolute;top:50%;left:0;right:0;
  height:1px;background:var(--border);
}
.divider-or span{
  background:var(--card);padding:0 0.75rem;
  position:relative;font-size:0.82rem;color:var(--text-light);
}
.form-link{
  text-align:center;font-size:0.85rem;
  color:var(--text-light);margin-top:0.75rem;
}
.form-link a{color:var(--primary);font-weight:600;cursor:pointer;}
.img-upload-zone{
  border:2px dashed var(--border);border-radius:12px;
  padding:1.5rem;text-align:center;cursor:pointer;
  transition:all .2s;
}
.img-upload-zone:hover{border-color:var(--primary);background:rgba(27,67,50,0.02);}
.img-upload-zone .icon{font-size:2rem;margin-bottom:0.5rem;}
.img-upload-zone p{font-size:0.83rem;color:var(--text-light);}
.img-preview-row{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));
  gap:0.4rem;margin-top:0.6rem;
}
.img-prev{
  aspect-ratio:1;border-radius:8px;overflow:hidden;
  position:relative;background:var(--bg);
}
.img-prev img{width:100%;height:100%;object-fit:cover;}
.img-prev-del{
  position:absolute;top:3px;right:3px;
  width:20px;height:20px;border-radius:50%;
  background:rgba(0,0,0,0.65);color:#fff;
  font-size:0.7rem;display:flex;align-items:center;justify-content:center;cursor:pointer;
}
.photo-upload-circle{
  width:90px;height:90px;border-radius:50%;
  background:var(--bg);border:2px dashed var(--border);
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 0.75rem;cursor:pointer;overflow:hidden;
  transition:border-color .2s;font-size:1.5rem;
}
.photo-upload-circle:hover{border-color:var(--primary);}
.photo-upload-circle img{width:100%;height:100%;object-fit:cover;}

/* Admin Panel */
.admin-topbar{
  background:linear-gradient(135deg,#1a0a0a,#3d0f0f);
  padding:1rem 1.25rem;
  display:flex;align-items:center;gap:0.75rem;
  position:sticky;top:var(--nav-h);z-index:100;
}
.admin-back-btn{
  padding:0.4rem 0.9rem;border-radius:20px;
  background:rgba(255,255,255,0.12);color:#fff;
  font-size:0.82rem;font-weight:600;
  border:1px solid rgba(255,255,255,0.2);
  transition:all .2s;flex-shrink:0;
}
.admin-back-btn:hover{background:rgba(255,255,255,0.22);}
.admin-title{
  font-weight:700;color:#fff;font-size:1rem;flex:1;text-align:center;
}
.admin-badge-lbl{
  font-size:0.7rem;color:rgba(255,100,100,0.85);
  border:1px solid rgba(255,100,100,0.4);
  padding:0.2rem 0.6rem;border-radius:10px;
  font-weight:600;letter-spacing:.5px;flex-shrink:0;
}
.admin-section-head{
  border-bottom:2px solid rgba(193,18,31,0.15);
  padding-bottom:0.5rem;margin-bottom:0.75rem;
}
.admin-section-head h3{color:var(--danger);font-size:1rem;}
.admin-user-card{
  background:var(--bg);border-radius:12px;
  padding:0.85rem 1rem;margin-bottom:0.5rem;
  display:flex;align-items:center;gap:0.75rem;
  border:1px solid var(--border);
}
.auc-ava{
  width:38px;height:38px;border-radius:50%;
  background:var(--primary-mid);color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:0.95rem;overflow:hidden;flex-shrink:0;
}
.auc-ava img{width:100%;height:100%;object-fit:cover;}
.auc-info{flex:1;min-width:0;}
.auc-name{font-weight:700;font-size:0.88rem;}
.auc-meta{font-size:0.75rem;color:var(--text-light);}
.auc-actions{display:flex;gap:0.35rem;flex-shrink:0;}
.admin-post-card{
  background:var(--bg);border-radius:12px;
  padding:0.85rem 1rem;margin-bottom:0.5rem;
  border:1px solid var(--border);
}
.apc-title{font-weight:700;font-size:0.88rem;color:var(--primary);margin-bottom:0.25rem;}
.apc-meta{font-size:0.78rem;color:var(--text-light);margin-bottom:0.5rem;}
.apc-actions{display:flex;gap:0.35rem;flex-wrap:wrap;}
.admin-panel h2{color:var(--danger);}
.admin-stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:0.75rem;margin:1rem 0;}
.astat-card{background:var(--bg);border-radius:12px;padding:1rem;text-align:center;}
.astat-val{font-size:1.8rem;font-weight:700;color:var(--danger);}
.astat-lbl{font-size:0.75rem;color:var(--text-light);margin-top:0.2rem;}
.report-card{background:var(--bg);border-radius:12px;padding:1rem;margin-bottom:0.75rem;border-left:4px solid var(--warn);}
.report-card.done{border-left-color:var(--success);opacity:.6;}
.report-card-actions{display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.75rem;}
.btn-admin-action{
  padding:0.4rem 0.75rem;border-radius:8px;
  font-size:0.8rem;font-weight:600;
}
.ba-warn{background:var(--warn);color:var(--text);}
.ba-ban{background:var(--danger);color:#fff;}
.ba-del{background:rgba(193,18,31,0.1);color:var(--danger);border:1px solid rgba(193,18,31,0.3);}
.ba-dismiss{background:var(--bg);color:var(--text-light);border:1px solid var(--border);}

/* User View Modal */
.uview-hero{
  background:linear-gradient(135deg,var(--primary),var(--primary-mid));
  padding:1.5rem;text-align:center;border-radius:16px 16px 0 0;
  margin:-1.75rem -1.75rem 1.5rem;
}
.uview-ava{
  width:80px;height:80px;border-radius:50%;
  background:var(--accent);color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:2rem;margin:0 auto 0.75rem;
  border:3px solid rgba(255,255,255,0.3);overflow:hidden;
}
.uview-ava img{width:100%;height:100%;object-fit:cover;}
.uview-name{font-size:1.3rem;color:#fff;}
.uview-username{font-size:0.83rem;color:rgba(255,255,255,0.6);margin-bottom:0.75rem;}
.uview-bio{font-size:0.85rem;color:rgba(255,255,255,0.75);font-style:italic;margin-bottom:1rem;}
.uview-stats{display:flex;justify-content:center;gap:1.5rem;}
.uview-stat{text-align:center;color:#fff;}
.uview-stat strong{display:block;font-size:1.1rem;}
.uview-stat span{font-size:0.7rem;opacity:.6;}

/* Post Detail Modal */
.post-detail-gallery{
  margin:-1.75rem -1.75rem 1.5rem;
  height:280px;background:linear-gradient(135deg,var(--primary-mid),var(--accent));
  overflow:hidden;border-radius:16px 16px 0 0;
  position:relative;
}
.pdg-scroll{
  display:flex;height:100%;overflow-x:auto;
  scroll-snap-type:x mandatory;scrollbar-width:none;
}
.pdg-scroll::-webkit-scrollbar{display:none;}
.pdg-scroll img{width:100%;height:100%;object-fit:cover;flex-shrink:0;scroll-snap-align:start;}
.pdg-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:5rem;}
.post-detail-price{
  background:var(--primary);border-radius:12px;padding:1.25rem;
  margin-bottom:1.25rem;
}
.pdp-main{font-size:2rem;font-weight:700;color:#fff;margin-bottom:0.25rem;}
.pdp-sub{font-size:0.8rem;color:rgba(255,255,255,0.65);}
.pdp-breakdown{
  display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-top:1rem;
}
.pdp-item{background:rgba(255,255,255,0.1);border-radius:8px;padding:0.6rem;text-align:center;}
.pdp-val{font-size:0.95rem;font-weight:700;color:#fff;}
.pdp-lbl{font-size:0.65rem;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:.3px;}
.post-detail-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:0.5rem;margin-bottom:1.25rem;
}
.pdg-item{
  background:var(--bg);border-radius:10px;padding:0.75rem;
}
.pdg-item .icon{font-size:1.2rem;margin-bottom:0.3rem;}
.pdg-item .val{font-size:0.95rem;font-weight:700;color:var(--primary);}
.pdg-item .lbl{font-size:0.7rem;color:var(--text-light);}
.map-link{
  display:flex;align-items:center;justify-content:center;gap:0.5rem;
  background:var(--bg);border:1.5px solid var(--border);border-radius:10px;
  padding:0.75rem;color:var(--primary);font-weight:600;font-size:0.88rem;
  text-decoration:none;margin-bottom:1rem;transition:all .2s;
}
.map-link:hover{background:var(--primary);color:#fff;border-color:var(--primary);}
.section-label{font-weight:700;font-size:0.9rem;color:var(--primary);margin-bottom:0.75rem;margin-top:1.25rem;}

/* Toast */
.toast{
  position:fixed;bottom:calc(var(--bottom-h) + 10px);left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--primary);color:#fff;padding:0.6rem 1.2rem;
  border-radius:20px;font-size:0.85rem;font-weight:500;
  z-index:9999;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* Loading */
.skeleton{
  background:linear-gradient(90deg,var(--border) 25%,rgba(224,220,220,0.5) 50%,var(--border) 75%);
  background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:8px;
}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}

/* ═══ RESPONSIVE ═══ */
@media(max-width:767px){
  body{padding-bottom:calc(var(--bottom-h) + env(safe-area-inset-bottom));}
  .topnav{padding:0 0.9rem;gap:0.5rem;}
  .logo{font-size:1.25rem;}
  .lang-toggle{font-size:0.75rem;padding:0.28rem 0.55rem;}
  .btn-sign{font-size:0.78rem;padding:0.4rem 0.8rem;}
  .topnav-avatar{width:32px;height:32px;font-size:0.8rem;}
  .btn-msgs-icon{width:32px;height:32px;font-size:1rem;}
  .hero{padding:1.75rem 1rem 2rem;}
  .hero h1{font-size:1.5rem;}
  .hero p{font-size:0.85rem;}
  .filter-selects{grid-template-columns:repeat(3,1fr);gap:0.35rem;}
  .fsel{font-size:0.75rem;padding:0.5rem 0.35rem;padding-right:18px;}
  .posts-grid{grid-template-columns:1fr;}
  .section{padding:1rem;}
  .modal-box{padding:1.25rem;border-radius:16px;}
  .form-row{grid-template-columns:1fr;}
  .form-row3{grid-template-columns:1fr 1fr;}
  #postBtn{display:none!important;}
}
/* Small phones */
@media(max-width:375px){
  .topnav{padding:0 0.65rem;gap:0.35rem;}
  .logo{font-size:1.1rem;}
  .lang-toggle{font-size:0.7rem;padding:0.25rem 0.45rem;}
  .bnav-item{padding:0.35rem 0.4rem;}
  .bnav-icon{font-size:1.25rem;}
  .bnav-label{font-size:0.55rem;}
  .bnav-post-btn{width:52px;height:52px;border-radius:16px;}
  .bnav-post-icon{font-size:1.6rem;}
}
/* Tablet / Desktop */
@media(min-width:768px){
  body{padding-bottom:0;}
  .bottomnav{display:none;}
  .topnav{padding:0 2rem;}
  .hero{padding:4rem 2rem 3.5rem;}
  .hero h1{font-size:2.8rem;}
  .section{padding:2rem;}
  .posts-grid{grid-template-columns:repeat(auto-fill,minmax(340px,1fr));}
  .chat-view{position:relative;top:auto;left:auto;right:auto;bottom:auto;display:flex;min-height:600px;}
  .msgs-layout{display:grid;grid-template-columns:300px 1fr;gap:0;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:var(--card);}
  .msgs-sidebar{border-right:1px solid var(--border);}
  .chat-back{display:none;}
  #postBtn{display:flex!important;}
}
@media(min-width:1200px){
  .posts-grid{grid-template-columns:repeat(auto-fill,minmax(360px,1fr));}
  .section{padding:2rem 3rem;}
}
</style>
</head>
<body>

<!-- TOP NAV -->
<nav class="topnav" id="topnav">
  <div class="logo" onclick="showPage('home')">Berlin<span>Nest</span></div>
  <div class="topnav-right">
    <button class="lang-toggle" id="langToggleBtn" onclick="toggleLang()">🇬🇧 EN</button>
    <button class="btn-msgs-icon" onclick="showPage('messages')" title="Messages">
      💬<span class="msgs-unread-dot" id="msgsUnreadDot"></span>
    </button>
    <button class="btn-sign hidden" id="signinBtn" onclick="openModal('loginModal')"></button>
    <button class="btn-post" id="postBtn" onclick="handlePostClick()">
      <span>＋</span><span data-key="post_btn">Post</span>
    </button>
  </div>
</nav>

<!-- BOTTOM NAV: Home · Post · Profile -->
<nav class="bottomnav" id="bottomnav">
  <button class="bnav-item active" id="bn-home" onclick="showPage('home')">
    <span class="bnav-icon">🏠</span>
    <span class="bnav-label" data-key="nav_home">Home</span>
    <span class="bnav-pip"></span>
  </button>

  <div class="bnav-post-wrap" id="bn-post">
    <button class="bnav-post-btn" onclick="handlePostClick()" aria-label="Post listing">
      <span class="bnav-post-icon">＋</span>
    </button>
    <span class="bnav-post-label" data-key="nav_post">Post</span>
  </div>

  <button class="bnav-item" id="bn-profile" onclick="showPage('profile')">
    <span class="bnav-icon">👤</span>
    <span class="bnav-label" data-key="nav_profile">Profile</span>
    <span class="bnav-pip"></span>
  </button>
</nav>

<!-- ════════ HOME PAGE ════════ -->
<div class="page active" id="page-home">
  <div class="hero">
    <h1 data-key="hero_title">Find Your Perfect Home in Berlin</h1>
    <p data-key="hero_sub">Discover verified apartments across all neighborhoods</p>
    <div class="search-wrap">
      <span>🔍</span>
      <input type="text" id="searchInput" placeholder="Search neighborhood, type..." data-key-ph="search_ph">
      <button class="search-btn" onclick="doSearch()" data-key="search">Search</button>
    </div>

  </div>
  <div class="section">
    <div class="filter-selects">
      <select class="fsel" id="f-ortsteil" onchange="applyFilters()">
        <option value="">Areas</option>
        <option>Kreuzberg</option><option>Prenzlauer Berg</option>
        <option>Friedrichshain</option><option>Neukölln</option>
        <option>Charlottenburg</option><option>Mitte</option>
        <option>Wedding</option><option>Moabit</option>
        <option>Schöneberg</option><option>Wilmersdorf</option>
        <option>Tempelhof</option><option>Steglitz</option>
        <option>Pankow</option><option>Lichtenberg</option>
        <option>Treptow</option><option>Köpenick</option>
        <option>Spandau</option><option>Reinickendorf</option>
      </select>
      <select class="fsel" id="f-price" onchange="applyFilters()">
        <option value="">Price</option>
        <option value="0-500">Under €500</option>
        <option value="500-800">€500–€800</option>
        <option value="800-1200">€800–€1,200</option>
        <option value="1200-2000">€1,200–€2,000</option>
        <option value="2000-9999">€2,000+</option>
      </select>
      <select class="fsel" id="f-type" onchange="applyFilters()">
        <option value="">Type</option>
        <option value="Studio">Studio</option>
        <option value="1-Zimmer">1-Zimmer</option>
        <option value="2-Zimmer">2-Zimmer</option>
        <option value="3-Zimmer">3-Zimmer</option>
        <option value="4+ Zimmer">4+ Zimmer</option>
        <option value="WG-Zimmer">WG-Zimmer</option>
      </select>
    </div>
    <div class="section-head">
      <h2 data-key="section_listings">Recent Listings</h2>
      <span class="see-all" onclick="clearFilters()" data-key="see_all">See All</span>
    </div>
    <div class="posts-grid" id="postsGrid"></div>
  </div>
</div>

<!-- ════════ MESSAGES PAGE ════════ -->
<div class="page" id="page-messages">
  <div class="msgs-layout" id="msgsLayout">
    <div class="msgs-sidebar" id="msgsSidebar">
      <div class="msgs-header">
        <div class="msgs-tabs">
          <button class="msgs-tab active" id="tab-dms" onclick="switchMsgsTab('dms')" data-key="tab_dms">Direct</button>
          <button class="msgs-tab" id="tab-groups" onclick="switchMsgsTab('groups')" data-key="tab_groups">Groups</button>
        </div>
        <button class="btn-new-group" onclick="openModal('newGroupModal')">＋ <span data-key="new_group">Group</span></button>
      </div>
      <div class="conv-list" id="convList"></div>
    </div>
    <div id="chatArea" style="display:flex;align-items:center;justify-content:center;background:var(--bg);min-height:400px;">
      <div style="text-align:center;color:var(--text-light);">
        <div style="font-size:3rem;margin-bottom:1rem;">💬</div>
        <p data-key="select_conv">Select a conversation</p>
      </div>
    </div>
  </div>
</div>

<!-- ════════ PROFILE PAGE ════════ -->
<div class="page" id="page-profile">
  <div id="profileContent"></div>
</div>

<!-- ════════ ADMIN PAGE ════════ -->
<div class="page" id="page-admin">
  <div class="admin-topbar">
    <button class="admin-back-btn" onclick="showPage('profile')">← Back to Profile</button>
    <span class="admin-title">🛡️ Admin Panel</span>
    <span class="admin-badge-lbl">Vikram only</span>
  </div>
  <div class="section">
    <div class="admin-panel">
      <h2>🛡️ Control Panel</h2>
      <div class="admin-stats-row">
        <div class="astat-card"><div class="astat-val" id="a-users">0</div><div class="astat-lbl">Total Users</div></div>
        <div class="astat-card"><div class="astat-val" id="a-posts">0</div><div class="astat-lbl">Total Posts</div></div>
        <div class="astat-card"><div class="astat-val" id="a-reports">0</div><div class="astat-lbl">Pending Reports</div></div>
        <div class="astat-card"><div class="astat-val" id="a-banned">0</div><div class="astat-lbl">Banned Users</div></div>
      </div>

      <!-- ALL USERS LIST -->
      <div class="admin-section-head">
        <h3>👥 All Users</h3>
      </div>
      <div id="adminUsersList"></div>

      <!-- REPORTS LIST -->
      <div class="admin-section-head" style="margin-top:1.5rem;">
        <h3>📋 Reports</h3>
      </div>
      <div id="adminReportsList"></div>

      <!-- ALL POSTS LIST -->
      <div class="admin-section-head" style="margin-top:1.5rem;">
        <h3>🏠 All Posts</h3>
      </div>
      <div id="adminPostsList"></div>
    </div>
  </div>
</div>

<!-- CHAT VIEW OVERLAY -->
<div class="chat-view" id="chatView">
  <div class="chat-header">
    <button class="chat-back" onclick="closeChat()">←</button>
    <div class="chat-hdr-ava" id="chatHdrAva"></div>
    <div class="chat-hdr-info">
      <div class="chat-hdr-name" id="chatHdrName"></div>
      <div class="chat-hdr-sub" id="chatHdrSub"></div>
    </div>
  </div>
  <div class="chat-msgs" id="chatMsgs"></div>
  <div class="chat-input-area">
    <button class="chat-img-btn" onclick="document.getElementById('chatImgUpload').click()" title="Send image">📷</button>
    <input type="file" id="chatImgUpload" accept="image/*" style="display:none" onchange="sendChatImage(this)">
    <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1" onkeydown="handleChatKey(event)"></textarea>
    <button class="chat-send" onclick="sendMessage()">➤</button>
  </div>
</div>

<!-- ════════ MODALS ════════ -->

<!-- LOGIN -->
<div class="modal" id="loginModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('loginModal')">×</button>
    <h2 data-key="login_title">Welcome Back</h2>
    <p data-key="login_sub">Sign in to your account</p>
    <button class="btn-google" onclick="handleGoogleAuth('login')">
      🔵 <span data-key="google_signin">Sign in with Google</span>
    </button>
    <div class="divider-or"><span data-key="or">or</span></div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label data-key="email">Email</label>
        <input type="email" id="loginEmail" required>
      </div>
      <div class="form-group">
        <label data-key="password">Password</label>
        <input type="password" id="loginPassword" required>
      </div>
      <button type="submit" class="btn-full" data-key="sign_in">Sign In</button>
    </form>
    <div class="form-link" data-key="no_account">Don't have an account? <a onclick="switchModal('loginModal','signupModal')" data-key="sign_up_link">Sign up</a></div>
  </div>
</div>

<!-- SIGNUP -->
<div class="modal" id="signupModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('signupModal')">×</button>
    <h2 data-key="signup_title">Create Account</h2>
    <p data-key="signup_sub">Join BerlinNest today</p>
    <button class="btn-google" onclick="handleGoogleAuth('signup')">
      🔵 <span data-key="google_signup">Sign up with Google</span>
    </button>
    <div class="divider-or"><span data-key="or">or</span></div>
    <form onsubmit="handleSignup(event)">
      <div class="form-row">
        <div class="form-group">
          <label data-key="username">Username</label>
          <input type="text" id="signupUser" oninput="checkUser(this,'signupUserHint')" required>
          <div class="username-hint" id="signupUserHint"></div>
        </div>
        <div class="form-group">
          <label data-key="fullname">Full Name</label>
          <input type="text" id="signupName" required>
        </div>
      </div>
      <div class="form-group">
        <label data-key="email">Email</label>
        <input type="email" id="signupEmail" required>
      </div>
      <div class="form-group">
        <label data-key="password">Password</label>
        <input type="password" id="signupPass" required>
      </div>
      <div class="form-group">
        <label data-key="gender_label">Gender <span style="color:var(--text-light);font-weight:400;">(Optional · Private)</span></label>
        <select id="signupGender">
          <option value="" data-key="prefer_not">Prefer not to say</option>
          <option value="m" data-key="male">Male</option>
          <option value="f" data-key="female">Female</option>
          <option value="o" data-key="other">Other</option>
        </select>
      </div>
      <div class="terms-scroll">
        <h4>📜 Terms & Conditions</h4>
        <p><strong>1. Zero Harassment Policy.</strong> BerlinNest strictly prohibits harassment of any kind. Violations result in immediate account termination.</p>
        <p><strong>2. No Discrimination.</strong> Any form of discrimination based on gender, race, religion, nationality, or sexual orientation is forbidden.</p>
        <p><strong>3. Accurate Listings.</strong> All apartment information must be truthful and current.</p>
        <p><strong>4. Privacy.</strong> Your gender and private information are never shared publicly.</p>
        <p><strong>5. Safety.</strong> Report suspicious activity. Admins review all reports within 24 hours.</p>
        <p><strong>6. Content.</strong> No explicit, offensive, or fraudulent content allowed.</p>
        <p><strong>7. Fair Use.</strong> No scraping, spamming, or automated access without permission.</p>
      </div>
      <div class="checkbox-line">
        <input type="checkbox" id="acceptTerms" required>
        <label for="acceptTerms" data-key="accept_terms">I accept the Terms & Conditions</label>
      </div>
      <button type="submit" class="btn-full" data-key="create_account">Create Account</button>
    </form>
    <div class="form-link"><span data-key="have_account">Already have an account?</span> <a onclick="switchModal('signupModal','loginModal')" data-key="sign_in_link">Sign in</a></div>
  </div>
</div>

<!-- NEW POST -->
<div class="modal" id="postModal">
  <div class="modal-box" style="max-width:640px;">
    <button class="mclose" onclick="closeModal('postModal')">×</button>
    <h2 data-key="post_title">List Your Apartment</h2>
    <p data-key="post_sub">Fill in the details to attract great tenants</p>
    <form onsubmit="handlePost(event)">
      <div class="form-group">
        <label data-key="apt_title">Listing Title</label>
        <input type="text" id="pTitle" placeholder="e.g. Bright Studio near Mauerpark" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label data-key="ortsteil">Ortsteil</label>
          <select id="pOrtsteil" required>
            <option value="">Select area...</option>
            <option>Kreuzberg</option><option>Prenzlauer Berg</option>
            <option>Friedrichshain</option><option>Neukölln</option>
            <option>Charlottenburg</option><option>Mitte</option>
            <option>Wedding</option><option>Moabit</option>
            <option>Schöneberg</option><option>Wilmersdorf</option>
            <option>Tempelhof</option><option>Steglitz</option>
            <option>Pankow</option><option>Lichtenberg</option>
            <option>Treptow</option><option>Köpenick</option>
            <option>Spandau</option><option>Reinickendorf</option>
          </select>
        </div>
        <div class="form-group">
          <label data-key="apt_type">Type</label>
          <select id="pType" required>
            <option>Studio</option><option>1-Zimmer</option>
            <option>2-Zimmer</option><option>3-Zimmer</option>
            <option>4+ Zimmer</option><option>WG-Zimmer</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label data-key="apt_share">Sharing</label>
          <select id="pShare" required>
            <option value="private">Private</option>
            <option value="shared">Shared</option>
            <option value="studio">Studio</option>
          </select>
        </div>
        <div class="form-group">
          <label data-key="size">Size (m²)</label>
          <input type="number" id="pSize" min="5" max="500" required>
        </div>
      </div>
      <div class="form-row3">
        <div class="form-group">
          <label data-key="kaltmiete">Rent €</label>
          <input type="number" id="pCold" min="0" required>
        </div>
        <div class="form-group">
          <label data-key="warmmiete">Rent with utilities €</label>
          <input type="number" id="pWarm" min="0" required>
        </div>
        <div class="form-group">
          <label data-key="kaution">Deposit €</label>
          <input type="number" id="pDeposit" min="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Floor</label>
          <input type="number" id="pFloor" min="-1" max="50" placeholder="0">
        </div>
        <div class="form-group">
          <label data-key="anmeldung">Anmeldung</label>
          <select id="pAnmeldung">
            <option value="yes" data-key="yes">Yes</option>
            <option value="no" data-key="no">No</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label data-key="facilities">Facilities</label>
        <div class="facility-grid">
          <div class="checkbox-line"><input type="checkbox" value="Balcony" class="pfac"><label data-key="balcony">Balcony</label></div>
          <div class="checkbox-line"><input type="checkbox" value="Elevator" class="pfac"><label data-key="elevator">Elevator</label></div>
          <div class="checkbox-line"><input type="checkbox" value="Kitchen" class="pfac"><label data-key="kitchen">Kitchen</label></div>
          <div class="checkbox-line"><input type="checkbox" value="Dishwasher" class="pfac"><label data-key="dishwasher">Dishwasher</label></div>
          <div class="checkbox-line"><input type="checkbox" value="Washer" class="pfac"><label data-key="washer">Washer</label></div>
          <div class="checkbox-line"><input type="checkbox" value="Parking" class="pfac"><label data-key="parking">Parking</label></div>
          <div class="checkbox-line"><input type="checkbox" value="Garden" class="pfac"><label data-key="garden">Garden</label></div>
          <div class="checkbox-line"><input type="checkbox" value="Pets OK" class="pfac"><label data-key="pets">Pets OK</label></div>
          <div class="checkbox-line"><input type="checkbox" value="Furnished" class="pfac"><label data-key="furnished">Furnished</label></div>
          <div class="checkbox-line"><input type="checkbox" value="Cellar" class="pfac"><label data-key="cellar">Cellar</label></div>
        </div>
      </div>
      <div class="form-group">
        <label data-key="description">Description</label>
        <textarea id="pDesc" rows="4" required></textarea>
      </div>
      <div class="form-group">
        <label data-key="photos">Photos (up to 11)</label>
        <div class="img-upload-zone" onclick="document.getElementById('pImgs').click()">
          <div class="icon">📸</div>
          <p data-key="upload_photos">Click to upload photos</p>
        </div>
        <input type="file" id="pImgs" multiple accept="image/*" style="display:none" onchange="handlePostImgs(this)">
        <div class="img-preview-row" id="pImgPreviews"></div>
      </div>
      <button type="submit" class="btn-full" data-key="publish">Publish Listing</button>
    </form>
  </div>
</div>

<!-- EDIT POST -->
<div class="modal" id="editPostModal">
  <div class="modal-box" style="max-width:560px;">
    <button class="mclose" onclick="closeModal('editPostModal')">×</button>
    <h2 data-key="edit_post">Edit Post</h2>
    <p data-key="edit_post_sub">Update your listing details</p>
    <form onsubmit="handleEditPost(event)">
      <input type="hidden" id="editPostId">
      <div class="form-group"><label data-key="apt_title">Title</label><input type="text" id="eptTitle" required></div>
      <div class="form-group"><label data-key="description">Description</label><textarea id="eptDesc" rows="3" required></textarea></div>
      <div class="form-row">
        <div class="form-group"><label data-key="warmmiete">Rent with utilities €</label><input type="number" id="eptWarm" required></div>
        <div class="form-group"><label data-key="kaution">Deposit €</label><input type="number" id="eptDeposit"></div>
      </div>
      <button type="submit" class="btn-full" data-key="save_changes">Save Changes</button>
    </form>
  </div>
</div>

<!-- EDIT PROFILE -->
<div class="modal" id="editProfileModal">
  <div class="modal-box" style="max-width:500px;">
    <button class="mclose" onclick="closeModal('editProfileModal')">×</button>
    <h2 data-key="edit_profile">Edit Profile</h2>
    <p data-key="edit_profile_sub">Customize your BerlinNest profile</p>
    <form onsubmit="handleEditProfile(event)">
      <div style="text-align:center;margin-bottom:1.25rem;">
        <div class="photo-upload-circle" onclick="document.getElementById('profPhotoInput').click()" id="profPhotoPreview">📷</div>
        <input type="file" id="profPhotoInput" accept="image/*" style="display:none" onchange="handleProfPhoto(this)">
        <p style="font-size:0.78rem;color:var(--text-light);" data-key="tap_to_change">Tap to change photo</p>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label data-key="username">Username</label>
          <input type="text" id="editUser" oninput="checkUser(this,'editUserHint')" required>
          <div class="username-hint" id="editUserHint"></div>
        </div>
        <div class="form-group"><label data-key="fullname">Full Name</label><input type="text" id="editName" required></div>
      </div>
      <div class="form-group"><label data-key="bio">Bio</label><textarea id="editBio" rows="3" placeholder="Tell the community about yourself..."></textarea></div>
      <div class="form-group">
        <label data-key="personal_photos">Personal Photos</label>
        <div class="img-upload-zone" onclick="document.getElementById('persPhotosInput').click()">
          <div class="icon">🖼️</div>
          <p data-key="upload_photos">Upload photos for your gallery</p>
        </div>
        <input type="file" id="persPhotosInput" multiple accept="image/*" style="display:none" onchange="handlePersPhotos(this)">
        <div class="img-preview-row" id="persPhotosPreviews"></div>
      </div>
      <button type="submit" class="btn-full" data-key="save_changes">Save Changes</button>
    </form>
  </div>
</div>

<!-- REPORT -->
<div class="modal" id="reportModal">
  <div class="modal-box" style="max-width:440px;">
    <button class="mclose" onclick="closeModal('reportModal')">×</button>
    <h2 data-key="report_title">Submit a Report</h2>
    <p data-key="report_sub">Our team reviews all reports within 24 hours</p>
    <form onsubmit="handleReport(event)">
      <div class="form-group">
        <label data-key="reason">Reason</label>
        <select id="reportReason" required>
          <option value="" data-key="select_reason">Select reason...</option>
          <option value="harassment" data-key="r_harassment">Harassment</option>
          <option value="discrimination" data-key="r_discrimination">Discrimination</option>
          <option value="fake" data-key="r_fake">Fake Listing</option>
          <option value="spam" data-key="r_spam">Spam</option>
          <option value="inappropriate" data-key="r_inappropriate">Inappropriate Content</option>
          <option value="other" data-key="r_other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label data-key="details">Details</label>
        <textarea id="reportDetails" rows="3" required></textarea>
      </div>
      <button type="submit" class="btn-full" style="background:var(--danger);" data-key="submit_report">Submit Report</button>
    </form>
  </div>
</div>

<!-- VIEW USER PROFILE -->
<div class="modal" id="userProfileModal">
  <div class="modal-box" style="max-width:480px;">
    <button class="mclose" onclick="closeModal('userProfileModal')">×</button>
    <div id="userProfileContent"></div>
  </div>
</div>

<!-- POST DETAIL -->
<div class="modal" id="postDetailModal">
  <div class="modal-box" style="max-width:640px;">
    <button class="mclose" onclick="closeModal('postDetailModal')">×</button>
    <div id="postDetailContent"></div>
  </div>
</div>

<!-- NEW GROUP -->
<div class="modal" id="newGroupModal">
  <div class="modal-box" style="max-width:440px;">
    <button class="mclose" onclick="closeModal('newGroupModal')">×</button>
    <h2 data-key="create_group">Create Group</h2>
    <p data-key="create_group_sub">Start a group chat for your community</p>
    <form onsubmit="handleCreateGroup(event)">
      <div class="form-group"><label data-key="group_name">Group Name</label><input type="text" id="groupName" required></div>
      <div class="form-group"><label data-key="group_desc">Description (optional)</label><textarea id="groupDesc" rows="2"></textarea></div>
      <button type="submit" class="btn-full" data-key="create_group_btn">Create Group</button>
    </form>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════
// TRANSLATIONS
// ═══════════════════════════════════════
const LANG = {
  en: {
    hero_title:"Find Your Perfect Home in Berlin",hero_sub:"Discover verified apartments across all neighborhoods",
    search:"Search",search_ph:"Search neighborhood, type...",
    hs_listings:"Listings",hs_users:"Users",hs_districts:"Districts",
    section_listings:"Recent Listings",see_all:"See All",all_neighborhoods:"All Areas",
    all_prices:"All Prices",all_sizes:"All Sizes",
    nav_home:"Home",nav_post:"Post",nav_msgs:"Messages",nav_profile:"Profile",
    post_btn:"Post",
    login_title:"Welcome Back",login_sub:"Sign in to your account",
    google_signin:"Sign in with Google",or:"or",
    email:"Email",password:"Password",sign_in:"Sign In",
    no_account:"Don't have an account?",sign_up_link:"Sign up",
    signup_title:"Create Account",signup_sub:"Join BerlinNest today",
    google_signup:"Sign up with Google",username:"Username",fullname:"Full Name",
    gender_label:"Gender",prefer_not:"Prefer not to say",male:"Male",female:"Female",other:"Other",
    accept_terms:"I accept the Terms & Conditions",create_account:"Create Account",
    have_account:"Already have an account?",sign_in_link:"Sign in",
    post_title:"List Your Apartment",post_sub:"Fill in details to attract great tenants",
    apt_title:"Listing Title",ortsteil:"Ortsteil",apt_type:"Type",apt_share:"Sharing",
    size:"Size (m²)",kaltmiete:"Rent €",warmmiete:"Rent with utilities €",kaution:"Deposit €",
    anmeldung:"Anmeldung",yes:"Yes",no:"No",
    facilities:"Facilities",balcony:"Balcony",elevator:"Elevator",kitchen:"Kitchen",
    dishwasher:"Dishwasher",washer:"Washer",parking:"Parking",garden:"Garden",
    pets:"Pets OK",furnished:"Furnished",cellar:"Cellar",
    description:"Description",photos:"Photos (up to 11)",upload_photos:"Click to upload",
    publish:"Publish Listing",
    edit_post:"Edit Post",edit_post_sub:"Update your listing",
    edit_profile:"Edit Profile",edit_profile_sub:"Customize your profile",
    tap_to_change:"Tap to change photo",bio:"Bio",personal_photos:"Personal Photos",
    save_changes:"Save Changes",
    report_title:"Submit a Report",report_sub:"Reviewed within 24 hours",
    reason:"Reason",select_reason:"Select reason...",
    r_harassment:"Harassment",r_discrimination:"Discrimination",r_fake:"Fake Listing",
    r_spam:"Spam",r_inappropriate:"Inappropriate Content",r_other:"Other",
    details:"Details",submit_report:"Submit Report",
    tab_dms:"Direct",tab_groups:"Groups",new_group:"Group",select_conv:"Select a conversation",
    create_group:"Create Group",create_group_sub:"Start a community chat",
    group_name:"Group Name",group_desc:"Description (optional)",create_group_btn:"Create Group",
    follow:"Follow",following:"Following",edit_profile_btn:"Edit Profile",
    listings_tab:"Listings",photos_tab:"Photos",following_tab:"Following",followers_tab:"Followers",
    contact:"Contact",details_btn:"Details",report:"Report",
    month:"/month",warm:"warm",deposit:"Deposit",
    private:"Private",shared:"Shared",studio:"Studio",
  },
  de: {
    hero_title:"Finden Sie Ihr perfektes Zuhause in Berlin",hero_sub:"Entdecken Sie Wohnungen in allen Stadtteilen",
    search:"Suchen",search_ph:"Stadtteil oder Typ suchen...",
    hs_listings:"Inserate",hs_users:"Nutzer",hs_districts:"Stadtteile",
    section_listings:"Aktuelle Inserate",see_all:"Alle anzeigen",all_neighborhoods:"Alle Gebiete",
    all_prices:"Alle Preise",all_sizes:"Alle Größen",
    nav_home:"Startseite",nav_post:"Inserieren",nav_msgs:"Nachrichten",nav_profile:"Profil",
    post_btn:"Inserieren",
    login_title:"Willkommen zurück",login_sub:"Bei Ihrem Konto anmelden",
    google_signin:"Mit Google anmelden",or:"oder",
    email:"E-Mail",password:"Passwort",sign_in:"Anmelden",
    no_account:"Noch kein Konto?",sign_up_link:"Registrieren",
    signup_title:"Konto erstellen",signup_sub:"Treten Sie BerlinNest bei",
    google_signup:"Mit Google registrieren",username:"Benutzername",fullname:"Vollständiger Name",
    gender_label:"Geschlecht",prefer_not:"Keine Angabe",male:"Männlich",female:"Weiblich",other:"Andere",
    accept_terms:"Ich akzeptiere die AGB",create_account:"Konto erstellen",
    have_account:"Bereits ein Konto?",sign_in_link:"Anmelden",
    post_title:"Wohnung inserieren",post_sub:"Details eingeben",
    apt_title:"Inserat-Titel",ortsteil:"Ortsteil",apt_type:"Typ",apt_share:"Art",
    size:"Größe (m²)",kaltmiete:"Rent €",warmmiete:"Rent with utilities €",kaution:"Deposit €",
    anmeldung:"Anmeldung",yes:"Ja",no:"Nein",
    facilities:"Ausstattung",balcony:"Balkon",elevator:"Aufzug",kitchen:"Küche",
    dishwasher:"Geschirrspüler",washer:"Waschmaschine",parking:"Parkplatz",garden:"Garten",
    pets:"Haustiere OK",furnished:"Möbliert",cellar:"Keller",
    description:"Beschreibung",photos:"Fotos (bis 11)",upload_photos:"Klicken zum Hochladen",
    publish:"Inserat veröffentlichen",
    edit_post:"Beitrag bearbeiten",edit_post_sub:"Ihr Inserat aktualisieren",
    edit_profile:"Profil bearbeiten",edit_profile_sub:"Profil anpassen",
    tap_to_change:"Tippen zum Ändern",bio:"Biografie",personal_photos:"Persönliche Fotos",
    save_changes:"Änderungen speichern",
    report_title:"Meldung einreichen",report_sub:"Wird innerhalb 24h geprüft",
    reason:"Grund",select_reason:"Grund auswählen...",
    r_harassment:"Belästigung",r_discrimination:"Diskriminierung",r_fake:"Gefälschtes Inserat",
    r_spam:"Spam",r_inappropriate:"Unangemessener Inhalt",r_other:"Andere",
    details:"Details",submit_report:"Meldung absenden",
    tab_dms:"Direkt",tab_groups:"Gruppen",new_group:"Gruppe",select_conv:"Gespräch auswählen",
    create_group:"Gruppe erstellen",create_group_sub:"Community-Chat starten",
    group_name:"Gruppenname",group_desc:"Beschreibung (optional)",create_group_btn:"Gruppe erstellen",
    follow:"Folgen",following:"Gefolgt",edit_profile_btn:"Profil bearbeiten",
    listings_tab:"Inserate",photos_tab:"Fotos",following_tab:"Folge ich",followers_tab:"Follower",
    contact:"Kontakt",details_btn:"Details",report:"Melden",
    month:"/Monat",warm:"warm",deposit:"Deposit",
    private:"Privat",shared:"Geteilt",studio:"Studio",
  }
};
let lang = 'en';

function t(k){ return LANG[lang][k] || LANG['en'][k] || k; }

function toggleLang(){
  lang = lang === 'en' ? 'de' : 'en';
  localStorage.setItem('bnLang', lang);
  const btn = document.getElementById('langToggleBtn');
  btn.textContent = lang === 'en' ? '🇬🇧 EN' : '🇩🇪 DE';
  applyLang();
  renderPosts(getAlgoSorted());
  renderConversations();
  updateNav();
}

function setLang(l){
  lang = l;
  localStorage.setItem('bnLang', l);
  const btn = document.getElementById('langToggleBtn');
  if(btn) btn.textContent = l === 'en' ? '🇬🇧 EN' : '🇩🇪 DE';
  applyLang();
  renderPosts(getAlgoSorted());
  renderConversations();
  updateNav();
}

function applyLang(){
  document.querySelectorAll('[data-key]').forEach(el => {
    const k = el.getAttribute('data-key');
    if (k) el.textContent = t(k);
  });
  document.querySelectorAll('[data-key-ph]').forEach(el => {
    const k = el.getAttribute('data-key-ph');
    if (k) el.placeholder = t(k);
  });
}

// ═══════════════════════════════════════
// CONSTANTS + STATE
// ═══════════════════════════════════════
const ADMIN_EMAIL = '963vikram963@gmail.com';
const ADMIN_PASS = 'BerlinNest@Admin2026!';

let currentUser = null;
let currentPage = 'home';
let currentConvId = null;
let currentMsgsTab = 'dms';
let currentReportTarget = null;
let reportTarget = null;
let postImages = [];
let personalPhotos = [];
let editingProfPhoto = null;
let viewTimers = {};

const ORTSTEILE = ['Kreuzberg','Prenzlauer Berg','Friedrichshain','Neukölln','Charlottenburg',
  'Mitte','Wedding','Moabit','Schöneberg','Wilmersdorf','Tempelhof','Steglitz',
  'Pankow','Lichtenberg','Treptow','Köpenick','Spandau','Reinickendorf'];

function randViews(){ return Math.floor(Math.random()*350)+80; }
function randRating(){ return (Math.random()*1.2+3.8).toFixed(1)*1; }
function randDaysAgo(min,max){ return Date.now() - (Math.floor(Math.random()*(max-min)+min)*3600000); }

let STATE = {
  posts: [],
  users: {},
  reports: [],
  bannedUsers: [],
  userWarnings: {},
  conversations: [],
  groups: []
};

function initData(){
  const now = Date.now();
  STATE.posts = [
    {id:1,title:"Bright 2-Zimmer near Görlitzer Park",ortsteil:"Kreuzberg",type:"2-Zimmer",share:"private",size:65,cold:850,warm:950,deposit:2550,floor:3,anmeldung:"yes",desc:"Beautiful apartment with original Altbau details, newly renovated kitchen, and a sunny south-facing balcony. Close to all transport, cafes, and Görlitzer Park.",facilities:["Balcony","Kitchen","Pets OK"],images:[],postedBy:"maria_s",author:"Maria Schmidt",views:randViews(),displayViews:0,rating:4.8,comments:[],createdAt:randDaysAgo(2,4),isRecommended:false,recommendScore:0},
    {id:2,title:"Cozy Studio in Prenzlauer Berg",ortsteil:"Prenzlauer Berg",type:"Studio",share:"studio",size:35,cold:580,warm:680,deposit:1740,floor:2,anmeldung:"yes",desc:"Perfect for students or young professionals. Fully furnished with brand-new appliances. 5 min from Mauerpark.",facilities:["Elevator","Kitchen","Furnished"],images:[],postedBy:"thomas_w",author:"Thomas Weber",views:randViews(),displayViews:0,rating:4.5,comments:[],createdAt:randDaysAgo(4,8),isRecommended:false,recommendScore:0},
    {id:3,title:"Spacious 3-Zimmer Friedrichshain",ortsteil:"Friedrichshain",type:"3-Zimmer",share:"private",size:85,cold:1200,warm:1450,deposit:3600,floor:4,anmeldung:"yes",desc:"Modern apartment near Warschauer Straße with exposed concrete accents, large balcony, and Bosch appliances throughout.",facilities:["Balcony","Elevator","Kitchen","Dishwasher"],images:[],postedBy:"anna_m",author:"Anna Müller",views:randViews(),displayViews:0,rating:5.0,comments:[],createdAt:randDaysAgo(20,30),isRecommended:false,recommendScore:0},
    {id:4,title:"WG-Zimmer near Tempelhofer Feld",ortsteil:"Neukölln",type:"WG-Zimmer",share:"shared",size:20,cold:400,warm:450,deposit:1200,floor:1,anmeldung:"yes",desc:"Friendly 4-person WG in a lively building. Communal garden, high-speed internet. Pets welcome!",facilities:["Garden","Kitchen","Washer","Pets OK"],images:[],postedBy:"leon_f",author:"Leon Fischer",views:randViews(),displayViews:0,rating:4.2,comments:[],createdAt:randDaysAgo(60,90),isRecommended:false,recommendScore:0},
    {id:5,title:"Luxury 4-Zimmer near Ku'damm",ortsteil:"Charlottenburg",type:"4+ Zimmer",share:"private",size:120,cold:1800,warm:2100,deposit:5400,floor:5,anmeldung:"yes",desc:"Exclusive Altbau apartment on the prestigious Kurfürstendamm boulevard. Period features, chef's kitchen, underground parking.",facilities:["Balcony","Elevator","Kitchen","Dishwasher","Parking","Garden"],images:[],postedBy:"sophie_b",author:"Sophie Becker",views:randViews(),displayViews:0,rating:4.9,comments:[],createdAt:randDaysAgo(5,10),isRecommended:false,recommendScore:0},
    {id:6,title:"Modern 1-Zimmer near Alexanderplatz",ortsteil:"Mitte",type:"1-Zimmer",share:"private",size:42,cold:720,warm:820,deposit:2160,floor:6,anmeldung:"yes",desc:"Sleek city-centre apartment with floor-to-ceiling windows. Everything at your doorstep.",facilities:["Elevator","Kitchen"],images:[],postedBy:"max_k",author:"Max Klein",views:randViews(),displayViews:0,rating:4.6,comments:[],createdAt:randDaysAgo(7,14),isRecommended:false,recommendScore:0},
    {id:7,title:"Affordable Studio in Wedding",ortsteil:"Wedding",type:"Studio",share:"studio",size:28,cold:480,warm:550,deposit:1440,floor:2,anmeldung:"yes",desc:"Budget-friendly near U-Bahn Seestraße. Newly painted with modern bathroom.",facilities:["Kitchen"],images:[],postedBy:"lena_s",author:"Lena Schmidt",views:randViews(),displayViews:0,rating:4.3,comments:[],createdAt:randDaysAgo(14,30),isRecommended:false,recommendScore:0},
    {id:8,title:"River View 3-Zimmer Treptow",ortsteil:"Treptow",type:"3-Zimmer",share:"private",size:88,cold:1100,warm:1300,deposit:3300,floor:3,anmeldung:"yes",desc:"Stunning views of the Spree river from every room. Spacious balcony, quiet neighbourhood.",facilities:["Balcony","Kitchen","Parking","Pets OK"],images:[],postedBy:"lisa_w",author:"Lisa Wolf",views:randViews(),displayViews:0,rating:4.7,comments:[],createdAt:randDaysAgo(45,70),isRecommended:false,recommendScore:0},
  ];

  STATE.posts.forEach(p => {
    p.displayViews = p.views;
  });

  STATE.users = {
    maria_s:{username:"maria_s",name:"Maria Schmidt",email:"maria@test.de",photo:null,bio:"Architecture lover & Berlin local 🏛️",personalPhotos:[],posts:1,rating:4.8,reviews:12,followers:[],following:[],isAdmin:false},
    thomas_w:{username:"thomas_w",name:"Thomas Weber",email:"thomas@test.de",photo:null,bio:"Student @ TU Berlin 📚",personalPhotos:[],posts:1,rating:4.5,reviews:8,followers:[],following:[],isAdmin:false},
    anna_m:{username:"anna_m",name:"Anna Müller",email:"anna@test.de",photo:null,bio:"Coffee enthusiast ☕ Kreuzberg is home",personalPhotos:[],posts:1,rating:5.0,reviews:15,followers:[],following:[],isAdmin:false},
  };

  STATE.conversations = [
    {id:'c1',type:'dm',participants:['maria_s','thomas_w'],name:'',messages:[
      {id:'m1',sender:'thomas_w',text:'Hi! Is the studio still available?',time:Date.now()-3600000,type:'text'},
      {id:'m2',sender:'maria_s',text:'Yes it is! Would you like to arrange a viewing?',time:Date.now()-3500000,type:'text'},
    ],lastMsg:'Yes it is!',lastTime:Date.now()-3500000},
  ];

  STATE.groups = [
    {id:'g1',name:'Berlin Renters Forum 🏙️',desc:'Tips & advice for renting in Berlin',creator:'admin',members:['maria_s','thomas_w','anna_m'],messages:[
      {id:'gm1',sender:'thomas_w',text:'Anyone know if Neukölln prices are going up?',time:Date.now()-7200000,type:'text'},
      {id:'gm2',sender:'anna_m',text:'Yes, seen a 15% increase this year 😬',time:Date.now()-7000000,type:'text'},
    ],lastMsg:'Yes, seen a 15% increase',lastTime:Date.now()-7000000},
  ];
}

// ═══════════════════════════════════════
// SMART VIEW ALGORITHM
// ═══════════════════════════════════════
// Rule: 1 real view → displayViews += 2 immediately
//       Then 1 more fake view added after 2 min
//       E.g. 5 real views → +10 display views immediately

function recordRealView(postId){
  const p = STATE.posts.find(x=>x.id===postId);
  if(!p) return;

  p.views++;                    // real view
  p.displayViews += 2;          // instant: 1 real = 2 display

  // Schedule 1 more fake view after 2 minutes (total = 2 per real view)
  if(!viewTimers[postId]) viewTimers[postId] = [];

  const t = setTimeout(()=>{
    const pp = STATE.posts.find(x=>x.id===postId);
    if(pp){ pp.displayViews += 0; softRerenderViews(); } // already counted above
  }, 120000);
  viewTimers[postId].push(t);
}

function softRerenderViews(){
  // Just update view counts without full re-render
  STATE.posts.forEach(p=>{
    const badges = document.querySelectorAll(`.views-badge[data-postid="${p.id}"]`);
    badges.forEach(b=>{ b.innerHTML = `👁 ${formatViews(p.displayViews)}`; });
  });
}

function formatViews(n){
  if(n>=1000) return (n/1000).toFixed(1)+'k';
  return n;
}

// ═══════════════════════════════════════
// RECOMMENDATION ALGORITHM
// ═══════════════════════════════════════
// ═══════════════════════════════════════
// SMART RECOMMENDATION ALGORITHM
// ═══════════════════════════════════════
// 6-factor scoring designed for Berlin rentals:
//
// 1. VIEW VELOCITY  — views per hour (recency-weighted momentum)
// 2. FRESHNESS DECAY — exponential decay so new posts always compete
// 3. ENGAGEMENT SIGNAL — contact clicks + comments = real intent
// 4. USER TRUST SCORE — active users with ratings get a lift
// 5. PRICE COMPETITIVENESS — below-average price for area/type = boost
// 6. COMPLETENESS BONUS — photos + full details = quality signal

function calcScore(post){
  const now = Date.now();
  const ageHours = Math.max(0.1, (now - post.createdAt) / 3600000);
  const ageDays = ageHours / 24;

  // ── 1. VIEW VELOCITY (views per hour, capped to avoid manipulation)
  // A post with 100 views in 2h scores higher than 200 views in 72h
  const rawVelocity = post.views / ageHours;
  const viewVelocity = Math.min(rawVelocity, 50) * 2.5; // cap at 50 v/h, weight 2.5

  // ── 2. FRESHNESS DECAY (exponential — halves every 3 days)
  // Posts under 24h get a strong boost; after 30 days they settle
  let freshness;
  if(ageDays < 0.5)       freshness = 100;                           // first 12h: top slot
  else if(ageDays < 1)    freshness = 85;                            // 12–24h
  else if(ageDays < 3)    freshness = 70 * Math.exp(-0.15 * ageDays); // 1–3 days
  else if(ageDays < 14)   freshness = 55 * Math.exp(-0.08 * ageDays); // week+
  else                    freshness = Math.max(8, 30 * Math.exp(-0.05 * ageDays)); // floor at 8

  // ── 3. ENGAGEMENT SIGNAL (contacts + comments = real interest)
  const engagements = (post.contacts || 0) + (post.comments.length * 2);
  const engagementScore = Math.log1p(engagements) * 8;

  // ── 4. USER TRUST (poster's post count + rating history)
  const posterPosts = STATE.posts.filter(p => p.postedBy === post.postedBy).length;
  const poster = STATE.users[post.postedBy];
  const posterRating = poster ? poster.rating : 4.0;
  const trustScore = (Math.log1p(posterPosts) * 4) + ((posterRating - 3) * 6);

  // ── 5. PRICE COMPETITIVENESS (cheaper than area average = boost)
  const sameCat = STATE.posts.filter(p =>
    p.ortsteil === post.ortsteil && p.type === post.type && p.id !== post.id
  );
  let priceScore = 0;
  if(sameCat.length > 0){
    const avgWarm = sameCat.reduce((s,p) => s + p.warm, 0) / sameCat.length;
    const priceDiff = (avgWarm - post.warm) / avgWarm; // positive = cheaper than avg
    priceScore = Math.max(-5, Math.min(15, priceDiff * 25));
  }

  // ── 6. COMPLETENESS BONUS (photos, description quality, facilities)
  const photoBonus  = Math.min(post.images.length, 6) * 1.5;   // up to 9pts
  const descBonus   = Math.min(post.desc.length / 80, 5);       // up to 5pts (80 chars/pt)
  const facBonus    = Math.min(post.facilities.length, 5) * 1;  // up to 5pts
  const completeness = photoBonus + descBonus + facBonus;

  // ── FINAL SCORE (weighted sum)
  const total = viewVelocity + freshness + engagementScore + trustScore + priceScore + completeness;

  return Math.max(0, total);
}

function getAlgoSorted(){
  const scored = STATE.posts.map(p => ({
    ...p,
    recommendScore: calcScore(p)
  })).sort((a, b) => b.recommendScore - a.recommendScore);

  // Top 3 posts get the Recommended badge
  return scored.map((p, i) => ({ ...p, isRecommended: i < 3 }));
}

// ═══════════════════════════════════════
// RENDER POSTS
// ═══════════════════════════════════════

function renderPosts(list){
  const grid = document.getElementById('postsGrid');
  if(!list || !list.length){
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:3rem;color:var(--text-light);"><div style="font-size:3rem;margin-bottom:1rem;">🔍</div><p>${lang==='en'?'No listings found. Try adjusting your filters.':'Keine Inserate gefunden.'}</p></div>`;
    return;
  }
  grid.innerHTML = list.map(p => renderCard(p)).join('');
}

function renderCard(p){
  const isOwner = currentUser && p.postedBy === currentUser.username;
  const isAdmin = currentUser && currentUser.isAdmin;
  const authorProf = STATE.users[p.postedBy];
  const hasFollowed = currentUser && authorProf && 
    (STATE.users[currentUser.username]?.following || []).includes(p.postedBy);

  const shareLabel = p.share === 'private' ? t('private') : p.share === 'shared' ? t('shared') : t('studio');
  const nebenkosten = p.warm - p.cold;

  return `<div class="pcard" id="card-${p.id}">
    ${p.isRecommended ? `<div class="rec-badge">⭐ ${lang==='en'?'Recommended':'Empfohlen'}</div>` : ''}
    <div class="pcard-images">
      ${p.images&&p.images.length ? 
        `<div class="pcard-img-scroll">${p.images.map(img=>`<img src="${img}" alt="${p.title}">`).join('')}</div>` :
        `<div class="pcard-placeholder">🏠</div>`}
      <div class="type-badge">${p.type}</div>
      <div class="views-badge" data-postid="${p.id}">👁 ${formatViews(p.displayViews)}</div>
    </div>
    <div class="pcard-body">
      <div class="pcard-top">
        <div class="pcard-title" onclick="openPostDetail(${p.id})">${p.title}</div>
        <div class="pcard-rating">⭐ ${p.rating}</div>
      </div>
      <div class="pcard-author">
        <div class="author-ava" onclick="viewUserProfile('${p.postedBy}')">
          ${authorProf&&authorProf.photo ? `<img src="${authorProf.photo}">` : (p.author[0]||'?')}
        </div>
        <span class="author-name" onclick="viewUserProfile('${p.postedBy}')">${p.author}</span>
        <span class="author-location">📍 ${p.ortsteil}</span>
      </div>
      <div class="pcard-details">
        <div class="detail-chip"><div class="dval">${p.size}m²</div><div class="dlbl">${lang==='en'?'Size':'Größe'}</div></div>
        <div class="detail-chip"><div class="dval">${shareLabel}</div><div class="dlbl">${lang==='en'?'Type':'Art'}</div></div>
        <div class="detail-chip"><div class="dval">${p.floor||0}</div><div class="dlbl">${lang==='en'?'Floor':'Etage'}</div></div>
      </div>
      <div class="price-row">
        <span class="price-main">€${p.warm}</span>
        <span class="price-warm">${t('month')} (${t('warm')})</span>
        <span class="price-deposit">💰 €${p.deposit||0} ${t('deposit')}</span>
      </div>
      ${p.facilities&&p.facilities.length ? 
        `<div class="tags-row">${p.facilities.slice(0,5).map(f=>`<span class="tag">${f}</span>`).join('')}</div>` : ''}
      <div class="pcard-desc">${p.desc}</div>
      <div class="pcard-actions">
        ${isOwner ? `
          <button class="btn-edit-post" onclick="openEditPost(${p.id})">✏️ ${lang==='en'?'Edit':'Bearbeiten'}</button>
          <button class="btn-contact" onclick="openContactChat('${p.postedBy}',${p.id})">💬 ${t('contact')}</button>
        ` : `
          <button class="btn-details" onclick="openPostDetail(${p.id})">${t('details_btn')}</button>
          <button class="btn-contact" onclick="openContactChat('${p.postedBy}',${p.id})">💬 ${t('contact')}</button>
          <button class="btn-report-subtle" onclick="openReport(${p.id},'${p.postedBy}')" title="${t('report')}">⚑</button>
        `}
      </div>
      ${isAdmin ? `
        <div class="admin-actions">
          <button class="btn-admin edit" onclick="adminEditPost(${p.id})">✏️ Edit</button>
          <button class="btn-admin del" onclick="adminDeletePost(${p.id})">🗑 Delete</button>
        </div>` : ''}
      <div class="pcard-stats">
        <span>💬 ${p.comments.length}</span>
        <span>⭐ ${p.rating}</span>
        <span>🕐 ${timeAgo(p.createdAt)}</span>
        ${p.anmeldung==='yes' ? `<span>✅ ${lang==='en'?'Anmeldung':'Anmeldung'}</span>` : `<span>❌ ${lang==='en'?'No Anm.':'Keine Anm.'}</span>`}
      </div>
    </div>
  </div>`;
}

function timeAgo(ts){
  const diff = Date.now()-ts, m=60000,h=3600000,d=86400000;
  if(diff<m) return lang==='en'?'just now':'gerade';
  if(diff<h) return Math.floor(diff/m)+(lang==='en'?' min ago':' Min. her');
  if(diff<d) return Math.floor(diff/h)+(lang==='en'?' hr ago':' Std. her');
  if(diff<d*30) return Math.floor(diff/d)+(lang==='en'?' d ago':' Tage her');
  return Math.floor(diff/(d*30))+(lang==='en'?' mo ago':' Mon. her');
}

// ═══════════════════════════════════════
// FILTERS
// ═══════════════════════════════════════
let filterState = { type:'', ortsteil:'', price:'', search:'' };
function clearFilters(){
  filterState = {type:'',ortsteil:'',price:'',search:''};
  document.getElementById('f-ortsteil').value='';
  document.getElementById('f-price').value='';
  document.getElementById('f-type').value='';
  document.getElementById('searchInput').value='';
  renderPosts(getAlgoSorted());
}
function doSearch(){
  filterState.search = document.getElementById('searchInput').value.toLowerCase();
  applyFilters();
}
function applyFilters(){
  filterState.ortsteil = document.getElementById('f-ortsteil').value;
  filterState.price = document.getElementById('f-price').value;
  filterState.type = document.getElementById('f-type').value;
  let list = getAlgoSorted();
  if(filterState.type) list = list.filter(p=>p.type===filterState.type);
  if(filterState.ortsteil) list = list.filter(p=>p.ortsteil===filterState.ortsteil);
  if(filterState.search) list = list.filter(p=>
    p.title.toLowerCase().includes(filterState.search)||
    p.ortsteil.toLowerCase().includes(filterState.search)||
    p.desc.toLowerCase().includes(filterState.search)
  );
  if(filterState.price){
    const [mn,mx]=filterState.price.split('-').map(Number);
    list=list.filter(p=>p.warm>=mn&&p.warm<=mx);
  }
  renderPosts(list);
}

// ═══════════════════════════════════════
// POST DETAIL
// ═══════════════════════════════════════
function openPostDetail(id){
  const p = STATE.posts.find(x=>x.id===id);
  if(!p) return;
  recordRealView(id);
  const nebenkosten = p.warm - p.cold;
  document.getElementById('postDetailContent').innerHTML = `
    <div class="post-detail-gallery">
      ${p.images&&p.images.length ? 
        `<div class="pdg-scroll">${p.images.map(img=>`<img src="${img}">`).join('')}</div>` :
        `<div class="pdg-placeholder">🏠</div>`}
    </div>
    <h2 style="font-size:1.4rem;color:var(--primary);margin-bottom:0.5rem;">${p.title}</h2>
    <div style="display:flex;gap:1rem;color:var(--text-light);font-size:0.85rem;margin-bottom:1.25rem;flex-wrap:wrap;">
      <span>📍 ${p.ortsteil}</span><span>🏠 ${p.type}</span><span>📐 ${p.size}m²</span>
      <span>👁 ${formatViews(p.displayViews)} ${lang==='en'?'views':'Aufrufe'}</span>
    </div>
    <div class="post-detail-price">
      <div class="pdp-main">€${p.warm}<span style="font-size:1rem;font-weight:400;">${t('month')}</span></div>
      <div class="pdp-sub">${lang==='en'?'All inclusive (Rent + utilities)':'Alles inklusive (Miete + Nebenkosten)'}</div>
      <div class="pdp-breakdown">
        <div class="pdp-item"><div class="pdp-val">€${p.cold}</div><div class="pdp-lbl">Rent</div></div>
        <div class="pdp-item"><div class="pdp-val">€${nebenkosten}</div><div class="pdp-lbl">Utilities</div></div>
        <div class="pdp-item"><div class="pdp-val">€${p.deposit||0}</div><div class="pdp-lbl">Deposit</div></div>
      </div>
    </div>
    <div class="post-detail-grid">
      <div class="pdg-item"><div class="icon">🏢</div><div class="val">${p.type}</div><div class="lbl">${lang==='en'?'Apartment Type':'Wohnungstyp'}</div></div>
      <div class="pdg-item"><div class="icon">🔒</div><div class="val">${p.share==='private'?t('private'):p.share==='shared'?t('shared'):t('studio')}</div><div class="lbl">${lang==='en'?'Sharing':'Art'}</div></div>
      <div class="pdg-item"><div class="icon">📐</div><div class="val">${p.size}m²</div><div class="lbl">${lang==='en'?'Size':'Größe'}</div></div>
      <div class="pdg-item"><div class="icon">🏗️</div><div class="val">${lang==='en'?'Floor':'Etage'} ${p.floor||0}</div><div class="lbl">${lang==='en'?'Level':'Ebene'}</div></div>
      <div class="pdg-item"><div class="icon">📋</div><div class="val">${p.anmeldung==='yes'?'✅ '+t('yes'):'❌ '+t('no')}</div><div class="lbl">Anmeldung</div></div>
      <div class="pdg-item"><div class="icon">⭐</div><div class="val">${p.rating}</div><div class="lbl">${lang==='en'?'Rating':'Bewertung'}</div></div>
    </div>
    ${p.facilities&&p.facilities.length ? `
      <div class="section-label">${lang==='en'?'Facilities':'Ausstattung'}</div>
      <div class="tags-row">${p.facilities.map(f=>`<span class="tag">✓ ${f}</span>`).join('')}</div>` : ''}
    <div class="section-label">${lang==='en'?'Description':'Beschreibung'}</div>
    <p style="color:var(--text-mid);font-size:0.9rem;line-height:1.7;margin-bottom:1.25rem;">${p.desc}</p>
    <a class="map-link" href="https://www.google.com/maps/search/${encodeURIComponent(p.ortsteil+' Berlin')}" target="_blank">
      🗺️ ${lang==='en'?'View on Google Maps':'Auf Google Maps ansehen'}
    </a>
    <div style="display:flex;gap:0.75rem;margin-top:1rem;">
      <button class="btn-contact" style="flex:1;" onclick="openContactChat('${p.postedBy}');closeModal('postDetailModal')">💬 ${t('contact')}</button>
      ${currentUser && p.postedBy!==currentUser.username ? 
        `<button class="btn-report-subtle" onclick="openReport(${p.id},'${p.postedBy}')">⚑ ${t('report')}</button>` : ''}
    </div>`;
  openModal('postDetailModal');
}

// ═══════════════════════════════════════
// AUTH
// ═══════════════════════════════════════
function handleGoogleAuth(mode){
  toast(`${lang==='en'?'Google Auth coming soon!':'Google Auth demnächst!'}`);
}

function handleLogin(e){
  e.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const pass = document.getElementById('loginPassword').value;
  const isAdmin = email===ADMIN_EMAIL && pass===ADMIN_PASS;
  let username, name;
  if(isAdmin){ username='Vikram_Nehra'; name='Vikram Nehra'; }
  else { username=email.split('@')[0].replace(/[^a-z0-9_]/gi,'_'); name=username; }
  
  if(!STATE.users[username]){
    STATE.users[username] = {username,name,email,photo:null,bio:'',personalPhotos:[],posts:0,rating:5.0,reviews:0,followers:[],following:[],isAdmin};
  }
  
  currentUser = {...STATE.users[username], isAdmin};
  STATE.users[username].isAdmin = isAdmin;
  localStorage.setItem('bnCurrentUser', JSON.stringify(currentUser));
  closeModal('loginModal');
  updateNav();
  if(isAdmin) toast(`🛡️ Admin login! Welcome ${name}`);
  else toast(`👋 Welcome back, ${name}!`);
}

function handleSignup(e){
  e.preventDefault();
  const username = document.getElementById('signupUser').value;
  const name = document.getElementById('signupName').value;
  const email = document.getElementById('signupEmail').value;
  const pass = document.getElementById('signupPass').value;
  const gender = document.getElementById('signupGender').value;
  if(!document.getElementById('acceptTerms').checked){ toast(lang==='en'?'Accept terms first!':'Bitte AGB akzeptieren!'); return; }
  if(STATE.users[username]){ toast(lang==='en'?'Username taken!':'Benutzername vergeben!'); return; }
  const u = {username,name,email,gender,photo:null,bio:'',personalPhotos:[],posts:0,rating:5.0,reviews:0,followers:[],following:[],isAdmin:false};
  STATE.users[username] = u;
  currentUser = u;
  localStorage.setItem('bnCurrentUser', JSON.stringify(currentUser));
  closeModal('signupModal');
  updateNav();
  toast(`🎉 Welcome to BerlinNest, ${name}!`);
}

function checkUser(input, hintId){
  const v = input.value;
  const hint = document.getElementById(hintId);
  if(!v){ hint.textContent=''; return; }
  if(STATE.users[v] && v!==currentUser?.username){
    const suggs = [v+'_berlin',v+'2024',v+'_'+Math.floor(Math.random()*99)];
    hint.textContent = (lang==='en'?'Taken. Try: ':'Vergeben. Versuche: ')+suggs.join(', ');
    hint.className='username-hint bad';
  } else {
    hint.textContent = lang==='en'?'✓ Available':'✓ Verfügbar';
    hint.className='username-hint ok';
  }
}

// ═══════════════════════════════════════
// POST ACTIONS
// ═══════════════════════════════════════
function handlePostClick(){
  if(!currentUser){ openModal('loginModal'); return; }
  openModal('postModal');
}

function handlePost(e){
  e.preventDefault();
  const facs = [...document.querySelectorAll('.pfac:checked')].map(x=>x.value);
  const newPost = {
    id: STATE.posts.length + Date.now(),
    title: document.getElementById('pTitle').value,
    ortsteil: document.getElementById('pOrtsteil').value,
    type: document.getElementById('pType').value,
    share: document.getElementById('pShare').value,
    size: parseInt(document.getElementById('pSize').value),
    cold: parseInt(document.getElementById('pCold').value),
    warm: parseInt(document.getElementById('pWarm').value),
    deposit: parseInt(document.getElementById('pDeposit').value)||0,
    floor: parseInt(document.getElementById('pFloor').value)||0,
    anmeldung: document.getElementById('pAnmeldung').value,
    facilities: facs,
    desc: document.getElementById('pDesc').value,
    images: [...postImages],
    postedBy: currentUser.username,
    author: currentUser.name,
    views: Math.floor(Math.random()*120)+30, // smart initial random
    displayViews: Math.floor(Math.random()*120)+30,
    rating: 5.0, comments: [],
    createdAt: Date.now(),
    isRecommended: false, recommendScore: 0
  };
  STATE.posts.unshift(newPost);
  if(STATE.users[currentUser.username]) STATE.users[currentUser.username].posts++;
  closeModal('postModal');
  document.getElementById('postModal').querySelector('form').reset();
  postImages=[];
  document.getElementById('pImgPreviews').innerHTML='';
  renderPosts(getAlgoSorted());
  toast(lang==='en'?'🏠 Listing published!':'🏠 Inserat veröffentlicht!');
}

function openEditPost(id){
  const p = STATE.posts.find(x=>x.id===id);
  if(!p) return;
  document.getElementById('editPostId').value=id;
  document.getElementById('eptTitle').value=p.title;
  document.getElementById('eptDesc').value=p.desc;
  document.getElementById('eptWarm').value=p.warm;
  document.getElementById('eptDeposit').value=p.deposit||0;
  openModal('editPostModal');
}

function handleEditPost(e){
  e.preventDefault();
  const id = parseInt(document.getElementById('editPostId').value)||document.getElementById('editPostId').value;
  const p = STATE.posts.find(x=>x.id==id);
  if(!p) return;
  p.title = document.getElementById('eptTitle').value;
  p.desc = document.getElementById('eptDesc').value;
  p.warm = parseInt(document.getElementById('eptWarm').value);
  p.deposit = parseInt(document.getElementById('eptDeposit').value)||0;
  closeModal('editPostModal');
  renderPosts(getAlgoSorted());
  toast(lang==='en'?'✅ Post updated!':'✅ Beitrag aktualisiert!');
}

// ═══════════════════════════════════════
// PROFILE
// ═══════════════════════════════════════
function renderProfile(username){
  const targetUser = username ? STATE.users[username] : (currentUser ? STATE.users[currentUser.username] : null);
  const isOwn = !username || (currentUser && username===currentUser.username);
  const container = document.getElementById('profileContent');
  if(!targetUser || (!currentUser && isOwn)){
    container.innerHTML = `<div style="text-align:center;padding:4rem 1rem;">
      <div style="font-size:4rem;margin-bottom:1rem;">👤</div>
      <h2 style="color:var(--primary);margin-bottom:0.75rem;">${lang==='en'?'Sign in to view your profile':'Anmelden um Profil zu sehen'}</h2>
      <button class="btn-full" style="max-width:280px;margin:0 auto;" onclick="openModal('loginModal')">${t('sign_in')}</button>
    </div>`;
    return;
  }
  
  const userPosts = STATE.posts.filter(p=>p.postedBy===targetUser.username);
  const isFollowing = currentUser && !isOwn && 
    (STATE.users[currentUser.username]?.following||[]).includes(targetUser.username);
  
  container.innerHTML = `
    <div class="profile-hero">
      <div class="profile-ava-wrap">
        <div class="profile-ava" onclick="${isOwn?'openEditProfileModal()':''}">
          ${targetUser.photo ? `<img src="${targetUser.photo}">` : targetUser.name[0].toUpperCase()}
        </div>
      </div>
      <h2 class="profile-name">${targetUser.name}</h2>
      <p class="profile-username">@${targetUser.username} ${targetUser.isAdmin?'<span style="background:var(--danger);color:#fff;padding:2px 8px;border-radius:10px;font-size:.7rem;">ADMIN</span>':''}</p>
      ${targetUser.bio ? `<p class="profile-bio">"${targetUser.bio}"</p>` : ''}
      <div class="profile-stats-row">
        <div class="pstat"><div class="pstat-val">${userPosts.length}</div><div class="pstat-lbl">${t('listings_tab')}</div></div>
        <div class="pstat"><div class="pstat-val">${(targetUser.followers||[]).length}</div><div class="pstat-lbl">${t('followers_tab')}</div></div>
        <div class="pstat"><div class="pstat-val">${(targetUser.following||[]).length}</div><div class="pstat-lbl">${t('following_tab')}</div></div>
        <div class="pstat"><div class="pstat-val">${targetUser.rating}</div><div class="pstat-lbl">Rating</div></div>
      </div>
      <div class="profile-actions">
        ${isOwn ? `
          <button class="btn-edit-profile" onclick="openEditProfileModal()">${t('edit_profile_btn')}</button>
          ${currentUser.isAdmin ? `<button class="btn-admin-portal" onclick="showPage('admin')">🛡️ Admin Panel</button>` : ''}
        ` :
          `<button class="btn-follow ${isFollowing?'following':''}" onclick="toggleFollow('${targetUser.username}')">
            ${isFollowing ? t('following') : t('follow')}
          </button>
          <button class="btn-edit-profile" onclick="openContactChat('${targetUser.username}')">💬 ${t('contact')}</button>`}
      </div>
    </div>
    <div class="profile-tabs">
      <button class="ptab active" id="ptab-listings" onclick="switchProfileTab('listings')">${t('listings_tab')}</button>
      <button class="ptab" id="ptab-photos" onclick="switchProfileTab('photos')">${t('photos_tab')}</button>
      <button class="ptab" id="ptab-following" onclick="switchProfileTab('following')">${t('following_tab')}</button>
      <button class="ptab" id="ptab-followers" onclick="switchProfileTab('followers')">${t('followers_tab')}</button>
    </div>
    <div id="ptab-content-listings" class="ptab-content active">
      <div class="section">
        ${userPosts.length ? 
          `<div class="posts-grid">${userPosts.map(p=>renderCard({...p,recommendScore:calcScore(p),isRecommended:false})).join('')}</div>` :
          `<div style="text-align:center;padding:2rem;color:var(--text-light);">${lang==='en'?'No listings yet':'Noch keine Inserate'}</div>`}
      </div>
    </div>
    <div id="ptab-content-photos" class="ptab-content">
      ${isOwn ? `
        <div class="personal-photos-upload-area" onclick="document.getElementById('profGalleryUpload').click()">
          📸 ${lang==='en'?'Add photos to your gallery':'Fotos zur Galerie hinzufügen'}
        </div>
        <input type="file" id="profGalleryUpload" multiple accept="image/*" style="display:none" onchange="addGalleryPhotos(this)">` : ''}
      ${(targetUser.personalPhotos||[]).length ? 
        `<div class="photos-grid">${(targetUser.personalPhotos).map(ph=>`<div class="photo-item"><img src="${ph}" loading="lazy"></div>`).join('')}</div>` :
        `<div style="text-align:center;padding:2rem;color:var(--text-light);">${lang==='en'?'No photos yet':'Noch keine Fotos'}</div>`}
    </div>
    <div id="ptab-content-following" class="ptab-content">
      <div class="section">
        ${(targetUser.following||[]).length ? 
          targetUser.following.map(un=>{
            const u=STATE.users[un];
            return u?`<div class="conv-item" onclick="viewUserProfile('${un}')">
              <div class="conv-ava">${u.photo?`<img src="${u.photo}">`:u.name[0]}</div>
              <div class="conv-info"><div class="conv-name">${u.name}</div><div class="conv-preview">@${un}</div></div>
            </div>`:'';
          }).join('') :
          `<div style="text-align:center;padding:2rem;color:var(--text-light);">${lang==='en'?'Not following anyone yet':'Folgt noch niemandem'}</div>`}
      </div>
    </div>
    <div id="ptab-content-followers" class="ptab-content">
      <div class="section">
        ${(targetUser.followers||[]).length ? 
          targetUser.followers.map(un=>{
            const u=STATE.users[un];
            return u?`<div class="conv-item" onclick="viewUserProfile('${un}')">
              <div class="conv-ava">${u.photo?`<img src="${u.photo}">`:u.name[0]}</div>
              <div class="conv-info"><div class="conv-name">${u.name}</div><div class="conv-preview">@${un}</div></div>
            </div>`:'';
          }).join('') :
          `<div style="text-align:center;padding:2rem;color:var(--text-light);">${lang==='en'?'No followers yet':'Noch keine Follower'}</div>`}
      </div>
    </div>`;
}

function switchProfileTab(tab){
  document.querySelectorAll('.ptab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.ptab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('ptab-'+tab).classList.add('active');
  document.getElementById('ptab-content-'+tab).classList.add('active');
}

function toggleFollow(username){
  if(!currentUser){ openModal('loginModal'); return; }
  const me = STATE.users[currentUser.username];
  const them = STATE.users[username];
  if(!me||!them) return;
  if(!me.following) me.following=[];
  if(!them.followers) them.followers=[];
  const idx = me.following.indexOf(username);
  if(idx>-1){
    me.following.splice(idx,1);
    them.followers = them.followers.filter(f=>f!==currentUser.username);
    toast(lang==='en'?`Unfollowed ${them.name}`:`${them.name} entfolgt`);
  } else {
    me.following.push(username);
    if(!them.followers.includes(currentUser.username)) them.followers.push(currentUser.username);
    toast(lang==='en'?`Following ${them.name}!`:`Folge jetzt ${them.name}!`);
  }
  renderProfile(username);
}

function openEditProfileModal(){
  if(!currentUser) return;
  const u = STATE.users[currentUser.username];
  document.getElementById('editUser').value=u.username;
  document.getElementById('editName').value=u.name;
  document.getElementById('editBio').value=u.bio||'';
  editingProfPhoto = u.photo;
  const preview = document.getElementById('profPhotoPreview');
  if(u.photo){ preview.innerHTML=`<img src="${u.photo}">`; }
  else { preview.textContent='📷'; }
  personalPhotos = [...(u.personalPhotos||[])];
  renderPersPhotosPreviews();
  openModal('editProfileModal');
}

function handleProfPhoto(input){
  const f=input.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=e=>{
    editingProfPhoto=e.target.result;
    const prev=document.getElementById('profPhotoPreview');
    prev.innerHTML=`<img src="${editingProfPhoto}">`;
  };
  r.readAsDataURL(f);
}

function handlePersPhotos(input){
  [...input.files].forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{ personalPhotos.push(e.target.result); renderPersPhotosPreviews(); };
    r.readAsDataURL(f);
  });
}

function addGalleryPhotos(input){
  [...input.files].forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{
      const u=STATE.users[currentUser.username];
      if(!u.personalPhotos) u.personalPhotos=[];
      u.personalPhotos.push(e.target.result);
      renderProfile();
    };
    r.readAsDataURL(f);
  });
}

function renderPersPhotosPreviews(){
  const c=document.getElementById('persPhotosPreviews');
  if(!c) return;
  c.innerHTML=personalPhotos.map((p,i)=>`
    <div class="img-prev">
      <img src="${p}">
      <div class="img-prev-del" onclick="removePersPhoto(${i})">×</div>
    </div>`).join('');
}

function removePersPhoto(i){ personalPhotos.splice(i,1); renderPersPhotosPreviews(); }

function handleEditProfile(e){
  e.preventDefault();
  const newUser=document.getElementById('editUser').value;
  const newName=document.getElementById('editName').value;
  const newBio=document.getElementById('editBio').value;
  const oldUser=currentUser.username;
  
  if(newUser!==oldUser && STATE.users[newUser]){ toast(lang==='en'?'Username taken!':'Benutzername vergeben!'); return; }
  
  const u=STATE.users[oldUser];
  if(newUser!==oldUser){
    STATE.users[newUser]=u;
    delete STATE.users[oldUser];
    STATE.posts.forEach(p=>{ if(p.postedBy===oldUser){ p.postedBy=newUser; p.author=newName; }});
  }
  u.username=newUser; u.name=newName; u.bio=newBio;
  u.photo=editingProfPhoto;
  u.personalPhotos=[...personalPhotos];
  currentUser={...u};
  saveSession();
  closeModal('editProfileModal');
  updateNav();
  renderProfile();
  toast(lang==='en'?'✅ Profile saved!':'✅ Profil gespeichert!');
}

function viewUserProfile(username){
  const u=STATE.users[username];
  if(!u) return;
  
  if(currentUser && username===currentUser.username){ showPage('profile'); return; }
  
  const isFollowing = currentUser && 
    (STATE.users[currentUser.username]?.following||[]).includes(username);
  const userPosts = STATE.posts.filter(p=>p.postedBy===username);

  document.getElementById('userProfileContent').innerHTML = `
    <div class="uview-hero">
      <div class="uview-ava">
        ${u.photo?`<img src="${u.photo}">`:u.name[0].toUpperCase()}
      </div>
      <h2 class="uview-name">${u.name}</h2>
      <p class="uview-username">@${u.username}</p>
      ${u.bio?`<p class="uview-bio">"${u.bio}"</p>`:''}
      <div class="uview-stats">
        <div class="uview-stat"><strong>${userPosts.length}</strong><span>${t('listings_tab')}</span></div>
        <div class="uview-stat"><strong>${(u.followers||[]).length}</strong><span>${t('followers_tab')}</span></div>
        <div class="uview-stat"><strong>${u.rating}</strong><span>Rating</span></div>
      </div>
    </div>
    <div style="display:flex;gap:0.75rem;margin-bottom:1.25rem;flex-wrap:wrap;">
      ${currentUser ? `
        <button class="btn-follow ${isFollowing?'following':''}" onclick="toggleFollow('${username}');closeModal('userProfileModal');renderProfile();">
          ${isFollowing?t('following'):t('follow')}
        </button>
        <button class="btn-contact" onclick="openContactChat('${username}');closeModal('userProfileModal')">💬 ${t('contact')}</button>
      ` : `<button class="btn-full" onclick="closeModal('userProfileModal');openModal('loginModal')">${t('sign_in')}</button>`}
    </div>
    ${userPosts.length ? `
      <div class="section-label">${t('listings_tab')}</div>
      ${userPosts.slice(0,3).map(p=>`
        <div class="conv-item" style="border-radius:10px;margin-bottom:0.5rem;border:1px solid var(--border);" onclick="openPostDetail(${p.id});closeModal('userProfileModal')">
          <div class="conv-ava" style="background:var(--primary-mid);color:#fff;font-size:1.2rem;border-radius:8px;">🏠</div>
          <div class="conv-info">
            <div class="conv-name">${p.title}</div>
            <div class="conv-preview">📍 ${p.ortsteil} · €${p.warm}${t('month')}</div>
          </div>
        </div>`).join('')}` : ''}
    ${(u.personalPhotos||[]).length ? `
      <div class="section-label" style="margin-top:1.25rem;">${t('photos_tab')}</div>
      <div class="photos-grid">${u.personalPhotos.map(ph=>`<div class="photo-item"><img src="${ph}"></div>`).join('')}</div>` : ''}`;
  
  openModal('userProfileModal');
}

// ═══════════════════════════════════════
// MESSAGING & GROUPS
// ═══════════════════════════════════════
let msgsTab = 'dms';

function switchMsgsTab(tab){
  msgsTab = tab;
  document.getElementById('tab-dms').classList.toggle('active', tab==='dms');
  document.getElementById('tab-groups').classList.toggle('active', tab==='groups');
  renderConversations();
}

function renderConversations(){
  const list = document.getElementById('convList');
  if(!currentUser){ list.innerHTML=`<div style="text-align:center;padding:2rem;color:var(--text-light);"><p>${lang==='en'?'Sign in to message':'Anmelden um zu schreiben'}</p><button class="btn-full" style="max-width:200px;margin:1rem auto 0;" onclick="openModal('loginModal')">${t('sign_in')}</button></div>`; return; }
  
  if(msgsTab==='dms'){
    const dms = STATE.conversations.filter(c=>c.type==='dm'&&c.participants.includes(currentUser.username));
    if(!dms.length){ list.innerHTML=`<div style="text-align:center;padding:2rem;color:var(--text-light);">${lang==='en'?'No messages yet':'Noch keine Nachrichten'}</div>`; return; }
    list.innerHTML = dms.map(c=>{
      const other = c.participants.find(p=>p!==currentUser.username);
      const u = STATE.users[other];
      return `<div class="conv-item ${currentConvId===c.id?'active':''}" onclick="openConv('${c.id}','dm')">
        <div class="conv-ava">${u&&u.photo?`<img src="${u.photo}">`:((u&&u.name[0])||'?')}</div>
        <div class="conv-info"><div class="conv-name">${u?u.name:other}</div><div class="conv-preview">${c.lastMsg||''}</div></div>
        <div class="conv-time">${timeAgo(c.lastTime)}</div>
      </div>`;
    }).join('');
  } else {
    const myGroups = STATE.groups.filter(g=>g.members.includes(currentUser.username));
    if(!myGroups.length){ list.innerHTML=`<div style="text-align:center;padding:2rem;color:var(--text-light);">${lang==='en'?'No groups yet. Create one!':'Noch keine Gruppen.'}<br><button class="btn-full" style="max-width:200px;margin:1rem auto 0;" onclick="openModal('newGroupModal')">${t('create_group_btn')}</button></div>`; return; }
    list.innerHTML = myGroups.map(g=>`
      <div class="conv-item ${currentConvId===g.id?'active':''}" onclick="openConv('${g.id}','group')">
        <div class="conv-ava group">${g.name[0]}</div>
        <div class="conv-info"><div class="conv-name">${g.name}</div><div class="conv-preview">${g.lastMsg||''} · ${g.members.length} members</div></div>
        <div class="conv-time">${timeAgo(g.lastTime||Date.now())}</div>
      </div>`).join('');
  }
}

function openContactChat(username, postId){
  if(!currentUser){ openModal('loginModal'); return; }
  if(username===currentUser.username) return;

  // Track contact as engagement signal on the post
  if(postId){
    const p = STATE.posts.find(x=>x.id==postId);
    if(p){ p.contacts = (p.contacts||0) + 1; }
  }
  
  let conv = STATE.conversations.find(c=>c.type==='dm'&&c.participants.includes(currentUser.username)&&c.participants.includes(username));
  if(!conv){
    conv = {id:'c'+Date.now(),type:'dm',participants:[currentUser.username,username],messages:[],lastMsg:'',lastTime:Date.now()};
    STATE.conversations.push(conv);
  }
  showPage('messages');
  openConv(conv.id,'dm');
}

function openConv(id, type){
  currentConvId = id;
  const isGroup = type==='group';
  const data = isGroup ? STATE.groups.find(g=>g.id===id) : STATE.conversations.find(c=>c.id===id);
  if(!data) return;
  
  const chatView = document.getElementById('chatView');
  const hdrAva = document.getElementById('chatHdrAva');
  const hdrName = document.getElementById('chatHdrName');
  const hdrSub = document.getElementById('chatHdrSub');
  
  if(isGroup){
    hdrAva.textContent = data.name[0];
    hdrAva.style.background = 'var(--accent)';
    hdrName.textContent = data.name;
    hdrSub.textContent = `${data.members.length} ${lang==='en'?'members':'Mitglieder'}`;
  } else {
    const other = data.participants.find(p=>p!==currentUser?.username);
    const u = STATE.users[other];
    hdrAva.innerHTML = u&&u.photo ? `<img src="${u.photo}">` : (u?u.name[0]:'?');
    hdrAva.style.background = 'var(--primary-mid)';
    hdrName.textContent = u ? u.name : other;
    hdrSub.textContent = `@${other}`;
  }
  
  renderChatMsgs(data.messages, isGroup);
  chatView.classList.add('open');
  document.getElementById('chatInput').focus();
  renderConversations();
}

function renderChatMsgs(messages, isGroup){
  const container = document.getElementById('chatMsgs');
  container.innerHTML = messages.map(m=>{
    const isMine = m.sender===currentUser?.username;
    const sender = STATE.users[m.sender];
    return `<div>
      ${isGroup&&!isMine ? `<div class="msg-sender">${sender?sender.name:m.sender}</div>` : ''}
      <div class="msg-bubble ${isMine?'sent':'recv'}">
        ${m.type==='image' ? `<img src="${m.text}" onclick="window.open('${m.text}')">` : m.text}
        <div class="msg-time">${timeAgo(m.time)}</div>
      </div>
    </div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function sendMessage(){
  if(!currentUser) return;
  const text = document.getElementById('chatInput').value.trim();
  if(!text) return;
  
  const isGroup = STATE.groups.find(g=>g.id===currentConvId);
  const data = isGroup || STATE.conversations.find(c=>c.id===currentConvId);
  if(!data) return;
  
  const msg = {id:'m'+Date.now(), sender:currentUser.username, text, time:Date.now(), type:'text'};
  data.messages.push(msg);
  data.lastMsg = text;
  data.lastTime = Date.now();
  
  document.getElementById('chatInput').value='';
  renderChatMsgs(data.messages, !!isGroup);
  renderConversations();
}

function sendChatImage(input){
  if(!currentUser||!input.files[0]) return;
  const r = new FileReader();
  r.onload = e => {
    const isGroup = STATE.groups.find(g=>g.id===currentConvId);
    const data = isGroup || STATE.conversations.find(c=>c.id===currentConvId);
    if(!data) return;
    const msg = {id:'m'+Date.now(), sender:currentUser.username, text:e.target.result, time:Date.now(), type:'image'};
    data.messages.push(msg);
    data.lastMsg = '📷 Photo';
    data.lastTime = Date.now();
    renderChatMsgs(data.messages, !!isGroup);
    renderConversations();
  };
  r.readAsDataURL(input.files[0]);
  input.value='';
}

function handleChatKey(e){ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); } }

function closeChat(){
  document.getElementById('chatView').classList.remove('open');
}

function handleCreateGroup(e){
  e.preventDefault();
  if(!currentUser){ openModal('loginModal'); return; }
  const name = document.getElementById('groupName').value;
  const desc = document.getElementById('groupDesc').value;
  const group = {
    id:'g'+Date.now(), name, desc,
    creator: currentUser.username,
    members:[currentUser.username],
    messages:[], lastMsg:'', lastTime:Date.now()
  };
  STATE.groups.push(group);
  closeModal('newGroupModal');
  document.getElementById('newGroupModal').querySelector('form').reset();
  switchMsgsTab('groups');
  toast(lang==='en'?`Group "${name}" created!`:`Gruppe "${name}" erstellt!`);
}

// ═══════════════════════════════════════
// REPORT
// ═══════════════════════════════════════
function openReport(postId, username){
  if(!currentUser){ openModal('loginModal'); return; }
  reportTarget = {postId, username};
  openModal('reportModal');
}

function handleReport(e){
  e.preventDefault();
  const reason = document.getElementById('reportReason').value;
  const details = document.getElementById('reportDetails').value;
  STATE.reports.push({
    id: STATE.reports.length+1,
    target: reportTarget,
    reason, details,
    reportedBy: currentUser.username,
    time: Date.now(), reviewed: false
  });
  console.log('📧 REPORT EMAIL → 963vikram963@gmail.com', {reason,details,target:reportTarget});
  closeModal('reportModal');
  document.getElementById('reportModal').querySelector('form').reset();
  updateAdminDot();
  toast(lang==='en'?'Report submitted. Admin will review shortly.':'Meldung eingereicht. Admin prüft demnächst.');
}

// ═══════════════════════════════════════
// ADMIN
// ═══════════════════════════════════════
function renderAdminPanel(){
  if(!currentUser || !currentUser.isAdmin){ showPage('home'); return; }

  // ── Stats
  document.getElementById('a-users').textContent = Object.keys(STATE.users).length;
  document.getElementById('a-posts').textContent = STATE.posts.length;
  document.getElementById('a-reports').textContent = STATE.reports.filter(r=>!r.reviewed).length;
  document.getElementById('a-banned').textContent = STATE.bannedUsers.length;

  // ── All Users
  const usersList = document.getElementById('adminUsersList');
  const allUsers = Object.values(STATE.users);
  if(!allUsers.length){
    usersList.innerHTML = `<div style="text-align:center;padding:1.5rem;color:var(--text-light);">No users yet</div>`;
  } else {
    usersList.innerHTML = allUsers.map(u => {
      const isBanned = STATE.bannedUsers.includes(u.username);
      const warnings = STATE.userWarnings[u.username] || 0;
      const userPostCount = STATE.posts.filter(p=>p.postedBy===u.username).length;
      return `<div class="admin-user-card" style="${isBanned?'opacity:.5;border-color:var(--danger);':''}">
        <div class="auc-ava">
          ${u.photo ? `<img src="${u.photo}">` : u.name[0].toUpperCase()}
        </div>
        <div class="auc-info">
          <div class="auc-name">
            ${u.name}
            ${u.isAdmin ? '<span style="background:var(--danger);color:#fff;padding:1px 6px;border-radius:8px;font-size:.65rem;margin-left:4px;">ADMIN</span>' : ''}
            ${isBanned ? '<span style="background:#888;color:#fff;padding:1px 6px;border-radius:8px;font-size:.65rem;margin-left:4px;">BANNED</span>' : ''}
            ${warnings > 0 ? `<span style="background:var(--warn);color:#333;padding:1px 6px;border-radius:8px;font-size:.65rem;margin-left:4px;">⚠️ ${warnings} warn</span>` : ''}
          </div>
          <div class="auc-meta">@${u.username} · ${u.email||''} · ${userPostCount} posts · ⭐ ${u.rating}</div>
        </div>
        <div class="auc-actions">
          ${!isBanned && !u.isAdmin ? `
            <button class="btn-admin-action ba-warn" onclick="adminWarnUser('${u.username}')">⚠️</button>
            <button class="btn-admin-action ba-ban" onclick="adminBanUser('${u.username}')">🚫</button>
          ` : isBanned ? `
            <button class="btn-admin-action ba-dismiss" onclick="adminUnban('${u.username}')">✅ Unban</button>
          ` : ''}
        </div>
      </div>`;
    }).join('');
  }

  // ── Reports
  const reportsList = document.getElementById('adminReportsList');
  if(!STATE.reports.length){
    reportsList.innerHTML = `<div style="text-align:center;padding:1.5rem;color:var(--text-light);">No reports yet — platform is clean ✅</div>`;
  } else {
    reportsList.innerHTML = STATE.reports.map(r=>`
      <div class="report-card ${r.reviewed?'done':''}">
        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
          <strong>#${r.id} · ${r.reason}</strong>
          <span style="font-size:0.78rem;color:var(--text-light);">${timeAgo(r.time)}</span>
        </div>
        <div style="font-size:0.85rem;color:var(--text-mid);">
          <b>Post:</b> #${r.target.postId} &nbsp;<b>Against:</b> @${r.target.username}<br>
          <b>Details:</b> ${r.details}<br>
          <b>Reported by:</b> @${r.reportedBy}
        </div>
        ${!r.reviewed ? `<div class="report-card-actions">
          <button class="btn-admin-action ba-warn" onclick="adminWarn('${r.target.username}',${r.id})">⚠️ Warn</button>
          <button class="btn-admin-action ba-ban" onclick="adminBan('${r.target.username}',${r.id})">🚫 Ban</button>
          <button class="btn-admin-action ba-del" onclick="adminDelPost(${r.target.postId},${r.id})">🗑 Del Post</button>
          <button class="btn-admin-action ba-dismiss" onclick="adminDismiss(${r.id})">✓ Dismiss</button>
        </div>` : `<div style="color:var(--success);font-size:0.82rem;margin-top:0.5rem;">✅ Reviewed</div>`}
      </div>`).join('');
  }

  // ── All Posts
  const postsList = document.getElementById('adminPostsList');
  if(!STATE.posts.length){
    postsList.innerHTML = `<div style="text-align:center;padding:1.5rem;color:var(--text-light);">No posts yet</div>`;
  } else {
    postsList.innerHTML = STATE.posts.map(p=>`
      <div class="admin-post-card">
        <div class="apc-title">${p.title}</div>
        <div class="apc-meta">
          📍 ${p.ortsteil} · €${p.warm}/mo · ${p.type} · 👁 ${formatViews(p.displayViews)} views
          · by @${p.postedBy} · ${timeAgo(p.createdAt)}
        </div>
        <div class="apc-actions">
          <button class="btn-admin-action ba-warn" onclick="adminEditPost(${p.id})">✏️ Edit</button>
          <button class="btn-admin-action ba-del" onclick="adminDeletePost(${p.id})">🗑️ Delete</button>
        </div>
      </div>`).join('');
  }
}

function adminWarnUser(u){ if(!confirm(`Send warning to @${u}?`)) return; STATE.userWarnings[u]=(STATE.userWarnings[u]||0)+1; toast(`⚠️ Warning sent to @${u}`); renderAdminPanel(); }
function adminBanUser(u){ if(!confirm(`Ban @${u} permanently?`)) return; if(!STATE.bannedUsers.includes(u)) STATE.bannedUsers.push(u); toast(`🚫 @${u} has been banned`); renderAdminPanel(); }
function adminUnban(u){ if(!confirm(`Unban @${u}?`)) return; STATE.bannedUsers=STATE.bannedUsers.filter(b=>b!==u); toast(`✅ @${u} unbanned`); renderAdminPanel(); }

function adminWarn(u,rid){ if(!confirm(`Warn @${u}?`)) return; STATE.userWarnings[u]=(STATE.userWarnings[u]||0)+1; toast(`⚠️ Warning sent to @${u}`); reviewReport(rid); }
function adminBan(u,rid){ if(!confirm(`Ban @${u}?`)) return; STATE.bannedUsers.push(u); toast(`🚫 @${u} banned`); reviewReport(rid); }
function adminDelPost(pid,rid){ if(!confirm(`Delete post #${pid}?`)) return; STATE.posts=STATE.posts.filter(p=>p.id!=pid); renderPosts(getAlgoSorted()); toast(`🗑️ Post deleted`); reviewReport(rid); }
function adminDismiss(rid){ reviewReport(rid); toast(lang==='en'?'Report dismissed':'Meldung abgelehnt'); }
function reviewReport(rid){ const r=STATE.reports.find(x=>x.id===rid); if(r) r.reviewed=true; renderAdminPanel(); updateAdminDot(); }
function adminEditPost(id){ openEditPost(id); }
function adminDeletePost(id){ if(!confirm('Delete?')) return; STATE.posts=STATE.posts.filter(p=>p.id!=id); renderPosts(getAlgoSorted()); toast('Deleted'); }

function updateAdminDot(){
  const dot = document.getElementById('adminNotifDot');
  const pending = STATE.reports.filter(r=>!r.reviewed).length;
  if(currentUser?.isAdmin && pending>0){ dot.classList.remove('hidden'); }
  else { dot.classList.add('hidden'); }
}

// ═══════════════════════════════════════
// IMAGE UPLOADS FOR POST
// ═══════════════════════════════════════
function handlePostImgs(input){
  [...input.files].slice(0, 11-postImages.length).forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{ postImages.push(e.target.result); renderPostImgPreviews(); };
    r.readAsDataURL(f);
  });
}
function renderPostImgPreviews(){
  document.getElementById('pImgPreviews').innerHTML = postImages.map((img,i)=>`
    <div class="img-prev"><img src="${img}"><div class="img-prev-del" onclick="removePostImg(${i})">×</div></div>`).join('');
}
function removePostImg(i){ postImages.splice(i,1); renderPostImgPreviews(); }

// ═══════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════
function showPage(page){
  // Deactivate all page divs and bnav buttons
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('active'));

  const pageEl = document.getElementById('page-'+page);
  if(pageEl) pageEl.classList.add('active');

  // Only home and profile are proper bnav-items now
  const bn = document.getElementById('bn-'+page);
  if(bn && bn.classList.contains('bnav-item')) bn.classList.add('active');

  currentPage = page;
  if(page==='profile') renderProfile();
  if(page==='messages') renderConversations();
  if(page==='admin'){
    if(!currentUser||!currentUser.isAdmin){ toast(lang==='en'?'Admin access only':'Nur für Admins'); return; }
    renderAdminPanel();
  }
  window.scrollTo(0,0);
}

function updateNav(){
  const signinBtn = document.getElementById('signinBtn');
  const langBtn = document.getElementById('langToggleBtn');

  if(langBtn) langBtn.textContent = lang==='en' ? '🇬🇧 EN' : '🇩🇪 DE';

  if(currentUser){
    signinBtn.classList.add('hidden');
    if(currentUser.isAdmin) updateAdminDot();
  } else {
    signinBtn.classList.remove('hidden');
    signinBtn.textContent = t('sign_in');
  }
}

// ═══════════════════════════════════════
// MODALS
// ═══════════════════════════════════════
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function switchModal(from,to){ closeModal(from); openModal(to); }

document.addEventListener('click', e=>{
  if(e.target.classList.contains('modal')) e.target.classList.remove('open');
});
document.addEventListener('keydown', e=>{
  if(e.key==='Escape') document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open'));
});

// ═══════════════════════════════════════
// TOAST
// ═══════════════════════════════════════
let toastTimer;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),3000);
}

// ═══════════════════════════════════════
// AUTO REFRESH
// ═══════════════════════════════════════
setInterval(()=>{
  if(currentPage==='home') renderPosts(getAlgoSorted());
},60000); // refresh every minute

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
function init(){
  lang = localStorage.getItem('bnLang') || 'en';
  const btn = document.getElementById('langToggleBtn');
  if(btn) btn.textContent = lang === 'en' ? '🇬🇧 EN' : '🇩🇪 DE';

  initData();

  // ── Restore login session after refresh
  const saved = localStorage.getItem('bnCurrentUser');
  if(saved){
    try {
      const parsed = JSON.parse(saved);
      // Re-link to live STATE.users so profile edits reflect correctly
      if(!STATE.users[parsed.username]){
        STATE.users[parsed.username] = parsed;
      }
      STATE.users[parsed.username].isAdmin = parsed.isAdmin;
      currentUser = {...STATE.users[parsed.username], isAdmin: parsed.isAdmin};
    } catch(e){ localStorage.removeItem('bnCurrentUser'); }
  }

  renderPosts(getAlgoSorted());
  updateNav();
  applyLang();
}

// Also save updated user data when profile is edited
function saveSession(){
  if(currentUser) localStorage.setItem('bnCurrentUser', JSON.stringify(currentUser));
}

init();
</script>
</body>
</html>
