<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<title>BerlinNest</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<style>
:root {
  --primary: #1B4332;
  --primary-mid: #2D6A4F;
  --primary-light: #52B788;
  --accent: #D4A574;
  --accent-dark: #B07D45;
  --bg: #F8F6F1;
  --card: #FFFFFF;
  --text: #1A1A1A;
  --text-mid: #444;
  --text-light: #888;
  --border: #E8E4DC;
  --star: #F4A261;
  --danger: #C1121F;
  --warn: #E9C46A;
  --success: #2D6A4F;
  --shadow: 0 2px 20px rgba(27,67,50,0.08);
  --shadow-lg: 0 8px 40px rgba(27,67,50,0.15);
  --radius: 16px;
  --nav-h: 64px;
  --bottom-h: 72px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:var(--bottom-h);}
h1,h2,h3,.serif{font-family:'DM Serif Display',serif;}
img{max-width:100%;display:block;}
button{font-family:'DM Sans',sans-serif;cursor:pointer;border:none;outline:none;}
input,textarea,select{font-family:'DM Sans',sans-serif;outline:none;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

/* ‚ïê‚ïê‚ïê TOP NAV ‚ïê‚ïê‚ïê */
.topnav{
  position:sticky;top:0;z-index:900;
  background:rgba(248,246,241,0.95);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  height:var(--nav-h);
  display:flex;align-items:center;
  padding:0 1.25rem;gap:1rem;
}
.logo{font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--primary);cursor:pointer;flex-shrink:0;display:flex;align-items:center;gap:0.3rem;}
.logo span{color:var(--accent);}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;}
.topnav-right{margin-left:auto;display:flex;align-items:center;gap:0.75rem;flex-wrap:nowrap;}
.lang-toggle{padding:0.3rem 0.65rem;border:1.5px solid var(--border);border-radius:20px;background:var(--card);font-size:0.82rem;font-weight:600;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:0.25rem;transition:all .2s;flex-shrink:0;white-space:nowrap;}
.lang-toggle:hover{border-color:var(--primary);background:rgba(27,67,50,0.06);}
.btn-msgs-icon{width:36px;height:36px;border-radius:50%;background:var(--bg);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.15rem;cursor:pointer;flex-shrink:0;transition:all .2s;position:relative;}
.btn-msgs-icon:hover{border-color:var(--primary);background:rgba(27,67,50,0.06);}
.msgs-unread-dot{width:8px;height:8px;border-radius:50%;background:var(--danger);position:absolute;top:1px;right:1px;border:2px solid var(--bg);display:none;}
.btn-post{display:none;}
@media(min-width:768px){.btn-post{display:flex;}}
.topnav-avatar{width:36px;height:36px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;cursor:pointer;overflow:hidden;border:2px solid var(--border);transition:border-color .2s;flex-shrink:0;}
.topnav-avatar:hover{border-color:var(--primary);}
.topnav-avatar img{width:100%;height:100%;object-fit:cover;}
.notif-dot{width:8px;height:8px;border-radius:50%;background:var(--danger);position:absolute;top:0;right:0;border:2px solid var(--bg);}
.topnav-avatar-wrap{position:relative;display:inline-block;}
.btn-post{padding:0.5rem 1rem;border-radius:20px;background:var(--primary);color:#fff;font-weight:600;font-size:0.85rem;display:flex;align-items:center;gap:0.4rem;transition:all .2s;flex-shrink:0;}
.btn-post:hover{background:var(--primary-mid);transform:translateY(-1px);}
.btn-sign{padding:0.5rem 1rem;border-radius:20px;background:transparent;color:var(--primary);border:1.5px solid var(--primary);font-weight:600;font-size:0.85rem;transition:all .2s;flex-shrink:0;}
.btn-sign:hover{background:var(--primary);color:#fff;}
.admin-chip{background:var(--danger);color:#fff;padding:0.2rem 0.6rem;border-radius:10px;font-size:0.7rem;font-weight:700;letter-spacing:.5px;flex-shrink:0;}

/* ‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê */
.bottomnav{position:fixed;bottom:0;left:0;right:0;z-index:900;height:var(--bottom-h);background:rgba(255,255,255,0.98);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid rgba(232,228,220,0.8);display:flex;align-items:center;justify-content:space-around;padding:0 1rem;padding-bottom:env(safe-area-inset-bottom);box-shadow:0 -4px 24px rgba(27,67,50,0.06);}
.bnav-item{display:flex;flex-direction:column;align-items:center;gap:0.25rem;cursor:pointer;border-radius:14px;transition:all .22s cubic-bezier(.34,1.56,.64,1);flex:1;max-width:90px;background:transparent;border:none;color:var(--text-light);padding:0.4rem 0.5rem;-webkit-tap-highlight-color:transparent;}
.bnav-item.active{color:var(--primary);}
.bnav-icon{font-size:1.4rem;line-height:1;transition:transform .22s cubic-bezier(.34,1.56,.64,1);}
.bnav-item.active .bnav-icon{transform:scale(1.15);}
.bnav-label{font-size:0.6rem;font-weight:700;letter-spacing:.4px;text-transform:uppercase;white-space:nowrap;opacity:.7;transition:opacity .2s;}
.bnav-item.active .bnav-label{opacity:1;}
.bnav-pip{width:18px;height:3px;border-radius:2px;background:var(--primary);margin-top:1px;transform:scaleX(0);transition:transform .22s cubic-bezier(.34,1.56,.64,1);}
.bnav-item.active .bnav-pip{transform:scaleX(1);}
.bnav-post-wrap{flex:0 0 auto;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;top:-8px;}
.bnav-post-btn{width:58px;height:58px;border-radius:18px;background:linear-gradient(145deg,var(--primary-mid),var(--primary));color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(27,67,50,0.4),0 2px 6px rgba(27,67,50,0.2);transition:all .22s cubic-bezier(.34,1.56,.64,1);-webkit-tap-highlight-color:transparent;position:relative;overflow:hidden;}
.bnav-post-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(145deg,rgba(255,255,255,0.18),transparent);border-radius:inherit;}
.bnav-post-btn:hover{transform:translateY(-3px) scale(1.06);box-shadow:0 10px 28px rgba(27,67,50,0.45),0 4px 10px rgba(27,67,50,0.25);}
.bnav-post-btn:active{transform:translateY(-1px) scale(0.97);}
.bnav-post-icon{font-size:1.8rem;line-height:1;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transition:transform .22s cubic-bezier(.34,1.56,.64,1);}
.bnav-post-btn:hover .bnav-post-icon{transform:translate(-50%,-50%) rotate(90deg);}
.bnav-post-label{font-size:0.6rem;font-weight:700;letter-spacing:.4px;text-transform:uppercase;color:var(--text-light);margin-top:0.35rem;opacity:.7;}

/* ‚ïê‚ïê‚ïê PAGES ‚ïê‚ïê‚ïê */
.page{display:none;min-height:calc(100vh - var(--nav-h) - var(--bottom-h));}
.page.active{display:block;}

/* ‚ïê‚ïê‚ïê HERO ‚ïê‚ïê‚ïê */
.hero{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-mid) 60%,#3A8B6A 100%);padding:2.5rem 1.25rem 3rem;position:relative;overflow:hidden;}
.hero::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;border-radius:50%;background:rgba(255,255,255,0.05);}
.hero::after{content:'';position:absolute;bottom:-60px;left:-20px;width:160px;height:160px;border-radius:50%;background:rgba(212,165,116,0.15);}
.hero h1{color:#fff;font-size:clamp(1.6rem,5vw,2.4rem);line-height:1.2;margin-bottom:0.5rem;}
.hero p{color:rgba(255,255,255,0.75);font-size:0.95rem;margin-bottom:1.5rem;}
.search-wrap{background:#fff;border-radius:14px;display:flex;align-items:center;padding:0.4rem 0.4rem 0.4rem 1rem;box-shadow:0 4px 20px rgba(0,0,0,0.15);gap:0.5rem;}
.search-wrap input{flex:1;border:none;font-size:0.95rem;background:transparent;color:var(--text);}
.search-wrap input::placeholder{color:var(--text-light);}
.search-btn{padding:0.6rem 1.2rem;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;font-size:0.9rem;transition:all .2s;flex-shrink:0;}
.search-btn:hover{background:var(--primary-mid);}
.hero-stats{display:flex;gap:1.5rem;margin-top:1.5rem;}
.hero-stat{color:rgba(255,255,255,0.85);}
.hero-stat strong{display:block;font-size:1.3rem;color:#fff;}
.hero-stat span{font-size:0.75rem;opacity:.7;}

/* ‚ïê‚ïê‚ïê SECTION ‚ïê‚ïê‚ïê */
.section{padding:1.5rem 1.25rem;}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;}
.section-head h2{font-size:1.3rem;color:var(--primary);}
.see-all{font-size:0.85rem;color:var(--primary-mid);font-weight:600;cursor:pointer;}

/* ‚ïê‚ïê‚ïê FILTER BUTTONS ‚ïê‚ïê‚ïê */
.filter-selects{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-bottom:1rem;}
.fsel-btn{
  display:flex;align-items:center;justify-content:space-between;
  padding:0.62rem 0.75rem;
  border:1.5px solid var(--border);border-radius:10px;
  background:var(--card);font-size:0.82rem;color:var(--text);
  font-weight:500;cursor:pointer;transition:all .2s;
  gap:0.3rem;min-width:0;
}
.fsel-btn:hover{border-color:var(--primary);background:rgba(27,67,50,0.04);}
.fsel-btn.active{border-color:var(--primary);background:var(--primary);color:#fff;}
.fsel-btn.active svg path{fill:#fff;}
.fsel-label{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.fsel-btn svg{flex-shrink:0;opacity:.5;}
.fsel-btn.active svg{opacity:1;}

/* ‚ïê‚ïê‚ïê FILTER MODALS ‚ïê‚ïê‚ïê */
.fmodal .modal-box{padding:0;border-radius:var(--radius) var(--radius) 0 0;max-height:80vh;display:flex;flex-direction:column;}
@media(min-width:600px){.fmodal .modal-box{border-radius:var(--radius);max-height:70vh;}}
.fmodal-box{overflow:hidden;}
.fmodal-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:1.1rem 1.25rem 1rem;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.fmodal-title{font-family:'DM Serif Display',serif;font-size:1.15rem;color:var(--primary);}
.fmodal-search-wrap{padding:0.75rem 1.25rem 0.5rem;flex-shrink:0;}
.fmodal-search{
  width:100%;padding:0.55rem 0.9rem;
  border:1.5px solid var(--border);border-radius:10px;
  background:var(--bg);font-size:0.9rem;color:var(--text);
}
.fmodal-search:focus{border-color:var(--primary-light);outline:none;}
.fmodal-list{
  flex:1;overflow-y:auto;
  padding:0.4rem 0.75rem;
}
.fopt{
  display:flex;align-items:center;gap:0.75rem;
  padding:0.75rem 0.5rem;
  border-radius:10px;cursor:pointer;
  transition:background .15s;
  border-bottom:1px solid rgba(232,228,220,0.5);
}
.fopt:last-child{border-bottom:none;}
.fopt:hover{background:rgba(27,67,50,0.04);}
.fopt.selected{background:rgba(27,67,50,0.08);}
.fopt-radio{
  width:20px;height:20px;border-radius:50%;
  border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:all .2s;
}
.fopt.selected .fopt-radio{border-color:var(--primary);background:var(--primary);}
.fopt.selected .fopt-radio::after{content:'';width:8px;height:8px;border-radius:50%;background:#fff;}
.fopt-text{flex:1;}
.fopt-label{font-size:0.92rem;font-weight:500;color:var(--text);}
.fopt-sub{font-size:0.75rem;color:var(--text-light);margin-top:1px;}
.fopt-count{font-size:0.75rem;color:var(--text-light);background:var(--bg);padding:2px 8px;border-radius:20px;flex-shrink:0;}
.fmodal-foot{
  display:flex;gap:0.75rem;
  padding:0.9rem 1.25rem;
  border-top:1px solid var(--border);
  flex-shrink:0;
  background:var(--card);
}
.fmodal-clear{
  flex:1;padding:0.65rem;border-radius:10px;
  background:var(--bg);border:1.5px solid var(--border);
  color:var(--text-mid);font-weight:600;font-size:0.88rem;cursor:pointer;
  transition:all .2s;
}
.fmodal-clear:hover{border-color:var(--danger);color:var(--danger);}
.fmodal-apply{
  flex:2;padding:0.65rem;border-radius:10px;
  background:var(--primary);color:#fff;border:none;
  font-weight:600;font-size:0.88rem;cursor:pointer;
  transition:all .2s;
}
.fmodal-apply:hover{background:var(--primary-mid);}


/* ‚ïê‚ïê‚ïê POST CARD ‚ïê‚ïê‚ïê */
.posts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(min(100%,340px),1fr));gap:1.25rem;}
.feed-counter{text-align:center;font-size:0.82rem;color:var(--text-light);padding:1.5rem 0;grid-column:1/-1;}
.pcard{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:transform .25s,box-shadow .25s;position:relative;}
.pcard:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);}
.pcard-images{position:relative;height:220px;background:linear-gradient(135deg,var(--primary-mid),var(--accent));overflow:hidden;}
.img-track{display:flex;height:100%;transition:transform .35s cubic-bezier(.4,0,.2,1);}
.img-track img{width:100%;height:100%;object-fit:cover;flex-shrink:0;}
.pcard-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:3.5rem;}
.rec-badge{position:absolute;top:0.75rem;left:0.75rem;background:var(--accent);color:#fff;padding:0.3rem 0.65rem;border-radius:20px;font-size:0.72rem;font-weight:700;letter-spacing:.3px;box-shadow:0 2px 8px rgba(0,0,0,0.2);}
.type-badge{position:absolute;top:0.75rem;right:0.75rem;background:rgba(255,255,255,0.92);backdrop-filter:blur(8px);color:var(--primary);padding:0.3rem 0.75rem;border-radius:20px;font-size:0.78rem;font-weight:700;}
.views-badge{position:absolute;bottom:0.75rem;right:0.75rem;background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);color:#fff;padding:0.25rem 0.65rem;border-radius:20px;font-size:0.75rem;display:flex;align-items:center;gap:0.3rem;}
.img-counter{position:absolute;top:0.75rem;left:0.75rem;background:rgba(0,0,0,0.55);color:#fff;font-size:0.72rem;font-weight:600;border-radius:20px;padding:3px 9px;backdrop-filter:blur(6px);}
.img-dots{position:absolute;bottom:0.75rem;left:50%;transform:translateX(-50%);display:flex;gap:4px;}
.img-dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,0.5);cursor:pointer;transition:all .2s;}
.img-dot.active{background:#fff;width:14px;border-radius:3px;}
.img-arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.9);border:none;border-radius:50%;width:32px;height:32px;font-size:1.2rem;color:var(--text);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.2);}
.img-arrow.prev{left:8px;}
.img-arrow.next{right:8px;}
.img-arrow.hidden{display:none;}
.pcard-body{padding:1rem 1.1rem 1.1rem;}
.pcard-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;}
.pcard-title{font-size:1.05rem;font-weight:700;color:var(--primary);line-height:1.3;flex:1;margin-right:0.5rem;cursor:pointer;}
.pcard-title:hover{text-decoration:underline;}
.pcard-rating{display:flex;align-items:center;gap:0.25rem;font-size:0.82rem;font-weight:600;color:var(--star);flex-shrink:0;}
.pcard-author{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;}
.author-ava{width:28px;height:28px;border-radius:50%;background:var(--primary-mid);color:#fff;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;cursor:pointer;overflow:hidden;flex-shrink:0;border:1.5px solid var(--border);}
.author-ava img{width:100%;height:100%;object-fit:cover;}
.author-name{font-size:0.82rem;font-weight:600;color:var(--primary-mid);cursor:pointer;}
.author-name:hover{text-decoration:underline;}
.author-location{font-size:0.78rem;color:var(--text-light);margin-left:auto;}
.pcard-details{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;margin-bottom:0.75rem;}
.detail-chip{background:var(--bg);border-radius:8px;padding:0.4rem 0.5rem;text-align:center;}
.detail-chip .dval{font-size:0.9rem;font-weight:700;color:var(--primary);}
.detail-chip .dlbl{font-size:0.65rem;color:var(--text-light);text-transform:uppercase;letter-spacing:.3px;}
.price-row{display:flex;align-items:baseline;gap:0.5rem;margin-bottom:0.75rem;}
.price-main{font-size:1.3rem;font-weight:700;color:var(--primary);}
.price-warm{font-size:0.8rem;color:var(--text-light);}
.price-deposit{font-size:0.8rem;color:var(--text-mid);margin-left:auto;}
.tags-row{display:flex;flex-wrap:wrap;gap:0.35rem;margin-bottom:0.85rem;}
.tag{background:rgba(27,67,50,0.07);color:var(--primary-mid);padding:0.25rem 0.6rem;border-radius:8px;font-size:0.75rem;font-weight:500;}
.pcard-desc{font-size:0.85rem;color:var(--text-mid);line-height:1.55;margin-bottom:0.9rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.pcard-actions{display:flex;gap:0.5rem;align-items:center;}
.btn-contact{flex:1;padding:0.6rem;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;font-size:0.85rem;transition:all .2s;text-align:center;border:none;}
.btn-contact:hover{background:var(--primary-mid);}
.btn-details{flex:1;padding:0.6rem;border-radius:10px;background:transparent;color:var(--primary);border:1.5px solid var(--primary);font-weight:600;font-size:0.85rem;transition:all .2s;text-align:center;}
.btn-details:hover{background:var(--primary);color:#fff;}
.btn-edit-post{padding:0.6rem 0.9rem;border-radius:10px;background:var(--warn);color:var(--text);font-weight:600;font-size:0.85rem;transition:all .2s;display:flex;align-items:center;gap:0.3rem;border:none;}
.btn-report-subtle{padding:0.5rem;border-radius:8px;background:transparent;color:var(--text-light);font-size:0.8rem;transition:all .2s;border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;gap:0.2rem;}
.btn-report-subtle:hover{color:var(--danger);border-color:var(--danger);}
.admin-actions{display:flex;gap:0.4rem;margin-top:0.6rem;padding-top:0.6rem;border-top:2px dashed rgba(193,18,31,0.3);}
.btn-admin{flex:1;padding:0.5rem;border-radius:8px;font-weight:600;font-size:0.78rem;transition:all .2s;}
.btn-admin.edit{background:var(--warn);color:var(--text);}
.btn-admin.del{background:var(--danger);color:#fff;}

/* skeleton */
.sk-card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);animation:pulse 1.5s infinite;}
.sk-img{height:220px;background:linear-gradient(135deg,#e8e4dc,#d4cfc5);}
.sk-body{padding:1rem;}
.sk-line{height:12px;background:#e8e4dc;border-radius:6px;margin-bottom:10px;}
.sk-line.w80{width:80%;}
.sk-line.w60{width:60%;}
.sk-line.w40{width:40%;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.55}}

/* ‚ïê‚ïê‚ïê PROFILE PAGE ‚ïê‚ïê‚ïê */
.profile-hero{background:linear-gradient(135deg,var(--primary),var(--primary-mid));padding:2rem 1.25rem 1rem;text-align:center;position:relative;}
.profile-ava-wrap{position:relative;display:inline-block;}
.profile-ava{width:100px;height:100px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-family:'DM Serif Display',serif;border:4px solid rgba(255,255,255,0.3);margin:0 auto 0.75rem;overflow:hidden;cursor:pointer;}
.profile-ava img{width:100%;height:100%;object-fit:cover;}
.profile-name{font-size:1.4rem;color:#fff;margin-bottom:0.2rem;}
.profile-username{font-size:0.85rem;color:rgba(255,255,255,0.6);margin-bottom:0.5rem;}
.profile-bio{font-size:0.88rem;color:rgba(255,255,255,0.8);margin:0.5rem auto;max-width:400px;font-style:italic;}
.profile-stats-row{display:flex;justify-content:center;gap:2rem;margin:1rem 0;}
.pstat{text-align:center;color:#fff;}
.pstat-val{font-size:1.3rem;font-weight:700;}
.pstat-lbl{font-size:0.7rem;opacity:.65;text-transform:uppercase;letter-spacing:.5px;}
.profile-actions{display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;padding-bottom:1rem;}
.btn-follow{padding:0.55rem 1.4rem;border-radius:20px;background:var(--accent);color:#fff;font-weight:700;font-size:0.88rem;border:none;transition:all .2s;}
.btn-follow.following{background:transparent;color:#fff;border:1.5px solid rgba(255,255,255,0.5);}
.btn-edit-profile{padding:0.55rem 1.2rem;border-radius:20px;background:rgba(255,255,255,0.15);color:#fff;border:1.5px solid rgba(255,255,255,0.35);font-weight:600;font-size:0.88rem;transition:all .2s;}
.btn-edit-profile:hover{background:rgba(255,255,255,0.25);}
.btn-admin-portal{padding:0.55rem 1.2rem;border-radius:20px;background:rgba(193,18,31,0.18);color:#fff;border:1.5px solid rgba(193,18,31,0.6);font-weight:700;font-size:0.88rem;transition:all .2s;letter-spacing:.3px;}
.btn-admin-portal:hover{background:var(--danger);border-color:var(--danger);}
.profile-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--card);}
.ptab{flex:1;padding:0.9rem;text-align:center;font-weight:600;font-size:0.88rem;color:var(--text-light);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;background:none;border-top:none;border-left:none;border-right:none;}
.ptab.active{color:var(--primary);border-bottom-color:var(--primary);}
.ptab-content{display:none;}
.ptab-content.active{display:block;}
.photos-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;padding:3px;}
.photo-item{aspect-ratio:1;overflow:hidden;cursor:pointer;}
.photo-item img{width:100%;height:100%;object-fit:cover;transition:opacity .2s;}
.photo-item:hover img{opacity:0.85;}
.personal-photos-upload-area{border:2px dashed var(--border);border-radius:12px;padding:2rem;text-align:center;cursor:pointer;transition:all .2s;margin:1rem 1.25rem;}
.personal-photos-upload-area:hover{border-color:var(--primary);background:rgba(27,67,50,0.03);}
.follow-list{padding:1rem 1.25rem;display:flex;flex-direction:column;gap:0.75rem;}
.follow-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--card);border-radius:12px;border:1px solid var(--border);cursor:pointer;}
.follow-ava{width:40px;height:40px;border-radius:50%;background:var(--primary);color:#fff;font-size:1rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* ‚ïê‚ïê‚ïê MESSAGES PAGE ‚ïê‚ïê‚ïê */
.msgs-header{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid var(--border);background:var(--card);position:sticky;top:var(--nav-h);z-index:100;}
.msgs-tabs{display:flex;gap:0.5rem;}
.msgs-tab{padding:0.4rem 0.9rem;border-radius:20px;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all .2s;background:transparent;color:var(--text-light);border:1.5px solid var(--border);}
.msgs-tab.active{background:var(--primary);color:#fff;border-color:var(--primary);}
.btn-new-group{padding:0.4rem 0.8rem;border-radius:20px;background:var(--accent);color:#fff;font-size:0.82rem;font-weight:600;border:none;cursor:pointer;}
.conv-item{display:flex;align-items:center;gap:0.75rem;padding:1rem 1.25rem;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;}
.conv-item:hover{background:rgba(27,67,50,0.03);}
.conv-ava{width:48px;height:48px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;flex-shrink:0;}
.conv-info{flex:1;min-width:0;}
.conv-name{font-weight:700;font-size:0.95rem;margin-bottom:0.2rem;}
.conv-preview{font-size:0.82rem;color:var(--text-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.conv-time{font-size:0.75rem;color:var(--text-light);flex-shrink:0;}
.chat-view{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);}
.chat-view.open{transform:none;}
.chat-header{display:flex;align-items:center;gap:0.75rem;padding:0.9rem 1.25rem;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;}
.chat-back{background:none;border:none;font-size:1.4rem;color:var(--primary);cursor:pointer;padding:0.2rem;}
.chat-hdr-ava{width:38px;height:38px;border-radius:50%;background:var(--primary);color:#fff;font-size:0.95rem;font-weight:700;display:flex;align-items:center;justify-content:center;}
.chat-hdr-info{flex:1;}
.chat-hdr-name{font-weight:700;font-size:0.95rem;}
.chat-hdr-sub{font-size:0.75rem;color:var(--text-light);}
.chat-msgs{flex:1;overflow-y:auto;padding:1.25rem;display:flex;flex-direction:column;gap:0.6rem;}
.msg-row{display:flex;}
.msg-row.mine{justify-content:flex-end;}
.msg-bubble{max-width:75%;padding:0.65rem 0.9rem;border-radius:18px;font-size:0.9rem;line-height:1.45;}
.msg-bubble.sent{background:var(--primary);color:#fff;border-radius:18px 18px 4px 18px;}
.msg-bubble.recv{background:var(--card);border:1px solid var(--border);border-radius:18px 18px 18px 4px;}
.msg-sender{font-size:0.7rem;font-weight:700;opacity:.7;margin-bottom:0.2rem;}
.msg-time{font-size:0.68rem;opacity:.6;margin-top:0.2rem;text-align:right;}
.chat-input-area{display:flex;gap:0.5rem;padding:0.85rem 1.25rem;background:var(--card);border-top:1px solid var(--border);padding-bottom:calc(0.85rem + env(safe-area-inset-bottom));}
.chat-input{flex:1;border:1.5px solid var(--border);border-radius:22px;padding:0.55rem 1rem;resize:none;font-size:0.92rem;max-height:100px;background:var(--bg);}
.chat-input:focus{border-color:var(--primary-light);outline:none;}
.chat-send{background:var(--primary);color:#fff;border:none;border-radius:50%;width:42px;height:42px;font-size:1.1rem;flex-shrink:0;cursor:pointer;}
.chat-img-btn{background:none;border:none;font-size:1.3rem;color:var(--text-light);cursor:pointer;}

/* ‚ïê‚ïê‚ïê ADMIN ‚ïê‚ïê‚ïê */
.admin-topbar{display:flex;align-items:center;gap:0.75rem;padding:1.25rem;border-bottom:2px solid var(--border);}
.admin-back-btn{background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:0.4rem 0.8rem;font-size:0.82rem;color:var(--text-mid);cursor:pointer;}
.admin-title{font-family:'DM Serif Display',serif;font-size:1.3rem;color:var(--primary);}
.admin-badge{background:var(--danger);color:#fff;font-size:0.65rem;font-weight:700;border-radius:20px;padding:2px 8px;margin-left:auto;}
.admin-stats-row{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;padding:1.25rem;}
.astat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;text-align:center;box-shadow:var(--shadow);}
.astat-val{font-family:'DM Serif Display',serif;font-size:1.8rem;color:var(--primary);}
.astat-lbl{font-size:0.68rem;color:var(--text-light);text-transform:uppercase;letter-spacing:.4px;}
.admin-section-head{display:flex;align-items:center;padding:0.75rem 1.25rem;border-bottom:1px solid var(--border);}
.admin-section-head h3{font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--primary);}
.admin-search{width:calc(100% - 2.5rem);margin:0.75rem 1.25rem;padding:0.55rem 0.8rem;border:1.5px solid var(--border);border-radius:10px;font-size:0.85rem;background:var(--card);}
.admin-search:focus{border-color:var(--primary-light);outline:none;}
.admin-user-card{display:flex;align-items:center;gap:0.75rem;padding:0.85rem 1.25rem;border-bottom:1px solid var(--border);background:var(--card);}
.auc-ava{width:38px;height:38px;border-radius:50%;background:var(--primary);color:#fff;font-size:0.9rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;}
.auc-ava img{width:100%;height:100%;object-fit:cover;}
.auc-info{flex:1;min-width:0;}
.auc-name{font-weight:700;font-size:0.85rem;display:flex;align-items:center;flex-wrap:wrap;gap:3px;margin-bottom:2px;}
.auc-meta{font-size:0.72rem;color:var(--text-light);}
.auc-actions{display:flex;gap:0.4rem;flex-shrink:0;}
.btn-admin-action{border:none;border-radius:8px;padding:0.3rem 0.55rem;font-size:0.72rem;font-weight:600;cursor:pointer;}
.ba-warn{background:#FEF3C7;color:#92400E;}
.ba-ban{background:#FEE2E2;color:#991B1B;}
.ba-dismiss{background:#D1FAE5;color:#065F46;}
.ba-del{background:#FEE2E2;color:#991B1B;}
.report-card{margin:0.5rem 1.25rem;background:rgba(27,67,50,0.03);border:1px solid var(--border);border-radius:12px;padding:0.85rem;}
.report-card.done{opacity:.5;}
.report-card-actions{display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.6rem;}
.admin-post-card{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1.25rem;border-bottom:1px solid var(--border);background:var(--card);}
.apc-info{flex:1;min-width:0;}
.apc-title{font-weight:600;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.apc-meta{font-size:0.7rem;color:var(--text-light);margin-top:2px;}
.apc-actions{display:flex;gap:0.4rem;flex-shrink:0;}

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.modal{position:fixed;inset:0;z-index:1100;background:rgba(0,0,0,0.5);display:none;align-items:flex-end;justify-content:center;padding-bottom:env(safe-area-inset-bottom);}
.modal.open{display:flex;}
.modal-box{background:var(--card);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-height:92vh;overflow-y:auto;padding:1.5rem;max-width:520px;position:relative;}
@media(min-width:600px){.modal{align-items:center;}.modal-box{border-radius:var(--radius);max-height:88vh;}}
.modal-box h2{font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--primary);margin-bottom:0.25rem;}
.modal-box>p{font-size:0.85rem;color:var(--text-light);margin-bottom:1rem;}
.mclose{position:absolute;top:1rem;right:1rem;background:var(--bg);border:none;width:32px;height:32px;border-radius:50%;font-size:1rem;color:var(--text-mid);cursor:pointer;display:flex;align-items:center;justify-content:center;}
.form-group{margin-bottom:1rem;}
.form-group label{display:block;font-size:0.82rem;font-weight:600;color:var(--text-mid);margin-bottom:0.35rem;}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:0.65rem 0.8rem;border:1.5px solid var(--border);border-radius:10px;background:var(--card);font-size:0.9rem;color:var(--text);transition:border .2s;}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--primary-light);outline:none;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;}
.username-hint{font-size:0.75rem;margin-top:0.25rem;min-height:1rem;}
.username-hint.ok{color:var(--success);}
.username-hint.bad{color:var(--danger);}
.user-sugg{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:1px 6px;cursor:pointer;margin-left:3px;font-size:0.72rem;}
.user-sugg:hover{background:rgba(27,67,50,0.08);}
.email-hint{font-size:0.78rem;margin-top:0.3rem;min-height:1.1rem;}
.email-hint.ok{color:var(--success);}
.email-hint.bad{color:var(--danger);}
.pass-wrap{position:relative;display:flex;}
.pass-wrap input{flex:1;padding-right:2.8rem;}
.pass-eye{position:absolute;right:0.6rem;top:50%;transform:translateY(-50%);background:none;border:none;font-size:1.1rem;color:var(--text-light);padding:0.2rem;line-height:1;cursor:pointer;}
.terms-scroll{max-height:120px;overflow-y:auto;background:var(--bg);border-radius:10px;padding:0.75rem;font-size:0.78rem;color:var(--text-mid);line-height:1.5;margin-bottom:0.75rem;border:1px solid var(--border);}
.terms-scroll p{margin-bottom:0.4rem;}
.checkbox-line{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;}
.checkbox-line input{width:16px;height:16px;accent-color:var(--primary);}
.checkbox-line label{font-size:0.82rem;color:var(--text-mid);}
.divider-or{text-align:center;margin:0.75rem 0;font-size:0.8rem;color:var(--text-light);position:relative;}
.divider-or::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:var(--border);}
.divider-or span{background:var(--card);padding:0 0.75rem;position:relative;}
.form-link{text-align:center;font-size:0.82rem;color:var(--text-light);margin-top:1rem;}
.form-link a{color:var(--primary-mid);font-weight:600;cursor:pointer;}
.rent-hint{font-size:0.78rem;color:var(--danger);display:none;margin-top:0.3rem;}
.btn-full{width:100%;padding:0.8rem;border-radius:12px;background:var(--primary);color:#fff;border:none;font-size:1rem;font-weight:600;margin-top:0.5rem;cursor:pointer;}
.btn-full:hover{background:var(--primary-mid);}
.btn-google{width:100%;padding:0.7rem;border-radius:12px;background:var(--card);border:1.5px solid var(--border);color:var(--text-mid);font-weight:600;font-size:0.9rem;display:flex;align-items:center;justify-content:center;gap:0.5rem;transition:all .2s;margin-bottom:0.5rem;cursor:pointer;}
.btn-google:hover{border-color:var(--primary);background:rgba(27,67,50,0.03);}
.pfac-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.4rem;}
.pfac-item{display:flex;align-items:center;gap:0.3rem;font-size:0.78rem;color:var(--text-mid);}
.pfac-item input{accent-color:var(--primary);}
.img-prev-wrap{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem;}
.img-prev{position:relative;display:inline-block;}
.img-prev img{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid var(--border);}
.img-prev-del{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;width:18px;height:18px;border-radius:50%;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;border:none;}
.post-detail-price{background:rgba(27,67,50,0.05);border-radius:12px;padding:1rem;margin-bottom:1rem;}
.pdp-main{font-family:'DM Serif Display',serif;font-size:1.8rem;color:var(--primary);}
.pdp-sub{font-size:0.78rem;color:var(--text-light);margin-bottom:0.75rem;}
.pdp-breakdown{display:flex;gap:1.5rem;flex-wrap:wrap;}
.pdp-val{font-size:1rem;font-weight:700;color:var(--primary);}
.pdp-lbl{font-size:0.65rem;color:var(--text-light);}
.post-detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-bottom:1rem;}
.pdg-item{background:var(--bg);border-radius:10px;padding:0.5rem;text-align:center;}
.pdg-item .icon{font-size:1rem;margin-bottom:0.2rem;}
.pdg-item .val{font-size:0.78rem;font-weight:700;}
.pdg-item .lbl{font-size:0.62rem;color:var(--text-light);}
.pdg-scroll{display:flex;gap:0.5rem;overflow-x:auto;scrollbar-width:none;margin-bottom:1rem;}
.pdg-scroll::-webkit-scrollbar{display:none;}
.pdg-scroll img{height:200px;border-radius:12px;flex-shrink:0;}
.map-link{display:flex;align-items:center;gap:0.4rem;color:var(--primary-mid);font-size:0.85rem;font-weight:500;padding:0.6rem;background:var(--bg);border-radius:10px;margin-bottom:0.75rem;}
.section-label{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-light);margin-bottom:0.5rem;}
.personal-gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-top:0.75rem;padding:0 1.25rem 1.25rem;}
.pgal-item{position:relative;border-radius:10px;overflow:hidden;aspect-ratio:1;}
.pgal-item img{width:100%;height:100%;object-fit:cover;cursor:pointer;}
.pgal-del{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.6);color:#fff;width:22px;height:22px;border-radius:50%;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;border:none;}
.photo-upload-area{border:2px dashed var(--border);border-radius:12px;padding:1.5rem;text-align:center;cursor:pointer;color:var(--text-light);margin:0 1.25rem 0.75rem;}
.photo-upload-area:hover{border-color:var(--primary);color:var(--primary);}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
#toast{position:fixed;bottom:calc(var(--bottom-h) + 14px);left:50%;transform:translateX(-50%) translateY(10px);background:var(--text);color:#fff;padding:0.55rem 1.2rem;border-radius:20px;font-size:0.82rem;font-weight:500;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;z-index:2000;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

@media(min-width:768px){.posts-grid{grid-template-columns:repeat(auto-fill,minmax(340px,1fr));}}
</style>
</head>
<body>

<!-- TOP NAV -->
<nav class="topnav">
  <div class="logo" onclick="showPage('home')">
    Berlin<span>Nest</span><div class="logo-dot"></div>
  </div>
  <div class="topnav-right">
    <button class="lang-toggle" id="langToggleBtn" onclick="toggleLang()">üá¨üáß EN</button>
    <button class="btn-msgs-icon" onclick="showPage('messages')">üí¨<div class="msgs-unread-dot" id="msgsUnreadDot"></div></button>
    <button class="btn-sign" id="signinBtn" onclick="openModal('loginModal')">Sign In</button>
  </div>
</nav>

<!-- HOME PAGE -->
<div class="page active" id="page-home">
  <div class="hero">
    <h1>Find Your Perfect<br>Home in Berlin</h1>
    <p>Thousands of verified listings across every Kiez</p>
    <div class="search-wrap">
      <input type="text" id="searchInput" placeholder="Search area, type, keyword‚Ä¶" oninput="doSearch()">
      <button class="search-btn" onclick="doSearch()">Search</button>
    </div>

  </div>
  <div class="section">

    <div class="filter-selects">
      <button class="fsel-btn" id="fbtn-area" onclick="openFilter('area')">
        <span class="fsel-label" id="flbl-area">Areas</span>
        <svg width="10" height="10" viewBox="0 0 10 10"><path fill="currentColor" d="M5 7L0 2h10z"/></svg>
      </button>
      <button class="fsel-btn" id="fbtn-price" onclick="openFilter('price')">
        <span class="fsel-label" id="flbl-price">Price</span>
        <svg width="10" height="10" viewBox="0 0 10 10"><path fill="currentColor" d="M5 7L0 2h10z"/></svg>
      </button>
      <button class="fsel-btn" id="fbtn-type" onclick="openFilter('type')">
        <span class="fsel-label" id="flbl-type">Type</span>
        <svg width="10" height="10" viewBox="0 0 10 10"><path fill="currentColor" d="M5 7L0 2h10z"/></svg>
      </button>
    </div>
    <div class="section-head">
      <h2>Latest Listings</h2>
      <span class="see-all" onclick="clearFilters()">Clear filters</span>
    </div>
    <div class="posts-grid" id="postsGrid"></div>
    <div class="feed-counter" id="feedCounter"></div>
  </div>
</div>

<!-- MESSAGES PAGE -->
<div class="page" id="page-messages">
  <div class="msgs-header">
    <div class="msgs-tabs">
      <button class="msgs-tab active" id="tab-dms" onclick="switchMsgsTab('dms')">üí¨ Direct</button>
      <button class="msgs-tab" id="tab-groups" onclick="switchMsgsTab('groups')">üë• Groups</button>
    </div>
    <button class="btn-new-group" onclick="openModal('newGroupModal')">Ôºã Group</button>
  </div>
  <div id="convList"></div>
</div>

<!-- PROFILE PAGE -->
<div class="page" id="page-profile">
  <div id="profileContent"></div>
</div>

<!-- ADMIN PAGE -->
<div class="page" id="page-admin">
  <div class="admin-topbar">
    <button class="admin-back-btn" onclick="showPage('profile')">‚Üê Back</button>
    <span class="admin-title">üõ°Ô∏è Admin Panel</span>
    <span class="admin-badge">Vikram Only</span>
  </div>
  <div class="admin-stats-row">
    <div class="astat-card"><div class="astat-val" id="a-users">0</div><div class="astat-lbl">Total Users</div></div>
    <div class="astat-card"><div class="astat-val" id="a-posts">0</div><div class="astat-lbl">Total Posts</div></div>
    <div class="astat-card"><div class="astat-val" id="a-reports">0</div><div class="astat-lbl">Pending Reports</div></div>
    <div class="astat-card"><div class="astat-val" id="a-banned">0</div><div class="astat-lbl">Banned Users</div></div>
  </div>
  <div class="admin-section-head"><h3>üë• All Users</h3></div>
  <input class="admin-search" id="adminUserSearch" placeholder="Search users‚Ä¶" oninput="renderAdminPanel()">
  <div id="adminUsersList"></div>
  <div class="admin-section-head" style="margin-top:1rem;"><h3>üìã Reports</h3></div>
  <div id="adminReportsList"></div>
  <div class="admin-section-head" style="margin-top:1rem;"><h3>üè† All Posts</h3></div>
  <input class="admin-search" id="adminPostSearch" placeholder="Search posts‚Ä¶" oninput="renderAdminPanel()">
  <div id="adminPostsList"></div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottomnav">
  <button class="bnav-item active" id="bn-home" onclick="showPage('home')">
    <span class="bnav-icon">üè†</span><span class="bnav-label">Home</span><div class="bnav-pip"></div>
  </button>
  <div class="bnav-post-wrap">
    <button class="bnav-post-btn" onclick="handlePostClick()">
      <span class="bnav-post-icon">Ôºã</span>
    </button>
    <span class="bnav-post-label">Post</span>
  </div>
  <button class="bnav-item" id="bn-profile" onclick="showPage('profile')">
    <span class="bnav-icon">üë§</span><span class="bnav-label">Profile</span><div class="bnav-pip"></div>
  </button>
  <button class="bnav-item" id="bn-admin" onclick="showPage('admin')" style="display:none;">
    <span class="bnav-icon">üõ°Ô∏è</span><span class="bnav-label">Admin</span><div class="bnav-pip"></div>
  </button>
</nav>

<!-- CHAT VIEW -->
<div class="chat-view" id="chatView">
  <div class="chat-header">
    <button class="chat-back" onclick="closeChat()">‚Üê</button>
    <div class="chat-hdr-ava" id="chatHdrAva"></div>
    <div class="chat-hdr-info">
      <div class="chat-hdr-name" id="chatHdrName"></div>
      <div class="chat-hdr-sub" id="chatHdrSub"></div>
    </div>
  </div>
  <div class="chat-msgs" id="chatMsgs"></div>
  <div class="chat-input-area">
    <button class="chat-img-btn" onclick="document.getElementById('chatImgUpload').click()">üì∑</button>
    <input type="file" id="chatImgUpload" accept="image/*" style="display:none" onchange="sendChatImage(this)">
    <textarea class="chat-input" id="chatInput" placeholder="Message‚Ä¶" rows="1" onkeydown="handleChatKey(event)"></textarea>
    <button class="chat-send" onclick="sendMessage()">‚û§</button>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('loginModal')">‚úï</button>
    <h2>Welcome Back</h2>
    <p>Sign in to your BerlinNest account</p>
    <button class="btn-google" onclick="googleLogin()">
      <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
      Continue with Google
    </button>
    <div class="divider-or"><span>or sign in with email</span></div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>Gmail Address</label>
        <input type="email" id="loginEmail" placeholder="you@gmail.com" oninput="validateGmail(this,'loginEmailHint')" required>
        <div class="email-hint" id="loginEmailHint"></div>
      </div>
      <div class="form-group">
        <label>Password</label>
        <div class="pass-wrap">
          <input type="password" id="loginPassword" placeholder="Your password" required>
          <button type="button" class="pass-eye" onclick="togglePass('loginPassword',this)">üëÅ</button>
        </div>
        <div class="email-hint" id="loginPassHint"></div>
      </div>
      <button type="submit" class="btn-full">Sign In</button>
    </form>
    <div class="form-link">No account? <a onclick="switchModal('loginModal','signupModal')">Sign up</a></div>
  </div>
</div>

<!-- SIGNUP MODAL -->
<div class="modal" id="signupModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('signupModal')">‚úï</button>
    <h2>Create Account</h2>
    <p>Join BerlinNest today</p>
    <button class="btn-google" onclick="googleLogin()">
      <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
      Continue with Google
    </button>
    <div class="divider-or"><span>or sign up with email</span></div>
    <form onsubmit="handleSignup(event)">
      <div class="form-row">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="signupUser" placeholder="yourname" oninput="checkUser(this,'suHint')" required>
          <div class="username-hint" id="suHint"></div>
        </div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="signupName" placeholder="Jane Doe" required>
        </div>
      </div>
      <div class="form-group">
        <label>Gmail Address</label>
        <input type="email" id="signupEmail" placeholder="you@gmail.com" oninput="validateGmail(this,'suEmailHint')" required>
        <div class="email-hint" id="suEmailHint"></div>
      </div>
      <div class="form-group">
        <label>Password <span style="color:var(--text-light);font-weight:400;">(min 6 chars)</span></label>
        <div class="pass-wrap">
          <input type="password" id="signupPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
          <button type="button" class="pass-eye" onclick="togglePass('signupPass',this)">üëÅ</button>
        </div>
      </div>
      <div class="form-group">
        <label>Gender <span style="color:var(--text-light);font-weight:400;">(Optional)</span></label>
        <select id="signupGender"><option value="">Prefer not to say</option><option value="m">Male</option><option value="f">Female</option><option value="o">Other</option></select>
      </div>
      <div class="terms-scroll">
        <p><strong>1. Zero Harassment.</strong> Violations result in immediate account termination.</p>
        <p><strong>2. No Discrimination.</strong> Based on gender, race, religion, nationality, or sexual orientation.</p>
        <p><strong>3. Accurate Listings.</strong> All apartment information must be truthful and current.</p>
        <p><strong>4. Privacy.</strong> Your personal data is never shared publicly.</p>
        <p><strong>5. Safety.</strong> Report suspicious activity immediately.</p>
        <p><strong>6. Content.</strong> No explicit, offensive, or fraudulent content.</p>
        <p><strong>7. Fair Use.</strong> No scraping, spamming, or automated access.</p>
      </div>
      <div class="checkbox-line"><input type="checkbox" id="acceptTerms" required><label for="acceptTerms">I accept the Terms & Conditions</label></div>
      <button type="submit" class="btn-full">Create Account</button>
    </form>
    <div class="form-link">Already registered? <a onclick="switchModal('signupModal','loginModal')">Sign in</a></div>
  </div>
</div>

<!-- POST MODAL -->
<div class="modal" id="postModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('postModal')">‚úï</button>
    <h2>üè† New Listing</h2>
    <form onsubmit="handlePost(event)">
      <div class="form-group"><label>Title</label><input type="text" id="pTitle" placeholder="e.g. Bright 2-room near G√∂rlitzer Park" required></div>
      <div class="form-row">
        <div class="form-group"><label>District</label><select id="pOrtsteil" required><option value="">Select‚Ä¶</option><option>Kreuzberg</option><option>Prenzlauer Berg</option><option>Friedrichshain</option><option>Neuk√∂lln</option><option>Charlottenburg</option><option>Mitte</option><option>Wedding</option><option>Moabit</option><option>Sch√∂neberg</option><option>Wilmersdorf</option><option>Tempelhof</option><option>Steglitz</option><option>Pankow</option><option>Lichtenberg</option><option>Treptow</option><option>K√∂penick</option><option>Spandau</option><option>Reinickendorf</option></select></div>
        <div class="form-group"><label>Type</label><select id="pType" required><option value="">Select‚Ä¶</option><option>Studio</option><option>1-Zimmer</option><option>2-Zimmer</option><option>3-Zimmer</option><option>4+ Zimmer</option><option>WG-Zimmer</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Sharing</label><select id="pShare"><option value="private">Private</option><option value="shared">Shared</option><option value="studio">Studio</option></select></div>
        <div class="form-group"><label>Size m¬≤ (optional)</label><input type="number" id="pSize" placeholder="e.g. 60"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Rent cold ‚Ç¨</label><input type="number" id="pCold" placeholder="e.g. 850"></div>
        <div class="form-group"><label>Rent warm ‚Ç¨</label><input type="number" id="pWarm" placeholder="e.g. 980"></div>
      </div>
      <div class="rent-hint" id="rentHint">‚ö†Ô∏è Enter at least one rent amount</div>
      <div class="form-row">
        <div class="form-group"><label>Deposit ‚Ç¨</label><input type="number" id="pDeposit" placeholder="e.g. 2400"></div>
        <div class="form-group"><label>Floor</label><input type="number" id="pFloor" placeholder="e.g. 3"></div>
      </div>
      <div class="form-group"><label>Anmeldung?</label><select id="pAnmeldung"><option value="yes">Yes</option><option value="no">No</option><option value="ask">Ask landlord</option></select></div>
      <div class="form-group">
        <label>Facilities</label>
        <div class="pfac-grid">
          <label class="pfac-item"><input type="checkbox" class="pfac" value="Balcony"> Balcony</label>
          <label class="pfac-item"><input type="checkbox" class="pfac" value="Elevator"> Elevator</label>
          <label class="pfac-item"><input type="checkbox" class="pfac" value="Kitchen"> Kitchen</label>
          <label class="pfac-item"><input type="checkbox" class="pfac" value="Furnished"> Furnished</label>
          <label class="pfac-item"><input type="checkbox" class="pfac" value="Parking"> Parking</label>
          <label class="pfac-item"><input type="checkbox" class="pfac" value="Garden"> Garden</label>
          <label class="pfac-item"><input type="checkbox" class="pfac" value="Washer"> Washer</label>
          <label class="pfac-item"><input type="checkbox" class="pfac" value="Dishwasher"> Dishwasher</label>
          <label class="pfac-item"><input type="checkbox" class="pfac" value="Pets OK"> Pets OK</label>
        </div>
      </div>
      <div class="form-group"><label>Description</label><textarea id="pDesc" rows="3" placeholder="Describe the apartment‚Ä¶"></textarea></div>
      <div class="form-group"><label>Photos (up to 11)</label><input type="file" accept="image/*" multiple onchange="handlePostImgs(this)"><div class="img-prev-wrap" id="pImgPreviews"></div></div>
      <button type="submit" class="btn-full">üè† Publish Listing</button>
    </form>
  </div>
</div>

<!-- EDIT POST MODAL -->
<div class="modal" id="editPostModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('editPostModal')">‚úï</button>
    <h2>‚úèÔ∏è Edit Listing</h2>
    <input type="hidden" id="editPostId">
    <form onsubmit="handleEditPost(event)">
      <div class="form-group"><label>Title</label><input type="text" id="eptTitle" required></div>
      <div class="form-group"><label>Description</label><textarea id="eptDesc" rows="3"></textarea></div>
      <div class="form-row">
        <div class="form-group"><label>Rent warm ‚Ç¨</label><input type="number" id="eptWarm"></div>
        <div class="form-group"><label>Deposit ‚Ç¨</label><input type="number" id="eptDeposit"></div>
      </div>
      <button type="submit" class="btn-full">Save Changes</button>
    </form>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal" id="editProfileModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('editProfileModal')">‚úï</button>
    <h2>Edit Profile</h2>
    <div style="text-align:center;margin-bottom:1rem;">
      <div id="profPhotoPreview" class="profile-ava" style="margin:0 auto;cursor:pointer;" onclick="document.getElementById('profPhotoInput').click()"></div>
      <input type="file" id="profPhotoInput" accept="image/*" style="display:none" onchange="handleProfPhotoUpload(this)">
      <p style="font-size:.75rem;color:var(--text-light);margin-top:.3rem;">Tap to change photo</p>
    </div>
    <form onsubmit="handleEditProfile(event)">
      <div class="form-row">
        <div class="form-group"><label>Username</label><input type="text" id="epUsername" oninput="checkUser(this,'epUserHint')" required><div class="username-hint" id="epUserHint"></div></div>
        <div class="form-group"><label>Full Name</label><input type="text" id="epName" required></div>
      </div>
      <div class="form-group"><label>Bio</label><textarea id="epBio" rows="2" placeholder="Tell people about yourself‚Ä¶"></textarea></div>
      <button type="submit" class="btn-full">Save Profile</button>
    </form>
  </div>
</div>

<!-- POST DETAIL MODAL -->
<div class="modal" id="postDetailModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('postDetailModal')">‚úï</button>
    <div id="postDetailContent"></div>
  </div>
</div>

<!-- REPORT MODAL -->
<div class="modal" id="reportModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('reportModal')">‚úï</button>
    <h2>‚öë Report Listing</h2>
    <p>This goes directly to the admin</p>
    <form onsubmit="handleReport(event)">
      <div class="form-group"><label>Reason</label><select id="reportReason" required><option value="">Select‚Ä¶</option><option>Fake listing</option><option>Scam / fraud</option><option>Discrimination</option><option>Harassment</option><option>Inaccurate info</option><option>Other</option></select></div>
      <div class="form-group"><label>Details</label><textarea id="reportDetails" rows="3" placeholder="Describe the issue‚Ä¶"></textarea></div>
      <button type="submit" class="btn-full" style="background:var(--danger);">Submit Report</button>
    </form>
  </div>
</div>

<!-- NEW GROUP MODAL -->
<div class="modal" id="newGroupModal">
  <div class="modal-box">
    <button class="mclose" onclick="closeModal('newGroupModal')">‚úï</button>
    <h2>üë• New Group</h2>
    <form onsubmit="handleCreateGroup(event)">
      <div class="form-group"><label>Group Name</label><input type="text" id="groupName" placeholder="e.g. Berlin Renters 2025" required></div>
      <div class="form-group"><label>Description</label><textarea id="groupDesc" rows="2" placeholder="What is this group about?"></textarea></div>
      <button type="submit" class="btn-full">Create Group</button>
    </form>
  </div>
</div>

<!-- FILTER MODAL: AREA -->
<div class="modal fmodal" id="filterAreaModal">
  <div class="modal-box fmodal-box">
    <div class="fmodal-head">
      <span class="fmodal-title">üìç Select Area</span>
      <button class="mclose" onclick="closeFilter('area')">‚úï</button>
    </div>
    <div class="fmodal-search-wrap">
      <input class="fmodal-search" id="areaSearch" placeholder="Search district‚Ä¶" oninput="filterAreaList(this.value)">
    </div>
    <div class="fmodal-list" id="areaList"></div>
    <div class="fmodal-foot">
      <button class="fmodal-clear" onclick="clearFilter('area')">Clear</button>
      <button class="fmodal-apply" onclick="closeFilter('area')">Apply</button>
    </div>
  </div>
</div>

<!-- FILTER MODAL: PRICE -->
<div class="modal fmodal" id="filterPriceModal">
  <div class="modal-box fmodal-box">
    <div class="fmodal-head">
      <span class="fmodal-title">üí∂ Select Price Range</span>
      <button class="mclose" onclick="closeFilter('price')">‚úï</button>
    </div>
    <div class="fmodal-list" id="priceList"></div>
    <div class="fmodal-foot">
      <button class="fmodal-clear" onclick="clearFilter('price')">Clear</button>
      <button class="fmodal-apply" onclick="closeFilter('price')">Apply</button>
    </div>
  </div>
</div>

<!-- FILTER MODAL: TYPE -->
<div class="modal fmodal" id="filterTypeModal">
  <div class="modal-box fmodal-box">
    <div class="fmodal-head">
      <span class="fmodal-title">üè† Select Type</span>
      <button class="mclose" onclick="closeFilter('type')">‚úï</button>
    </div>
    <div class="fmodal-list" id="typeList"></div>
    <div class="fmodal-foot">
      <button class="fmodal-clear" onclick="clearFilter('type')">Clear</button>
      <button class="fmodal-apply" onclick="closeFilter('type')">Apply</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BerlinNest v16 ‚Äî Your UI, v15 logic, unchanged
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const ADMIN_EMAIL = '963vikram963@gmail.com';
const ADMIN_PASS  = 'BerlinNest@Admin2026!';
const DB_KEY      = 'bndb_v14';
const SESS_KEY    = 'bndb_sess';

let currentUser    = null;
let currentPage    = 'home';
let currentConvId  = null;
let currentMsgsTab = 'dms';
let reportTarget   = null;
let postImages     = [];
let personalPhotos = [];
let editingProfPhoto = null;
let filterState    = {type:'',ortsteil:'',price:'',share:'',search:''};
let feedPage       = 0;
let feedAll        = [];
const PAGE_SIZE    = 20;
let lang           = 'en';

let DB = {
  posts:[], users:{}, conversations:[],
  groups:[], reports:[], bannedUsers:[], userWarnings:{}
};

// ‚îÄ‚îÄ PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveDB(){try{localStorage.setItem(DB_KEY,JSON.stringify(DB));}catch(e){console.warn('saveDB:',e);}}
function loadDB(){
  try{
    const raw=localStorage.getItem(DB_KEY);if(!raw)return false;
    const d=JSON.parse(raw);
    if(Array.isArray(d.posts))DB.posts=d.posts;
    if(d.users&&typeof d.users==='object')DB.users=d.users;
    if(Array.isArray(d.conversations))DB.conversations=d.conversations;
    if(Array.isArray(d.groups))DB.groups=d.groups;
    if(Array.isArray(d.reports))DB.reports=d.reports;
    if(Array.isArray(d.bannedUsers))DB.bannedUsers=d.bannedUsers;
    if(d.userWarnings)DB.userWarnings=d.userWarnings;
    return true;
  }catch(e){return false;}
}
function seedOnce(){
  if(DB.posts.length>0)return;
  function rV(){return Math.floor(Math.random()*350)+80;}
  function rD(a,b){return Date.now()-(Math.floor(Math.random()*(b-a)+a)*3600000);}
  DB.posts=[
    {id:1,title:"Bright 2-Zimmer Near G√∂rlitzer Park",ortsteil:"Kreuzberg",type:"2-Zimmer",share:"private",size:65,cold:850,warm:950,deposit:2550,floor:3,anmeldung:"yes",desc:"Beautiful apartment with original Altbau details, newly renovated kitchen, and a sunny south-facing balcony.",facilities:["Balcony","Kitchen","Pets OK"],images:[],postedBy:"maria_s",author:"Maria Schmidt",views:rV(),displayViews:0,contacts:0,rating:4.8,comments:[],createdAt:rD(2,4),isRecommended:false,recommendScore:0},
    {id:2,title:"Cozy Studio In Prenzlauer Berg",ortsteil:"Prenzlauer Berg",type:"Studio",share:"studio",size:35,cold:580,warm:680,deposit:1740,floor:2,anmeldung:"yes",desc:"Perfect for students or young professionals. Fully furnished with brand-new appliances. 5 min from Mauerpark.",facilities:["Elevator","Kitchen","Furnished"],images:[],postedBy:"thomas_w",author:"Thomas Weber",views:rV(),displayViews:0,contacts:0,rating:4.5,comments:[],createdAt:rD(4,8),isRecommended:false,recommendScore:0},
    {id:3,title:"Spacious 3-Zimmer Friedrichshain",ortsteil:"Friedrichshain",type:"3-Zimmer",share:"private",size:85,cold:1200,warm:1450,deposit:3600,floor:4,anmeldung:"yes",desc:"Modern apartment near Warschauer Stra√üe with exposed concrete accents, large balcony, and Bosch appliances.",facilities:["Balcony","Elevator","Kitchen","Dishwasher"],images:[],postedBy:"anna_m",author:"Anna M√ºller",views:rV(),displayViews:0,contacts:0,rating:5.0,comments:[],createdAt:rD(20,30),isRecommended:false,recommendScore:0},
    {id:4,title:"WG-Zimmer Near Tempelhofer Feld",ortsteil:"Neuk√∂lln",type:"WG-Zimmer",share:"shared",size:20,cold:400,warm:450,deposit:1200,floor:1,anmeldung:"yes",desc:"Friendly 4-person WG in a lively building. Communal garden, high-speed internet. Pets welcome!",facilities:["Garden","Kitchen","Washer","Pets OK"],images:[],postedBy:"leon_f",author:"Leon Fischer",views:rV(),displayViews:0,contacts:0,rating:4.2,comments:[],createdAt:rD(60,90),isRecommended:false,recommendScore:0},
    {id:5,title:"Luxury 4-Zimmer Near Ku'damm",ortsteil:"Charlottenburg",type:"4+ Zimmer",share:"private",size:120,cold:1800,warm:2100,deposit:5400,floor:5,anmeldung:"yes",desc:"Exclusive Altbau apartment on the prestigious Kurf√ºrstendamm boulevard. Period features, chef's kitchen.",facilities:["Balcony","Elevator","Kitchen","Dishwasher","Parking","Garden"],images:[],postedBy:"sophie_b",author:"Sophie Becker",views:rV(),displayViews:0,contacts:0,rating:4.9,comments:[],createdAt:rD(5,10),isRecommended:false,recommendScore:0},
    {id:6,title:"Modern 1-Zimmer Near Alexanderplatz",ortsteil:"Mitte",type:"1-Zimmer",share:"private",size:42,cold:720,warm:820,deposit:2160,floor:6,anmeldung:"yes",desc:"Sleek city-centre apartment with floor-to-ceiling windows. Everything at your doorstep.",facilities:["Elevator","Kitchen"],images:[],postedBy:"max_k",author:"Max Klein",views:rV(),displayViews:0,contacts:0,rating:4.6,comments:[],createdAt:rD(7,14),isRecommended:false,recommendScore:0},
    {id:7,title:"Affordable Studio In Wedding",ortsteil:"Wedding",type:"Studio",share:"studio",size:28,cold:480,warm:550,deposit:1440,floor:2,anmeldung:"yes",desc:"Budget-friendly near U-Bahn Seestra√üe. Newly painted with modern bathroom.",facilities:["Kitchen"],images:[],postedBy:"lena_s",author:"Lena Schmidt",views:rV(),displayViews:0,contacts:0,rating:4.3,comments:[],createdAt:rD(14,30),isRecommended:false,recommendScore:0},
    {id:8,title:"River View 3-Zimmer Treptow",ortsteil:"Treptow",type:"3-Zimmer",share:"private",size:88,cold:1100,warm:1300,deposit:3300,floor:3,anmeldung:"yes",desc:"Stunning views of the Spree river from every room. Spacious balcony, quiet neighbourhood.",facilities:["Balcony","Kitchen","Parking","Pets OK"],images:[],postedBy:"lisa_w",author:"Lisa Wolf",views:rV(),displayViews:0,contacts:0,rating:4.7,comments:[],createdAt:rD(45,70),isRecommended:false,recommendScore:0},
  ];
  DB.posts.forEach(p=>p.displayViews=p.views);
  DB.users={
    maria_s:{username:"maria_s",name:"Maria Schmidt",email:"maria@gmail.com",_ph:"",photo:null,bio:"Architecture lover & Berlin local üèõÔ∏è",personalPhotos:[],posts:1,rating:4.8,reviews:12,followers:[],following:[],isAdmin:false},
    thomas_w:{username:"thomas_w",name:"Thomas Weber",email:"thomas@gmail.com",_ph:"",photo:null,bio:"Student @ TU Berlin üìö",personalPhotos:[],posts:1,rating:4.5,reviews:8,followers:[],following:[],isAdmin:false},
    anna_m:{username:"anna_m",name:"Anna M√ºller",email:"anna@gmail.com",_ph:"",photo:null,bio:"Coffee enthusiast ‚òï",personalPhotos:[],posts:1,rating:5.0,reviews:15,followers:[],following:[],isAdmin:false},
    leon_f:{username:"leon_f",name:"Leon Fischer",email:"leon@gmail.com",_ph:"",photo:null,bio:"",personalPhotos:[],posts:1,rating:4.2,reviews:3,followers:[],following:[],isAdmin:false},
    sophie_b:{username:"sophie_b",name:"Sophie Becker",email:"sophie@gmail.com",_ph:"",photo:null,bio:"",personalPhotos:[],posts:1,rating:4.9,reviews:20,followers:[],following:[],isAdmin:false},
    max_k:{username:"max_k",name:"Max Klein",email:"max@gmail.com",_ph:"",photo:null,bio:"",personalPhotos:[],posts:1,rating:4.6,reviews:7,followers:[],following:[],isAdmin:false},
    lena_s:{username:"lena_s",name:"Lena Schmidt",email:"lena@gmail.com",_ph:"",photo:null,bio:"",personalPhotos:[],posts:1,rating:4.3,reviews:5,followers:[],following:[],isAdmin:false},
    lisa_w:{username:"lisa_w",name:"Lisa Wolf",email:"lisa@gmail.com",_ph:"",photo:null,bio:"",personalPhotos:[],posts:1,rating:4.7,reviews:9,followers:[],following:[],isAdmin:false},
  };
  DB.conversations=[{id:'c1',participants:['maria_s','thomas_w'],messages:[{id:'m1',sender:'thomas_w',text:'Hi! Is the studio still available?',time:Date.now()-3600000,type:'text'},{id:'m2',sender:'maria_s',text:'Yes it is! Would you like to arrange a viewing?',time:Date.now()-3500000,type:'text'}],lastMsg:'Yes it is!',lastTime:Date.now()-3500000}];
  DB.groups=[{id:'g1',name:'Berlin Renters Forum üèôÔ∏è',desc:'Tips & advice for renting in Berlin',creator:'admin',members:['maria_s','thomas_w','anna_m'],messages:[{id:'gm1',sender:'thomas_w',text:'Anyone know if Neuk√∂lln prices are going up?',time:Date.now()-7200000,type:'text'},{id:'gm2',sender:'anna_m',text:'Yes, seen a 15% increase this year üò¨',time:Date.now()-7000000,type:'text'}],lastMsg:'Yes, seen a 15% increase',lastTime:Date.now()-7000000}];
  saveDB();
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isGmail(e){return /^[a-zA-Z0-9._%+\-]+@gmail\.com$/i.test((e||'').trim());}
async function hashPass(p){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(p));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
function validateGmail(input,hintId){const h=document.getElementById(hintId),v=input.value.trim();if(!v){h.textContent='';h.className='email-hint';return;}if(isGmail(v)){h.innerHTML='‚úì Valid Gmail';h.className='email-hint ok';}else{h.innerHTML='‚úó Only @gmail.com accepted';h.className='email-hint bad';}}
function togglePass(id,btn){const i=document.getElementById(id);if(i.type==='password'){i.type='text';btn.textContent='üôà';}else{i.type='password';btn.textContent='üëÅ';}}
function checkUser(input,hintId){
  const v=input.value.trim().toLowerCase(),h=document.getElementById(hintId);
  if(!v){h.textContent='';h.className='username-hint';return;}
  if(v.length<3){h.textContent='Min 3 chars';h.className='username-hint bad';return;}
  if(!/^[a-z0-9_]+$/.test(v)){h.textContent='Letters, numbers & _ only';h.className='username-hint bad';return;}
  if(DB.users[v]&&v!==currentUser?.username){
    const s=[v+'_berlin',v+'2024',v+'_'+Math.floor(Math.random()*99)];
    h.innerHTML=`<span style="color:var(--danger)">‚úó Taken</span> Try: ${s.map(x=>`<span class="user-sugg" onclick="document.getElementById('${input.id}').value='${x}';checkUser(document.getElementById('${input.id}'),'${hintId}')">${x}</span>`).join(' ')}`;
    h.className='username-hint bad';
  }else{h.textContent='‚úì Available';h.className='username-hint ok';}
}
async function handleLogin(e){
  e.preventDefault();
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPassword').value;
  const eH=document.getElementById('loginEmailHint'),pH=document.getElementById('loginPassHint');
  eH.textContent='';pH.textContent='';
  if(!isGmail(email)){eH.textContent='‚úó Only @gmail.com accepted';eH.className='email-hint bad';return;}
  const isAdmin=(email===ADMIN_EMAIL&&pass===ADMIN_PASS);
  let username,name;
  if(isAdmin){username='Vikram_Nehra';name='Vikram Nehra';}
  else{username=email.split('@')[0].replace(/[^a-z0-9_]/gi,'_').toLowerCase();name=username;}
  const hashed=await hashPass(pass);
  let u=DB.users[username];
  if(u&&!isAdmin&&u._ph&&u._ph!==hashed){pH.textContent='‚úó Wrong password.';pH.className='email-hint bad';document.getElementById('loginPassword').value='';return;}
  if(!u){u={username,name,email,_ph:hashed,photo:null,bio:'',personalPhotos:[],posts:0,rating:5.0,reviews:0,followers:[],following:[],isAdmin};DB.users[username]=u;}
  u.isAdmin=isAdmin;if(!u._ph)u._ph=hashed;
  saveDB();currentUser={...u};localStorage.setItem(SESS_KEY,JSON.stringify({username,isAdmin}));
  closeModal('loginModal');document.getElementById('loginPassword').value='';
  updateNav();toast(isAdmin?'üõ°Ô∏è Welcome, Vikram!':`üëã Welcome, ${name}!`);
}
async function handleSignup(e){
  e.preventDefault();
  const username=document.getElementById('signupUser').value.trim().toLowerCase();
  const name=document.getElementById('signupName').value.trim();
  const email=document.getElementById('signupEmail').value.trim();
  const pass=document.getElementById('signupPass').value;
  const eH=document.getElementById('suEmailHint');
  if(!document.getElementById('acceptTerms').checked){toast('Please accept the Terms first.');return;}
  if(!isGmail(email)){eH.textContent='‚úó Only @gmail.com accepted';eH.className='email-hint bad';return;}
  if(DB.users[username]){toast('Username already taken!');return;}
  if(Object.values(DB.users).find(u=>u.email?.toLowerCase()===email.toLowerCase())){eH.textContent='‚úó Email already registered';eH.className='email-hint bad';return;}
  if(pass.length<6){toast('Password needs 6+ characters.');return;}
  const hashed=await hashPass(pass);
  const u={username,name,email,gender:document.getElementById('signupGender').value,_ph:hashed,photo:null,bio:'',personalPhotos:[],posts:0,rating:5.0,reviews:0,followers:[],following:[],isAdmin:false};
  DB.users[username]=u;saveDB();currentUser={...u};
  localStorage.setItem(SESS_KEY,JSON.stringify({username,isAdmin:false}));
  closeModal('signupModal');document.getElementById('signupModal').querySelector('form').reset();
  updateNav();toast(`üéâ Welcome, ${name}!`);
}
function baseLogout(){
  currentUser=null;localStorage.removeItem(SESS_KEY);updateNav();showPage('home');toast('Signed out.');
}

// ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _apc={};
function buildAreaCache(){const b={};DB.posts.forEach(p=>{const k=`${p.ortsteil}:${p.type}`;if(!b[k])b[k]=[];b[k].push(p.warm);});_apc={};Object.keys(b).forEach(k=>{const v=b[k];_apc[k]=v.reduce((a,c)=>a+c,0)/v.length;});}
function calcScore(p){
  const ageH=Math.max(0.1,(Date.now()-p.createdAt)/3600000),ageD=ageH/24;
  const vel=Math.min(p.views/ageH,50)*2.5;
  let fresh;if(ageD<.5)fresh=100;else if(ageD<1)fresh=85;else if(ageD<3)fresh=70*Math.exp(-.15*ageD);else if(ageD<14)fresh=55*Math.exp(-.08*ageD);else fresh=Math.max(8,30*Math.exp(-.05*ageD));
  const eng=Math.log1p((p.contacts||0)+(p.comments.length*2))*8;
  const trust=((DB.users[p.postedBy]?.rating||4)-3)*6;
  const avg=_apc[`${p.ortsteil}:${p.type}`]||p.warm;
  const price=Math.max(-5,Math.min(15,((avg-p.warm)/avg)*25));
  const comp=Math.min(p.images.length,6)*1.5+Math.min(p.desc.length/80,5)+Math.min(p.facilities.length,5);
  return Math.max(0,vel+fresh+eng+trust+price+comp);
}
function getSortedPosts(){
  buildAreaCache();let list=[...DB.posts];
  if(filterState.type)list=list.filter(p=>p.type===filterState.type);
  if(filterState.ortsteil)list=list.filter(p=>p.ortsteil===filterState.ortsteil);
  if(filterState.share)list=list.filter(p=>p.share===filterState.share);
  if(filterState.price){const[mn,mx]=filterState.price.split('-').map(Number);list=list.filter(p=>p.warm>=mn&&p.warm<=mx);}
  if(filterState.search){const s=filterState.search;list=list.filter(p=>p.title.toLowerCase().includes(s)||p.ortsteil.toLowerCase().includes(s)||p.desc.toLowerCase().includes(s)||p.author.toLowerCase().includes(s));}
  list=list.map(p=>({...p,recommendScore:calcScore(p)}));
  list.sort((a,b)=>b.recommendScore-a.recommendScore);
  list.forEach((p,i)=>p.isRecommended=i<3);
  return list;
}

// ‚îÄ‚îÄ FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPosts(reset=true){
  const grid=document.getElementById('postsGrid'),ctr=document.getElementById('feedCounter');
  if(reset){feedPage=0;feedAll=getSortedPosts();grid.innerHTML='';}
  if(feedAll.length===0){grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:3rem;color:var(--text-light);"><div style="font-size:3rem;margin-bottom:1rem;">üîç</div><p>No listings found.</p></div>`;ctr.textContent='';return;}
  const slice=feedAll.slice(feedPage*PAGE_SIZE,(feedPage+1)*PAGE_SIZE);
  if(feedPage===0){
    grid.innerHTML=Array(Math.min(slice.length,6)).fill(0).map(()=>`<div class="sk-card"><div class="sk-img"></div><div class="sk-body"><div class="sk-line w80"></div><div class="sk-line w60"></div><div class="sk-line w40"></div></div></div>`).join('');
    setTimeout(()=>{grid.innerHTML='';slice.forEach(p=>{const el=document.createElement('div');el.innerHTML=renderCard(p);grid.appendChild(el.firstElementChild);});},200);
  }else{slice.forEach(p=>{const el=document.createElement('div');el.innerHTML=renderCard(p);grid.appendChild(el.firstElementChild);});}
  const shown=Math.min((feedPage+1)*PAGE_SIZE,feedAll.length);
  ctr.textContent=shown>=feedAll.length?`‚úì All ${feedAll.length.toLocaleString()} listings shown`:`Showing ${shown.toLocaleString()} of ${feedAll.length.toLocaleString()} ‚Äî scroll for more`;
  feedPage++;
}
window.addEventListener('scroll',()=>{if(currentPage!=='home')return;if(feedPage*PAGE_SIZE>=feedAll.length)return;if(document.documentElement.scrollHeight-window.scrollY-window.innerHeight<300)renderPosts(false);});


// ‚îÄ‚îÄ CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const galState={},galTouch={};
function renderCard(p){
  const u=DB.users[p.postedBy],isOwner=currentUser&&p.postedBy===currentUser.username;
  const sl=p.share==='private'?'Private':p.share==='shared'?'Shared':'Studio';
  return `<div class="pcard" id="card-${p.id}">
    <div class="pcard-images" id="gal-${p.id}" onmouseenter="galShow(${p.id})" onmouseleave="galHide(${p.id})" ontouchstart="galTouchStart(event,${p.id})" ontouchend="galTouchEnd(event,${p.id})">
      ${p.images?.length
        ?`<div class="img-track" id="track-${p.id}">${p.images.map(img=>`<img src="${img}" draggable="false">`).join('')}</div>
          ${p.images.length>1?`<div class="img-counter" id="cnt-${p.id}">1/${p.images.length}</div>
          <button class="img-arrow prev hidden" id="prev-${p.id}" onclick="galPrev(event,${p.id})">‚Äπ</button>
          <button class="img-arrow next" id="next-${p.id}" onclick="galNext(event,${p.id})">‚Ä∫</button>
          <div class="img-dots">${p.images.map((_,i)=>`<div class="img-dot${i===0?' active':''}" id="dot-${p.id}-${i}" onclick="galGoTo(event,${p.id},${i})"></div>`).join('')}</div>`:''}`
        :`<div class="pcard-placeholder">üè†</div>`}
      ${p.isRecommended?`<div class="rec-badge">‚≠ê Top Pick</div>`:''}
      <div class="type-badge">${p.type}</div>
      <div class="views-badge">üëÅ ${fmtV(p.displayViews)}</div>
    </div>
    <div class="pcard-body">
      <div class="pcard-top">
        <div class="pcard-title" onclick="openPostDetail(${p.id})">${p.title}</div>
        <div class="pcard-rating">‚≠ê ${p.rating}</div>
      </div>
      <div class="pcard-author">
        <div class="author-ava" onclick="viewUserProfile('${p.postedBy}')">${u?.photo?`<img src="${u.photo}">`:(p.author[0]||'?')}</div>
        <span class="author-name" onclick="viewUserProfile('${p.postedBy}')">${p.author}</span>
        <span class="author-location">üìç ${p.ortsteil}</span>
      </div>
      <div class="pcard-details">
        ${p.size?`<div class="detail-chip"><div class="dval">${p.size}m¬≤</div><div class="dlbl">Size</div></div>`:''}
        <div class="detail-chip"><div class="dval">${sl}</div><div class="dlbl">Sharing</div></div>
        <div class="detail-chip"><div class="dval">Floor ${p.floor||0}</div><div class="dlbl">Level</div></div>
      </div>
      <div class="price-row">
        <span class="price-main">‚Ç¨${p.warm}</span>
        <span class="price-warm">/mo warm</span>
        <span class="price-deposit">Deposit ‚Ç¨${p.deposit||0}</span>
      </div>
      ${p.facilities?.length?`<div class="tags-row">${p.facilities.slice(0,4).map(f=>`<span class="tag">${f}</span>`).join('')}</div>`:''}
      <p class="pcard-desc">${p.desc}</p>
      <div class="pcard-actions">
        ${isOwner
          ?`<button class="btn-edit-post" onclick="openEditPost(${p.id})">‚úèÔ∏è Edit</button>
            <button class="btn-contact" onclick="openContactChat('${p.postedBy}',${p.id})">üí¨ Contact</button>`
          :`<button class="btn-details" onclick="openPostDetail(${p.id})">Details</button>
            <button class="btn-contact" onclick="openContactChat('${p.postedBy}',${p.id})">üí¨ Contact</button>
            ${currentUser?`<button class="btn-report-subtle" onclick="openReport(${p.id},'${p.postedBy}')" title="Report">‚öë</button>`:''}`}
      </div>
    </div>
  </div>`;
}
function galGoTo(e,pid,idx){if(e)e.stopPropagation();const p=DB.posts.find(x=>x.id===pid);if(!p?.images)return;const n=p.images.length;idx=Math.max(0,Math.min(idx,n-1));galState[pid]=idx;const t=document.getElementById('track-'+pid);if(t)t.style.transform=`translateX(-${idx*100}%)`;const c=document.getElementById('cnt-'+pid);if(c)c.textContent=`${idx+1}/${n}`;for(let i=0;i<n;i++){const d=document.getElementById(`dot-${pid}-${i}`);if(d)d.className='img-dot'+(i===idx?' active':'');}const pv=document.getElementById('prev-'+pid),nx=document.getElementById('next-'+pid);if(pv)pv.classList.toggle('hidden',idx===0);if(nx)nx.classList.toggle('hidden',idx===n-1);}
function galNext(e,pid){e.stopPropagation();galGoTo(e,pid,(galState[pid]||0)+1);}
function galPrev(e,pid){e.stopPropagation();galGoTo(e,pid,(galState[pid]||0)-1);}
function galShow(pid){const p=DB.posts.find(x=>x.id===pid);if(!p?.images||p.images.length<2)return;const nx=document.getElementById('next-'+pid);if(nx&&(galState[pid]||0)<p.images.length-1)nx.classList.remove('hidden');}
function galHide(pid){['prev-'+pid,'next-'+pid].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.add('hidden');});}
function galTouchStart(e,pid){galTouch[pid]=e.touches[0].clientX;}
function galTouchEnd(e,pid){const sx=galTouch[pid];if(sx===undefined)return;const dx=sx-e.changedTouches[0].clientX;if(Math.abs(dx)>40){if(dx>0)galNext(e,pid);else galPrev(e,pid);}delete galTouch[pid];}

// ‚îÄ‚îÄ FILTER MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AREAS = ['Kreuzberg','Prenzlauer Berg','Friedrichshain','Neuk√∂lln','Charlottenburg','Mitte','Wedding','Moabit','Sch√∂neberg','Wilmersdorf','Tempelhof','Steglitz','Pankow','Lichtenberg','Treptow','K√∂penick','Spandau','Reinickendorf'];
const PRICES = [
  {value:'0-600',   label:'Under ‚Ç¨600',    sub:'Budget-friendly options'},
  {value:'600-900', label:'‚Ç¨600 ‚Äì ‚Ç¨900',   sub:'Mid-range'},
  {value:'900-1500',label:'‚Ç¨900 ‚Äì ‚Ç¨1,500', sub:'Premium'},
  {value:'1500-99999',label:'‚Ç¨1,500+',     sub:'Luxury'},
];
const TYPES = [
  {value:'private', label:'Private',   sub:'Entire apartment for yourself'},
  {value:'shared',  label:'Shared WG', sub:'Room in a shared flat'},
  {value:'studio',  label:'Studio',    sub:'Open plan studio apartment'},
];

function openFilter(which){
  if(which==='area'){
    renderAreaList('');
    document.getElementById('areaSearch').value='';
    openModal('filterAreaModal');
  } else if(which==='price'){
    renderPriceList();
    openModal('filterPriceModal');
  } else if(which==='type'){
    renderTypeList();
    openModal('filterTypeModal');
  }
}
function closeFilter(which){
  closeModal('filter'+which.charAt(0).toUpperCase()+which.slice(1)+'Modal');
  applyFilters();
}
function clearFilter(which){
  if(which==='area'){filterState.ortsteil='';document.getElementById('flbl-area').textContent='Areas';document.getElementById('fbtn-area').classList.remove('active');renderAreaList('');}
  if(which==='price'){filterState.price='';document.getElementById('flbl-price').textContent='Price';document.getElementById('fbtn-price').classList.remove('active');renderPriceList();}
  if(which==='type'){filterState.share='';document.getElementById('flbl-type').textContent='Type';document.getElementById('fbtn-type').classList.remove('active');renderTypeList();}
}

function renderAreaList(q){
  const list=document.getElementById('areaList');
  const filtered=AREAS.filter(a=>!q||a.toLowerCase().includes(q.toLowerCase()));
  const counts={};DB.posts.forEach(p=>{counts[p.ortsteil]=(counts[p.ortsteil]||0)+1;});
  list.innerHTML=filtered.length
    ?filtered.map(a=>`<div class="fopt${filterState.ortsteil===a?' selected':''}" onclick="selectArea('${a}')">
        <div class="fopt-radio"></div>
        <div class="fopt-text"><div class="fopt-label">${a}</div></div>
        <span class="fopt-count">${counts[a]||0}</span>
      </div>`).join('')
    :`<div style="text-align:center;padding:2rem;color:var(--text-light);">No districts found</div>`;
}
function filterAreaList(q){renderAreaList(q);}
function selectArea(area){
  filterState.ortsteil=area;
  document.getElementById('flbl-area').textContent=area;
  document.getElementById('fbtn-area').classList.add('active');
  renderAreaList(document.getElementById('areaSearch').value);
}
function renderPriceList(){
  const list=document.getElementById('priceList');
  list.innerHTML=PRICES.map(p=>`<div class="fopt${filterState.price===p.value?' selected':''}" onclick="selectPrice('${p.value}','${p.label}')">
    <div class="fopt-radio"></div>
    <div class="fopt-text"><div class="fopt-label">${p.label}</div><div class="fopt-sub">${p.sub}</div></div>
  </div>`).join('');
}
function selectPrice(val,label){
  filterState.price=val;
  document.getElementById('flbl-price').textContent=label;
  document.getElementById('fbtn-price').classList.add('active');
  renderPriceList();
}
function renderTypeList(){
  const list=document.getElementById('typeList');
  list.innerHTML=TYPES.map(t=>`<div class="fopt${filterState.share===t.value?' selected':''}" onclick="selectType('${t.value}','${t.label}')">
    <div class="fopt-radio"></div>
    <div class="fopt-text"><div class="fopt-label">${t.label}</div><div class="fopt-sub">${t.sub}</div></div>
  </div>`).join('');
}
function selectType(val,label){
  filterState.share=val;
  document.getElementById('flbl-type').textContent=label;
  document.getElementById('fbtn-type').classList.add('active');
  renderTypeList();
}
function applyFilters(){renderPosts(true);}
function doSearch(){filterState.search=document.getElementById('searchInput').value.trim().toLowerCase();renderPosts(true);}
function clearFilters(){
  filterState={type:'',ortsteil:'',price:'',share:'',search:''};
  document.getElementById('flbl-area').textContent='Areas';
  document.getElementById('flbl-price').textContent='Price';
  document.getElementById('flbl-type').textContent='Type';
  ['fbtn-area','fbtn-price','fbtn-type'].forEach(id=>document.getElementById(id).classList.remove('active'));
  document.getElementById('searchInput').value='';
  renderPosts(true);
}

// ‚îÄ‚îÄ POST ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handlePostClick(){if(!currentUser){openModal('loginModal');return;}openModal('postModal');}
function handlePost(e){
  e.preventDefault();
  const cold=parseInt(document.getElementById('pCold').value)||0,warm=parseInt(document.getElementById('pWarm').value)||0;
  if(!cold&&!warm){document.getElementById('rentHint').style.display='block';return;}
  document.getElementById('rentHint').style.display='none';
  const np={id:Date.now(),title:ttl(document.getElementById('pTitle').value.trim()),ortsteil:document.getElementById('pOrtsteil').value,type:document.getElementById('pType').value,share:document.getElementById('pShare').value,size:document.getElementById('pSize').value?parseInt(document.getElementById('pSize').value):null,cold:cold||Math.round(warm*.88),warm:warm||Math.round(cold*1.14),deposit:parseInt(document.getElementById('pDeposit').value)||0,floor:parseInt(document.getElementById('pFloor').value)||0,anmeldung:document.getElementById('pAnmeldung').value,facilities:[...document.querySelectorAll('.pfac:checked')].map(x=>x.value),desc:document.getElementById('pDesc').value,images:[...postImages],postedBy:currentUser.username,author:currentUser.name,views:Math.floor(Math.random()*80)+20,displayViews:Math.floor(Math.random()*80)+20,contacts:0,rating:5.0,comments:[],createdAt:Date.now(),isRecommended:false,recommendScore:0};
  DB.posts.unshift(np);const u=DB.users[currentUser.username];if(u)u.posts=(u.posts||0)+1;
  saveDB();closeModal('postModal');document.getElementById('postModal').querySelector('form').reset();postImages=[];document.getElementById('pImgPreviews').innerHTML='';renderPosts(true);toast('üè† Listing published!');
}
function openEditPost(id){const p=DB.posts.find(x=>x.id===id);if(!p)return;document.getElementById('editPostId').value=id;document.getElementById('eptTitle').value=p.title;document.getElementById('eptDesc').value=p.desc;document.getElementById('eptWarm').value=p.warm;document.getElementById('eptDeposit').value=p.deposit||0;openModal('editPostModal');}
function handleEditPost(e){e.preventDefault();const id=document.getElementById('editPostId').value;const p=DB.posts.find(x=>String(x.id)===String(id));if(!p)return;p.title=ttl(document.getElementById('eptTitle').value);p.desc=document.getElementById('eptDesc').value;p.warm=parseInt(document.getElementById('eptWarm').value)||p.warm;p.deposit=parseInt(document.getElementById('eptDeposit').value)||0;saveDB();closeModal('editPostModal');renderPosts(true);toast('‚úÖ Updated!');}
function openPostDetail(id){
  const p=DB.posts.find(x=>x.id===id);if(!p)return;
  p.views++;p.displayViews=(p.displayViews||0)+2;saveDB();
  const nb=Math.max(0,p.warm-(p.cold||Math.round(p.warm*.88)));
  document.getElementById('postDetailContent').innerHTML=`
    ${p.images?.length?`<div class="pdg-scroll">${p.images.map(i=>`<img src="${i}">`).join('')}</div>`:`<div style="height:160px;background:linear-gradient(135deg,var(--primary-mid),var(--accent));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:3rem;margin-bottom:1rem;">üè†</div>`}
    <h2 style="font-family:'DM Serif Display',serif;font-size:1.35rem;color:var(--primary);margin-bottom:.5rem;">${p.title}</h2>
    <div style="display:flex;gap:1rem;flex-wrap:wrap;font-size:.82rem;color:var(--text-light);margin-bottom:1rem;"><span>üìç ${p.ortsteil}</span><span>üè† ${p.type}</span>${p.size?`<span>üìê ${p.size}m¬≤</span>`:''}<span>üëÅ ${fmtV(p.displayViews)}</span></div>
    <div class="post-detail-price">
      <div class="pdp-main">‚Ç¨${p.warm}<span style="font-size:1rem;font-weight:400;">/mo</span></div>
      <div class="pdp-sub">Warm rent (all inclusive)</div>
      <div class="pdp-breakdown">
        <div><div class="pdp-val">‚Ç¨${p.cold||Math.round(p.warm*.88)}</div><div class="pdp-lbl">Cold rent</div></div>
        <div><div class="pdp-val">‚Ç¨${nb}</div><div class="pdp-lbl">Utilities</div></div>
        <div><div class="pdp-val">‚Ç¨${p.deposit||0}</div><div class="pdp-lbl">Deposit</div></div>
      </div>
    </div>
    <div class="post-detail-grid">
      <div class="pdg-item"><div class="icon">üè†</div><div class="val">${p.type}</div><div class="lbl">Type</div></div>
      <div class="pdg-item"><div class="icon">üîí</div><div class="val">${p.share==='private'?'Private':p.share==='shared'?'Shared':'Studio'}</div><div class="lbl">Sharing</div></div>
      ${p.size?`<div class="pdg-item"><div class="icon">üìê</div><div class="val">${p.size}m¬≤</div><div class="lbl">Size</div></div>`:''}
      <div class="pdg-item"><div class="icon">üèóÔ∏è</div><div class="val">Floor ${p.floor||0}</div><div class="lbl">Level</div></div>
      <div class="pdg-item"><div class="icon">üìã</div><div class="val">${p.anmeldung==='yes'?'‚úÖ Yes':'‚ùå No'}</div><div class="lbl">Anmeldung</div></div>
      <div class="pdg-item"><div class="icon">‚≠ê</div><div class="val">${p.rating}</div><div class="lbl">Rating</div></div>
    </div>
    ${p.facilities?.length?`<div class="section-label">Facilities</div><div class="tags-row">${p.facilities.map(f=>`<span class="tag">‚úì ${f}</span>`).join('')}</div>`:''}
    <div class="section-label" style="margin-top:.75rem;">Description</div>
    <p style="color:var(--text-mid);font-size:.88rem;line-height:1.7;margin-bottom:1rem;">${p.desc}</p>
    <a class="map-link" href="https://www.google.com/maps/search/${encodeURIComponent(p.ortsteil+' Berlin')}" target="_blank">üó∫Ô∏è View on Google Maps</a>
    <div style="display:flex;gap:.6rem;margin-top:.75rem;">
      <button class="btn-contact" style="flex:1;" onclick="openContactChat('${p.postedBy}',${p.id});closeModal('postDetailModal')">üí¨ Contact</button>
      ${currentUser&&p.postedBy!==currentUser.username?`<button class="btn-report-subtle" onclick="openReport(${p.id},'${p.postedBy}')">‚öë</button>`:''}
    </div>`;
  openModal('postDetailModal');
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProfile(username){
  const tu=username?DB.users[username]:(currentUser?DB.users[currentUser.username]:null);
  const isOwn=!username||(currentUser&&username===currentUser.username);
  const el=document.getElementById('profileContent');
  if(!tu||(!currentUser&&isOwn)){el.innerHTML=`<div style="text-align:center;padding:4rem;color:var(--text-light);"><div style="font-size:4rem;margin-bottom:1rem;">üë§</div><p style="margin-bottom:1.5rem;">Sign in to view your profile</p><button class="btn-full" style="max-width:240px;margin:0 auto;" onclick="openModal('loginModal')">Sign In</button></div>`;return;}
  const uPosts=DB.posts.filter(p=>p.postedBy===tu.username);
  const isFollowing=currentUser&&!isOwn&&(DB.users[currentUser.username]?.following||[]).includes(tu.username);
  el.innerHTML=`
    <div class="profile-hero">
      <div class="profile-ava-wrap">
        <div class="profile-ava">${tu.photo?`<img src="${tu.photo}">`:(tu.name[0]||'?').toUpperCase()}</div>
      </div>
      <h2 class="profile-name">${tu.name}</h2>
      <p class="profile-username">@${tu.username}</p>
      ${tu.bio?`<p class="profile-bio">"${tu.bio}"</p>`:''}
      <div class="profile-stats-row">
        <div class="pstat"><div class="pstat-val">${uPosts.length}</div><div class="pstat-lbl">Listings</div></div>
        <div class="pstat"><div class="pstat-val">${(tu.followers||[]).length}</div><div class="pstat-lbl">Followers</div></div>
        <div class="pstat"><div class="pstat-val">${(tu.following||[]).length}</div><div class="pstat-lbl">Following</div></div>
        <div class="pstat"><div class="pstat-val">${tu.rating}</div><div class="pstat-lbl">Rating</div></div>
      </div>
      <div class="profile-actions">
        ${isOwn?`
          <button class="btn-edit-profile" onclick="openEditProfileModal()">‚úèÔ∏è Edit</button>
          ${currentUser.isAdmin?`<button class="btn-admin-portal" onclick="showPage('admin')">üõ°Ô∏è Admin</button>`:''}
          <button class="btn-edit-profile" onclick="doSignOut()">Sign Out</button>
        `:`
          <button class="btn-follow ${isFollowing?'following':''}" onclick="toggleFollow('${tu.username}')">${isFollowing?'‚úì Following':'Ôºã Follow'}</button>
          <button class="btn-edit-profile" onclick="openContactChat('${tu.username}')">üí¨ Message</button>
        `}
      </div>
    </div>
    <div class="profile-tabs">
      <button class="ptab active" id="ptab-listings" onclick="switchProfileTab('listings')">Listings</button>
      <button class="ptab" id="ptab-photos" onclick="switchProfileTab('photos')">Photos</button>
      <button class="ptab" id="ptab-following" onclick="switchProfileTab('following')">Following</button>
      <button class="ptab" id="ptab-followers" onclick="switchProfileTab('followers')">Followers</button>
    </div>
    <div id="ptab-content-listings" class="ptab-content active" style="padding:1.25rem;">
      ${uPosts.length?`<div class="posts-grid">${uPosts.map(p=>renderCard({...p,isRecommended:false})).join('')}</div>`:`<div style="text-align:center;padding:2rem;color:var(--text-light);">No listings yet</div>`}
    </div>
    <div id="ptab-content-photos" class="ptab-content">
      ${isOwn?`<div class="photo-upload-area" onclick="document.getElementById('persPhotoInput').click()"><input type="file" id="persPhotoInput" accept="image/*" multiple style="display:none" onchange="handlePersonalPhotos(this)"><div style="font-size:2rem;">üì∑</div><p>Tap to add photos</p></div>`:''}
      <div class="personal-gallery">${(tu.personalPhotos||[]).map((ph,i)=>`<div class="pgal-item"><img src="${ph}" onclick="openPhotoViewer('${ph}')">
        ${isOwn?`<button class="pgal-del" onclick="removePersonalPhoto(${i})">√ó</button>`:''}</div>`).join('')}
      </div>
    </div>
    <div id="ptab-content-following" class="ptab-content">
      ${(tu.following||[]).length?`<div class="follow-list">${(tu.following||[]).map(u=>`<div class="follow-item" onclick="viewUserProfile('${u}')"><div class="follow-ava">${(DB.users[u]?.name||u)[0].toUpperCase()}</div><div><div style="font-weight:600;font-size:.9rem;">${DB.users[u]?.name||u}</div><div style="font-size:.78rem;color:var(--text-light);">@${u}</div></div></div>`).join('')}</div>`:`<div style="text-align:center;padding:2rem;color:var(--text-light);">Not following anyone yet</div>`}
    </div>
    <div id="ptab-content-followers" class="ptab-content">
      ${(tu.followers||[]).length?`<div class="follow-list">${(tu.followers||[]).map(u=>`<div class="follow-item" onclick="viewUserProfile('${u}')"><div class="follow-ava">${(DB.users[u]?.name||u)[0].toUpperCase()}</div><div><div style="font-weight:600;font-size:.9rem;">${DB.users[u]?.name||u}</div><div style="font-size:.78rem;color:var(--text-light);">@${u}</div></div></div>`).join('')}</div>`:`<div style="text-align:center;padding:2rem;color:var(--text-light);">No followers yet</div>`}
    </div>`;
}
function viewUserProfile(username){renderProfile(username);showPage('profile');}
function toggleFollow(username){if(!currentUser)return;const me=DB.users[currentUser.username],them=DB.users[username];if(!me||!them)return;me.following=me.following||[];them.followers=them.followers||[];const idx=me.following.indexOf(username);if(idx>-1){me.following.splice(idx,1);them.followers=them.followers.filter(f=>f!==currentUser.username);}else{me.following.push(username);if(!them.followers.includes(currentUser.username))them.followers.push(currentUser.username);}saveDB();renderProfile();}
function openEditProfileModal(){if(!currentUser)return;const u=DB.users[currentUser.username];if(!u)return;document.getElementById('epUsername').value=u.username;document.getElementById('epName').value=u.name;document.getElementById('epBio').value=u.bio||'';const prev=document.getElementById('profPhotoPreview');prev.innerHTML=u.photo?`<img src="${u.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`:(u.name[0]||'?').toUpperCase();editingProfPhoto=u.photo;personalPhotos=[];openModal('editProfileModal');}
function handleEditProfile(e){e.preventDefault();if(!currentUser)return;const old=currentUser.username,nu=document.getElementById('epUsername').value.trim().toLowerCase(),nn=document.getElementById('epName').value.trim(),nb=document.getElementById('epBio').value;if(nu!==old&&DB.users[nu]){toast('Username taken!');return;}const u=DB.users[old];if(nu!==old){DB.users[nu]=u;delete DB.users[old];DB.posts.forEach(p=>{if(p.postedBy===old){p.postedBy=nu;p.author=nn;}});}u.username=nu;u.name=nn;u.bio=nb;if(editingProfPhoto)u.photo=editingProfPhoto;if(personalPhotos.length){u.personalPhotos=(u.personalPhotos||[]).concat(personalPhotos);personalPhotos=[];}currentUser={...u};localStorage.setItem(SESS_KEY,JSON.stringify({username:nu,isAdmin:currentUser.isAdmin}));saveDB();closeModal('editProfileModal');renderProfile();toast('‚úÖ Profile saved!');}
function handleProfPhotoUpload(input){if(!input.files[0])return;const r=new FileReader();r.onload=e=>{editingProfPhoto=e.target.result;const d=document.getElementById('profPhotoPreview');if(d)d.innerHTML=`<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`};r.readAsDataURL(input.files[0]);}
function handlePersonalPhotos(input){[...input.files].forEach(f=>{const r=new FileReader();r.onload=e=>{personalPhotos.push(e.target.result);};r.readAsDataURL(f);});}
function removePersonalPhoto(i){const u=DB.users[currentUser.username];if(!u)return;u.personalPhotos.splice(i,1);saveDB();renderProfile();}
function switchProfileTab(tab){document.querySelectorAll('.ptab').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.ptab-content').forEach(c=>c.classList.remove('active'));const b=document.getElementById('ptab-'+tab),c=document.getElementById('ptab-content-'+tab);if(b)b.classList.add('active');if(c)c.classList.add('active');}
function openPhotoViewer(src){let m=document.getElementById('photoViewerModal');if(!m){m=document.createElement('div');m.id='photoViewerModal';m.className='modal';m.innerHTML=`<div class="modal-box" style="background:rgba(0,0,0,.95);max-width:92vw;padding:.5rem;text-align:center;border-radius:16px;"><img style="max-height:85vh;border-radius:12px;max-width:100%;"><button class="mclose" onclick="closeModal('photoViewerModal')" style="background:rgba(255,255,255,.2);color:#fff;">‚úï</button></div>`;document.body.appendChild(m);}m.querySelector('img').src=src;m.classList.add('open');}

// ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAdminPanel(){
  if(!currentUser||!currentUser.isAdmin){showPage('home');return;}
  const uq=(document.getElementById('adminUserSearch')?.value||'').toLowerCase();
  const pq=(document.getElementById('adminPostSearch')?.value||'').toLowerCase();
  document.getElementById('a-users').textContent=Object.keys(DB.users).length;
  document.getElementById('a-posts').textContent=DB.posts.length;
  document.getElementById('a-reports').textContent=DB.reports.filter(r=>!r.reviewed).length;
  document.getElementById('a-banned').textContent=DB.bannedUsers.length;
  const users=Object.values(DB.users).filter(u=>!uq||u.username.includes(uq)||u.name.toLowerCase().includes(uq)||(u.email||'').includes(uq));
  document.getElementById('adminUsersList').innerHTML=users.length?users.map(u=>{const banned=DB.bannedUsers.includes(u.username),warns=DB.userWarnings[u.username]||0,pc=DB.posts.filter(p=>p.postedBy===u.username).length;return `<div class="admin-user-card" style="${banned?'opacity:.5;':''}">\n<div class="auc-ava">${u.photo?`<img src="${u.photo}">`:(u.name[0]||'?').toUpperCase()}</div>\n<div class="auc-info"><div class="auc-name">${u.name}${u.isAdmin?'<span style="background:var(--danger);color:#fff;padding:1px 5px;border-radius:6px;font-size:.6rem;margin-left:3px;">ADMIN</span>':''}${banned?'<span style="background:#888;color:#fff;padding:1px 5px;border-radius:6px;font-size:.6rem;margin-left:3px;">BANNED</span>':''}${warns?`<span style="background:var(--warn);color:#333;padding:1px 5px;border-radius:6px;font-size:.6rem;margin-left:3px;">‚ö†Ô∏è${warns}</span>`:''}</div><div class="auc-meta">@${u.username} ¬∑ ${u.email||''} ¬∑ ${pc} posts</div></div>\n<div class="auc-actions">${!banned&&!u.isAdmin?`<button class="btn-admin-action ba-warn" onclick="adminWarnUser('${u.username}')">‚ö†Ô∏è</button><button class="btn-admin-action ba-ban" onclick="adminBanUser('${u.username}')">üö´</button>`:banned?`<button class="btn-admin-action ba-dismiss" onclick="adminUnban('${u.username}')">‚úÖ</button>`:''}</div>\n</div>`;}).join(''):`<p style="padding:1.25rem;color:var(--text-light);">No users found</p>`;
  document.getElementById('adminReportsList').innerHTML=DB.reports.length?DB.reports.map(r=>`<div class="report-card ${r.reviewed?'done':''}"><div style="display:flex;justify-content:space-between;margin-bottom:.4rem;"><strong>#${r.id} ¬∑ ${r.reason}</strong><span style="font-size:.72rem;color:var(--text-light);">${tAgo(r.time)}</span></div><div style="font-size:.82rem;color:var(--text-mid);">Post #${r.target?.postId} ¬∑ @${r.target?.username}<br>By @${r.reportedBy}: ${r.details}</div>${!r.reviewed?`<div class="report-card-actions"><button class="btn-admin-action ba-warn" onclick="adminWarnUser('${r.target?.username}');markReviewed(${r.id})">‚ö†Ô∏è</button><button class="btn-admin-action ba-ban" onclick="adminBanUser('${r.target?.username}');markReviewed(${r.id})">üö´</button><button class="btn-admin-action ba-del" onclick="adminDeletePost(${r.target?.postId},${r.id})">üóë</button><button class="btn-admin-action ba-dismiss" onclick="markReviewed(${r.id})">‚úì</button></div>`:`<div style="color:var(--success);font-size:.78rem;margin-top:.4rem;">‚úÖ Reviewed</div>`}</div>`).join(''):`<p style="padding:1.25rem;color:var(--text-light);">No reports ‚úÖ</p>`;
  const posts=DB.posts.filter(p=>!pq||p.title.toLowerCase().includes(pq)||p.ortsteil.toLowerCase().includes(pq)||p.postedBy.includes(pq)).sort((a,b)=>b.createdAt-a.createdAt);
  document.getElementById('adminPostsList').innerHTML=posts.length?posts.map(p=>`<div class="admin-post-card"><div class="apc-info"><div class="apc-title">${p.title}</div><div class="apc-meta">üìç${p.ortsteil} ¬∑ ‚Ç¨${p.warm}/mo ¬∑ @${p.postedBy} ¬∑ ${tAgo(p.createdAt)}</div></div><div class="apc-actions"><button class="btn-admin-action ba-warn" onclick="adminEditPost(${p.id})">‚úèÔ∏è</button><button class="btn-admin-action ba-del" onclick="adminDeletePost(${p.id})">üóëÔ∏è</button></div></div>`).join(''):`<p style="padding:1.25rem;color:var(--text-light);">No posts found</p>`;
}
function adminWarnUser(u){if(!u||!confirm(`Warn @${u}?`))return;DB.userWarnings[u]=(DB.userWarnings[u]||0)+1;saveDB();toast(`‚ö†Ô∏è @${u} warned`);renderAdminPanel();}
function adminBanUser(u){if(!u||!confirm(`Ban @${u}?`))return;if(!DB.bannedUsers.includes(u))DB.bannedUsers.push(u);saveDB();toast(`üö´ @${u} banned`);renderAdminPanel();}
function adminUnban(u){if(!confirm(`Unban @${u}?`))return;DB.bannedUsers=DB.bannedUsers.filter(b=>b!==u);saveDB();toast(`‚úÖ @${u} unbanned`);renderAdminPanel();}
function adminEditPost(id){openEditPost(id);}
function adminDeletePost(postId,reportId){if(!confirm(`Delete post #${postId}? Cannot be undone.`))return;DB.posts=DB.posts.filter(p=>p.id!==postId&&String(p.id)!==String(postId));saveDB();if(reportId!==undefined)markReviewed(reportId);renderPosts(true);renderAdminPanel();toast('üóëÔ∏è Deleted');}
function markReviewed(rid){const r=DB.reports.find(x=>x.id===rid);if(r)r.reviewed=true;saveDB();renderAdminPanel();}

// ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openReport(postId,username){if(!currentUser){openModal('loginModal');return;}reportTarget={postId,username};openModal('reportModal');}
function handleReport(e){e.preventDefault();if(!currentUser)return;DB.reports.push({id:Date.now(),target:reportTarget,reason:document.getElementById('reportReason').value,details:document.getElementById('reportDetails').value,reportedBy:currentUser.username,time:Date.now(),reviewed:false});saveDB();closeModal('reportModal');document.getElementById('reportModal').querySelector('form').reset();toast('‚úÖ Report submitted');}

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderConversations(){
  const list=document.getElementById('convList');
  if(!currentUser){list.innerHTML=`<div style="text-align:center;padding:3rem;color:var(--text-light);">Sign in to message</div>`;return;}
  const items=currentMsgsTab==='dms'?DB.conversations.filter(c=>c.participants?.includes(currentUser.username)):DB.groups.filter(g=>g.members?.includes(currentUser.username));
  list.innerHTML=items.length?items.map(c=>{const name=c.participants?c.participants.find(p=>p!==currentUser.username):c.name;return `<div class="conv-item" onclick="openConv('${c.id}','${c.participants?'dm':'group'}')"><div class="conv-ava">${(name||'?')[0].toUpperCase()}</div><div class="conv-info"><div class="conv-name">${name}</div><div class="conv-preview">${c.lastMsg||'No messages yet'}</div></div><div class="conv-time">${c.lastTime?tAgo(c.lastTime):''}</div></div>`;}).join(''):`<div style="text-align:center;padding:3rem;color:var(--text-light);">${currentMsgsTab==='dms'?'No direct messages yet':'No groups yet'}</div>`;
}
function switchMsgsTab(tab){currentMsgsTab=tab;document.getElementById('tab-dms').classList.toggle('active',tab==='dms');document.getElementById('tab-groups').classList.toggle('active',tab==='groups');renderConversations();}
function openConv(id,type){currentConvId={id,type};const isGrp=type==='group';const data=isGrp?DB.groups.find(g=>g.id===id):DB.conversations.find(c=>c.id===id);if(!data)return;const name=isGrp?data.name:data.participants?.find(p=>p!==currentUser?.username);document.getElementById('chatHdrAva').textContent=(name||'?')[0].toUpperCase();document.getElementById('chatHdrName').textContent=name||'Chat';document.getElementById('chatHdrSub').textContent=isGrp?`${data.members?.length||0} members`:'Direct Message';renderChatMsgs(data.messages,isGrp);document.getElementById('chatView').classList.add('open');}
function renderChatMsgs(msgs,isGrp){const el=document.getElementById('chatMsgs');if(!msgs?.length){el.innerHTML=`<div style="text-align:center;color:var(--text-light);margin-top:2rem;">No messages yet</div>`;return;}el.innerHTML=msgs.map(m=>{const mine=currentUser&&m.sender===currentUser.username;return `<div class="msg-row ${mine?'mine':''}"><div class="msg-bubble ${mine?'sent':'recv'}">${isGrp&&!mine?`<div class="msg-sender">@${m.sender}</div>`:''} ${m.type==='image'?`<img src="${m.text}" style="max-width:180px;border-radius:10px;" onclick="openPhotoViewer('${m.text}')">`:m.text}<div class="msg-time">${tAgo(m.time)}</div></div></div>`;}).join('');el.scrollTop=el.scrollHeight;}
function sendMessage(){if(!currentUser||!currentConvId)return;const inp=document.getElementById('chatInput'),txt=inp.value.trim();if(!txt)return;inp.value='';const isGrp=currentConvId.type==='group';const data=isGrp?DB.groups.find(g=>g.id===currentConvId.id):DB.conversations.find(c=>c.id===currentConvId.id);if(!data)return;data.messages.push({id:'m'+Date.now(),sender:currentUser.username,text:txt,time:Date.now(),type:'text'});data.lastMsg=txt;data.lastTime=Date.now();saveDB();renderChatMsgs(data.messages,isGrp);renderConversations();}
function sendChatImage(input){if(!input.files[0]||!currentUser||!currentConvId)return;const r=new FileReader();r.onload=e=>{const isGrp=currentConvId.type==='group';const data=isGrp?DB.groups.find(g=>g.id===currentConvId.id):DB.conversations.find(c=>c.id===currentConvId.id);if(!data)return;data.messages.push({id:'m'+Date.now(),sender:currentUser.username,text:e.target.result,time:Date.now(),type:'image'});data.lastMsg='üì∑ Photo';data.lastTime=Date.now();saveDB();renderChatMsgs(data.messages,isGrp);renderConversations();};r.readAsDataURL(input.files[0]);input.value='';}
function handleChatKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}}
function closeChat(){document.getElementById('chatView').classList.remove('open');}
function handleCreateGroup(e){e.preventDefault();if(!currentUser){openModal('loginModal');return;}const name=document.getElementById('groupName').value,desc=document.getElementById('groupDesc').value;DB.groups.push({id:'g'+Date.now(),name,desc,creator:currentUser.username,members:[currentUser.username],messages:[],lastMsg:'',lastTime:Date.now()});saveDB();closeModal('newGroupModal');document.getElementById('newGroupModal').querySelector('form').reset();switchMsgsTab('groups');toast(`Group "${name}" created!`);}
function openContactChat(username,postId){if(!currentUser){openModal('loginModal');return;}if(username===currentUser.username)return;if(postId){const p=DB.posts.find(x=>x.id===postId);if(p){p.contacts=(p.contacts||0)+1;saveDB();}}let conv=DB.conversations.find(c=>c.participants?.includes(currentUser.username)&&c.participants?.includes(username));if(!conv){conv={id:'c'+Date.now(),participants:[currentUser.username,username],messages:[],lastMsg:'',lastTime:Date.now()};DB.conversations.push(conv);saveDB();}showPage('messages');openConv(conv.id,'dm');}

// ‚îÄ‚îÄ IMAGE UPLOADS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handlePostImgs(input){[...input.files].slice(0,11-postImages.length).forEach(f=>{const r=new FileReader();r.onload=e=>{postImages.push(e.target.result);renderPostImgPreviews();};r.readAsDataURL(f);});}
function renderPostImgPreviews(){document.getElementById('pImgPreviews').innerHTML=postImages.map((img,i)=>`<div class="img-prev"><img src="${img}"><button class="img-prev-del" onclick="removePostImg(${i})">√ó</button></div>`).join('');}
function removePostImg(i){postImages.splice(i,1);renderPostImgPreviews();}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById('page-'+page);if(el)el.classList.add('active');
  const bn=document.getElementById('bn-'+page);if(bn)bn.classList.add('active');
  currentPage=page;
  if(page==='profile')renderProfile();
  if(page==='messages')renderConversations();
  if(page==='admin'){if(!currentUser||!currentUser.isAdmin){toast('Admin access only');showPage('profile');return;}renderAdminPanel();}
  window.scrollTo(0,0);
}
function updateNav(){
  const btn=document.getElementById('signinBtn');
  const adminBtn=document.getElementById('bn-admin');
  if(currentUser){
    btn.style.display='none';
    if(adminBtn)adminBtn.style.display=currentUser.isAdmin?'flex':'none';
  }else{
    btn.style.display='';
    if(adminBtn)adminBtn.style.display='none';
  }
}
function toggleLang(){lang=lang==='en'?'de':'en';document.getElementById('langToggleBtn').textContent=lang==='en'?'üá¨üáß EN':'üá©üá™ DE';}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id){document.getElementById(id)?.classList.add('open');}
function closeModal(id){document.getElementById(id)?.classList.remove('open');}
function switchModal(a,b){closeModal(a);openModal(b);}
document.addEventListener('click',e=>{if(e.target.classList.contains('modal'))e.target.classList.remove('open');});
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open'));});

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _tt;
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),3000);}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtV(n){if(!n)return'0';if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1000)return(n/1000).toFixed(1)+'k';return String(n);}
function tAgo(ts){const d=Date.now()-ts,m=60000,h=3600000,dy=86400000;if(d<m)return'just now';if(d<h)return Math.floor(d/m)+'m ago';if(d<dy)return Math.floor(d/h)+'h ago';if(d<dy*30)return Math.floor(d/dy)+'d ago';return Math.floor(d/(dy*30))+'mo ago';}
function ttl(s){const sk=new Set(['a','an','the','in','on','at','for','of','to','and','or','but','near','with']);return s.replace(/\b\w+/g,(w,i)=>i===0||!sk.has(w.toLowerCase())?w[0].toUpperCase()+w.slice(1).toLowerCase():w.toLowerCase());}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init(){
  loadDB();
  seedOnce();
  try{const sess=localStorage.getItem(SESS_KEY);if(sess){const{username,isAdmin}=JSON.parse(sess);const u=DB.users[username];if(u){u.isAdmin=isAdmin;currentUser={...u};}else localStorage.removeItem(SESS_KEY);}}catch(ex){localStorage.removeItem(SESS_KEY);}
  updateNav();
  renderPosts(true);
  setInterval(()=>{if(currentPage==='home')renderPosts(true);},5*60*1000);
}

// ‚îÄ‚îÄ FIREBASE GOOGLE AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIREBASE_ADMIN_EMAIL='jaat602y@gmail.com';
const firebaseConfig={apiKey:"AIzaSyB3bNS5hMpEywmyeyIC7ce",authDomain:"berlinnest.firebaseapp.com",projectId:"berlinnest",storageBucket:"berlinnest.appspot.com",messagingSenderId:"422184060329",appId:"1:422184060329:web:31c3cc1375374bf019b0b8"};
let fbAuth=null;
try{
  firebase.initializeApp(firebaseConfig);
  fbAuth=firebase.auth();
  fbAuth.getRedirectResult().then(result=>{if(!result||!result.user)return;onFirebaseUser(result.user);}).catch(err=>{console.warn('Firebase redirect:',err);});
  fbAuth.onAuthStateChanged(user=>{if(user)onFirebaseUser(user);});
}catch(e){console.warn('Firebase init:',e);}

function onFirebaseUser(fbUser){
  const isAdmin=fbUser.email===FIREBASE_ADMIN_EMAIL||fbUser.email===ADMIN_EMAIL;
  const username='g_'+fbUser.uid.slice(0,12).replace(/[^a-z0-9_]/gi,'_').toLowerCase();
  const name=fbUser.displayName||fbUser.email.split('@')[0];
  const photo=fbUser.photoURL||null;
  if(!DB.users[username]){DB.users[username]={username,name,email:fbUser.email,photo,_ph:'',bio:'',personalPhotos:[],posts:0,rating:5.0,reviews:0,followers:[],following:[],isAdmin};}
  else{if(photo)DB.users[username].photo=photo;DB.users[username].name=name;DB.users[username].isAdmin=isAdmin;}
  saveDB();currentUser={...DB.users[username]};
  localStorage.setItem(SESS_KEY,JSON.stringify({username,isAdmin}));
  document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open'));
  updateNav();if(currentPage==='profile')renderProfile();
  toast(isAdmin?`üõ°Ô∏è Welcome, ${name}!`:`üëã Welcome, ${name}!`);
}
function googleLogin(){if(!fbAuth){toast('Google sign-in unavailable. Use email below.');return;}const provider=new firebase.auth.GoogleAuthProvider();provider.setCustomParameters({prompt:'select_account'});fbAuth.signInWithRedirect(provider).catch(err=>{console.warn(err);toast('Google sign-in failed.');});}
function doSignOut(){
  if(fbAuth&&fbAuth.currentUser){
    fbAuth.signOut().then(()=>{currentUser=null;localStorage.removeItem(SESS_KEY);updateNav();showPage('home');toast('Signed out.');}).catch(()=>baseLogout());
  }else{baseLogout();}
}
function logout(){doSignOut();}

init();
</script>
</body>
</html>
